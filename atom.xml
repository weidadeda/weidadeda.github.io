<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://weidadeda.github.io</id>
    <title>å¤§ä¼Ÿçš„åšå®¢</title>
    <updated>2023-05-30T10:39:56.640Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://weidadeda.github.io"/>
    <link rel="self" href="https://weidadeda.github.io/atom.xml"/>
    <subtitle>æ¸©æ•…è€ŒçŸ¥æ–°</subtitle>
    <logo>https://weidadeda.github.io/images/avatar.png</logo>
    <icon>https://weidadeda.github.io/favicon.ico</icon>
    <rights>All rights reserved 2023, å¤§ä¼Ÿçš„åšå®¢</rights>
    <entry>
        <title type="html"><![CDATA[æˆ‘ä»¬æ˜¯å¦‚ä½•ä»é›¶åˆ°ä¸€æ­å»ºç›´æ’­å°ç¨‹åºçš„]]></title>
        <id>https://weidadeda.github.io/post/wo-men-shi-ru-he-cong-ling-dao-yi-da-jian-zhi-bo-xiao-cheng-xu-de</id>
        <link href="https://weidadeda.github.io/post/wo-men-shi-ru-he-cong-ling-dao-yi-da-jian-zhi-bo-xiao-cheng-xu-de">
        </link>
        <updated>2022-12-16T05:14:05.000Z</updated>
        <content type="html"><![CDATA[<h3 id="ä¸€-èƒŒæ™¯">ä¸€ã€èƒŒæ™¯</h3>
<p>æˆ‘ä»¬çš„ç›´æ’­æŠ€æœ¯æ˜¯ä½¿ç”¨çš„zegoçš„sdkï¼Œå…¶å®æˆ‘ä»¬å’Œzegoå¯¹äºå°ç¨‹åºç›´æ’­åœºæ™¯æ˜¯å…±åŒæˆé•¿çš„ï¼Œæˆ‘ä»¬å¸®ä»–ä»¬è§£å†³äº†å¾ˆå¤šé—®é¢˜ï¼Œå‘ç°äº†å¾ˆå¤šé—®é¢˜ï¼Œæå‡ºäº†å¾ˆå¤šé—®é¢˜ï¼ŒåŒæ ·ä»–ä»¬ä¹Ÿå¸®æˆ‘ä»¬è§£å†³äº†å¾ˆå¤šé—®é¢˜ä¸æä¾›äº†å¾ˆå¤šæ–¹æ¡ˆï¼Œå› ä¸ºå°ç¨‹åºæ¨æ‹‰å¤šè·¯æµæ¯”è¾ƒå¤æ‚ï¼ŒåŠ ä¸Šæ²¡æœ‰å¤ªå¤šå¯å‚è€ƒçš„æ–‡ç« ï¼Œæ‰€ä»¥æ•´ç†å‡ºæ¥åˆ†äº«ç»™å¤§å®¶ã€‚</p>
<h3 id="äºŒ-é¡¹ç›®ä»‹ç»">äºŒã€é¡¹ç›®ä»‹ç»</h3>
<p>æˆ‘ä»¬çš„é¡¹ç›®æ˜¯åŸºäºreact-hooks + redux+ ts + Taro + Taro-UIæ­å»ºçš„ï¼Œæ˜¯ä¸€æ¬¾è§†é¢‘ç›¸äº²ç±»çš„å¾®ä¿¡å°ç¨‹åºã€‚</p>
<h3 id="ä¸‰-æŠ€æœ¯æ¶æ„">ä¸‰ã€æŠ€æœ¯æ¶æ„</h3>
<h4 id="æŠ€æœ¯åŸºç¡€">æŠ€æœ¯åŸºç¡€</h4>
<ul>
<li>webpackçš„é…ç½®ï¼ˆæ˜ å®¢è„šæ‰‹æ¶è‡ªå¸¦ï¼‰</li>
<li>æ ·å¼ä½¿ç”¨scss</li>
<li>Typescriptçš„é…ç½®</li>
<li>é¡¹ç›®çš„è·¯ç”±çš„è®¾è®¡å’Œé…ç½®</li>
<li>é¡¹ç›®ç›®å½•ç»“æ„çš„è®¾è®¡å’Œé…ç½®</li>
<li>é¡¹ç›®é€šç”¨çš„ç»„ä»¶å°è£…</li>
<li>é¡¹ç›®çš„åˆ†åŒ…å¤„ç†</li>
<li>é’ˆå¯¹ç”Ÿäº§ç¯å¢ƒåšçš„åŒ…ä½“ç§¯åˆ†æ</li>
<li>eslintåŠ prettieræ­é…ä½¿ç”¨ï¼Œè§£å†³æ¯ä¸ªäººç¼–ç æ–¹å¼ä¸åŒå¯¼è‡´çš„å†²çªï¼Œå¹¶ä¸”è®¾ç½®ä¿å­˜æ—¶è‡ªåŠ¨æ ¼å¼åŒ–<br>
<img src="https://weidadeda.github.io/post-images/1685423899209.jpg" alt="" loading="lazy"></li>
</ul>
<h4 id="å¼€å‘æµç¨‹">å¼€å‘æµç¨‹</h4>
<h5 id="é€šè¿‡dotenvè‡ªå®šä¹‰ik_envé€šè¿‡envæ–‡ä»¶å®šä¹‰æ¥åŒºåˆ†è¯¥ä½¿ç”¨ä¸åŒç¯å¢ƒçš„å„ç§å˜é‡å¦‚ä¸‹">é€šè¿‡dotEnvè‡ªå®šä¹‰IK_ENVï¼Œé€šè¿‡.envæ–‡ä»¶å®šä¹‰ï¼Œæ¥åŒºåˆ†è¯¥ä½¿ç”¨ä¸åŒç¯å¢ƒçš„å„ç§å˜é‡ï¼Œå¦‚ä¸‹ï¼š</h5>
<p><img src="https://weidadeda.github.io/post-images/1685425793342.png" alt="" loading="lazy"><br>
<img src="https://weidadeda.github.io/post-images/1685425801928.png" alt="" loading="lazy"><br>
<img src="https://weidadeda.github.io/post-images/1685425938717.png" alt="" loading="lazy"><br>
<img src="https://weidadeda.github.io/post-images/1685426039298.png" alt="" loading="lazy"></p>
<h5 id="git-commitæ ¡éªŒè§„èŒƒä»£ç æäº¤">git commitæ ¡éªŒï¼Œè§„èŒƒä»£ç æäº¤</h5>
<pre><code>&quot;gitHooks&quot;: {
  &quot;pre-commit&quot;: &quot;lint-staged&quot;,
  &quot;commit-msg&quot;: &quot;node .bin/verify-commit-msg.js&quot;
},
&quot;lint-staged&quot;: {
  &quot;*.{ts, tsx}&quot;: [
    &quot;prettier --config --write&quot;
  ]
},
</code></pre>
<pre><code class="language-js">const chalk = require('chalk')
const msgPath = process.env.GIT_PARAMS
const msg = require('fs').readFileSync(msgPath, 'utf-8').trim()

const commitRE =
  /^(revert: )?(feat|fix|polish|docs|style|refactor|perf|test|workflow|ci|chore|types|build|tool|comment|rewrite|Merge|Revert)(\(.+\))?: .{1,50}|Merge|Revert /

if (!commitRE.test(msg)) {
  console.error(
    `  ${chalk.bgRed.white(' ERROR ')} ${chalk.red(`invalid commit message format.`)}\n\n` +
      chalk.red(`  Proper commit message format is required for automated changelog generation. Examples:\n\n`) +
      `    ${chalk.green(`feat: add 'comments' option`)}\n` +
      `    ${chalk.green(`fix: handle events on blur (close #28)`)}\n\n` +
      chalk.red(`  You can also use ${chalk.cyan(`npm run commit`)} to interactively generate a commit message.\n`)
  )
  process.exit(1)
}
</code></pre>
<p>å¦‚æœä¸æŒ‰ç…§è§„åˆ™æäº¤åˆ™ä¼šæäº¤å¤±è´¥å¹¶æç¤ºè¯¥å¦‚ä½•æäº¤<br>
<img src="https://weidadeda.github.io/post-images/1685426148683.png" alt="" loading="lazy"><br>
ä¹Ÿå¯ä»¥è¿è¡Œnpm run commit</p>
<pre><code class="language-js">&quot;commit&quot;: &quot;git-cz&quot;
</code></pre>
<p><img src="https://weidadeda.github.io/post-images/1685426213792.png" alt="" loading="lazy"><br>
<img src="https://weidadeda.github.io/post-images/1685426219051.png" alt="" loading="lazy"></p>
<h5 id="tså†™æ³•å®šä¹‰ä¸€ä¸ªç½‘ç»œè¯·æ±‚èƒ½ç»™ä¸¥æ ¼è¦æ±‚è¯·æ±‚å‚æ•°ä¸è¿”å›å€¼é˜²æ­¢å¼€å‘äººå‘˜ä»£ç é”™è¯¯">tså†™æ³•å®šä¹‰ä¸€ä¸ªç½‘ç»œè¯·æ±‚ï¼Œèƒ½ç»™ä¸¥æ ¼è¦æ±‚è¯·æ±‚å‚æ•°ä¸è¿”å›å€¼ï¼Œé˜²æ­¢å¼€å‘äººå‘˜ä»£ç é”™è¯¯</h5>
<details>
<summary>api.ts</summary>
<pre><code class="language-ts">import { serviceFetch } from 'config/api-roots'
export interface resData&lt;T = any&gt; {
  data: T
  error_msg: string
  dm_error: number
}
/**
 * è·å–å…³æ³¨çŠ¶æ€æ¥å£è¿”å›å€¼
 */
interface getFollowStatusApiRes {
  /**
   * å…³æ³¨çŠ¶æ€,0ä¸ºæœªå…³æ³¨,1å·²å…³æ³¨
   */
  follow_status: number
  /**
   * å…³æ³¨å…¬ä¼—å·çŠ¶æ€ï¼Œ0ä¸ºæœªå…³æ³¨ï¼Œ1ä¸ºå·²å…³æ³¨
   */
  subscribe_status: number
  /**
   * æ˜¯å¦å±•ç¤ºå…³æ³¨æŒ‰é’®,1å±•ç¤º,0ä¸å±•ç¤º
   */
  is_show_follow: number
  /**
   * å¤´åƒæ¡†
   */
  resource_frame_img: string
}
/**
 * è·å–å…³æ³¨çŠ¶æ€æ¥å£
 */
export const getFollowStatusApi: (params: { target_uid?: number }) =&gt; resData&lt;getFollowStatusApiRes&gt; = serviceFetch({
  url: '/api/relation/follow/get_follow_status',
  method: 'POST',
  errorTips: true
})
</code></pre>
</details>
<p>å¦‚æœå†™é”™äº†ï¼Œåˆ™ä¼šæç¤ºï¼Œå–è¿”å›å­—æ®µä¹Ÿèƒ½ç²¾å‡†æç¤º</p>
<p><img src="https://weidadeda.github.io/post-images/1685426335606.png" alt="" loading="lazy"><br>
<img src="https://weidadeda.github.io/post-images/1685426342517.png" alt="" loading="lazy"><br>
<img src="https://weidadeda.github.io/post-images/1685426348461.png" alt="" loading="lazy"></p>
<h5 id="æ„å»ºä¸Šçº¿æ—¶çš„å¤„ç†">æ„å»ºä¸Šçº¿æ—¶çš„å¤„ç†</h5>
<p>ä¼ ç»Ÿçš„ä¸Šçº¿äººå·¥æˆæœ¬å¤ªé«˜ï¼Œå› ä¸ºéœ€è¦äººä¸ºå¤„ç†çš„äº‹æƒ…å¤ªå¤šï¼Œå¯¹æ­¤æˆ‘ä»¬å†™äº†ä¸€ä¸ªè„šæœ¬æ¥å°†è¿™ä¸€ç³»åˆ—æµç¨‹ä¸²èµ·æ¥ã€‚<br>
1ã€è‡ªåŠ¨å‡çº§é¡¹ç›®ç‰ˆæœ¬å·<br>
2ã€è‡ªåŠ¨ç”Ÿæˆchanglog<br>
3ã€è‡ªåŠ¨å°†æ‰“åŒ…å‡ºæ¥çš„åŒ…ä¸Šä¼ è‡³å¾®ä¿¡å°ç¨‹åºåå°<br>
4ã€è‡ªåŠ¨å‘é€åˆå¹¶è¯·æ±‚<br>
5ã€è‡ªåŠ¨å‘é€é’‰é’‰é€šçŸ¥ï¼ˆæ„å»ºäººï¼Œæ„å»ºç¯å¢ƒï¼Œæ„å»ºåˆ†æ”¯ï¼Œæ„å»ºç‰ˆæœ¬ï¼‰<br>
6ã€å› ä¸ºå¾®ä¿¡å®¡æ ¸æœ‰é™åˆ¶ï¼Œæœ‰äº›åŠŸèƒ½åœ¨æäº¤å®¡æ ¸æ—¶ä¸èƒ½å±•ç¤ºå‡ºæ¥ï¼Œæ‰€ä»¥éœ€è¦è®©äº§å“/è¿è¥äººå‘˜æ›´æ”¹ä¸æ£€æŸ¥å®¡æ ¸ç‰ˆæœ¬å·ï¼Œé€šè¿‡é’‰é’‰@åŠŸèƒ½å®ç°</p>
<details>
<summary>buildè„šæœ¬</summary>
<pre><code class="language-js">const ora = require('ora')
const { exec, execSync } = require('child_process')
const inquirer = require('inquirer')
let colors = require('colors')
const ChatBot = require('dingtalk-robot-sender')
const spinner = ora('æ­£åœ¨æ„å»º...')
const ci = require('miniprogram-ci')
const robot = new ChatBot({
  webhook:
    'https://oapi.dingtalk.com/robot/send?access_token=xxx'
})
spinner.color = 'yellow'
colors.setTheme({
  silly: 'rainbow',
  input: 'grey',
  verbose: 'cyan',
  prompt: 'grey',
  info: 'green',
  data: 'grey',
  help: 'cyan',
  warn: 'yellow',
  debug: 'blue',
  error: 'red'
})
const verMap = {
  'è¡¥ä¸ç‰ˆæœ¬é€’å¢0.0.1': 'patch',
  'å°ç‰ˆæœ¬é€’å¢0.1.0': 'minor',
  'å¤§ç‰ˆæœ¬é€’å¢1.0.0': 'major'
}
let selectVersion = ''
const openUrl = 'https://code.inke.cn/xxx'
/**
 * è·å–æäº¤äºº
 */
const lastCommitAuthor = execSync(`git config user.name`).toString().trim()
/**
 * è·å–å½“å‰åˆ†æ”¯
 */
const currentBranch = execSync(`git symbolic-ref --short -q HEAD`).toString().trim()
/**
 * git diff
 */
function gitDiff(option, tips) {
  const diff = execSync(`git diff ${option}`).toString().trim() // è·å–æ–°å¢æ–‡ä»¶
  const arrDiff = diff.split('\n').filter(Boolean)
  if (arrDiff.length) {
    console.log(
      `ğŸ“› å½“å‰åˆ†æ”¯ ${currentBranch} æœ‰${tips}ï¼Œè¯·æäº¤åå†æ‰§è¡Œè¯¥å‘½ä»¤`.error,
      `ğŸ“¦ ${tips}æ–‡ä»¶å¦‚ä¸‹: ${arrDiff}`.error
    )
    process.exit(0)
  }
}
/**
 * æ£€æŸ¥å½“å‰åˆ†æ”¯æ˜¯å¦è¿˜æœ‰æœªæäº¤ä»£ç 
 */
function checkUnCommitedCode() {
  gitDiff('--name-only', 'æœªæäº¤çš„ä»£ç ') // diff æ˜¯å¦æœ‰æ–°å¢æ–‡ä»¶
  gitDiff('--name-only --cached', 'æœªæäº¤çš„ä»£ç ') // diff å·²æ·»åŠ åˆ°ç¼“å­˜åŒºçš„æ–‡ä»¶
}
async function buildEnv() {
  checkUnCommitedCode()
  const { buildEnv } = await inquirer.prompt([
    {
      type: 'list',
      name: 'buildEnv',
      message: 'è¯·é€‰æ‹©æ„å»ºç¯å¢ƒ',
      choices: ['test', 'beta', 'online']
    }
  ])
  if (buildEnv === 'online') {
    try {
      execSync(`bash .bin/check.sh`)
    } catch (e) {
      console.log(`æœ‰æœªåˆå¹¶çš„è¯·æ±‚ï¼Œè¯·å…ˆå®Œæˆåˆå¹¶è¯·æ±‚`.red, e.status)
      robot.text('å­˜åœ¨æœªåˆå¹¶çš„è¯·æ±‚ï¼Œæ‰“åŒ…å¤±è´¥ï¼Œè¯·å…ˆåˆå¹¶', {
        atMobiles: ['18310536322'],
        isAtAll: false
      })
      process.exit(1)
    }
    const { version } = await inquirer.prompt({
      type: 'list',
      name: 'version',
      default: 'è¡¥ä¸ç‰ˆæœ¬é€’å¢0.0.1',
      message: 'é€‰æ‹©æ„å»ºç‰ˆæœ¬ç±»å‹',
      choices: ['none', 'è¡¥ä¸ç‰ˆæœ¬é€’å¢0.0.1', 'å°ç‰ˆæœ¬é€’å¢0.1.0', 'å¤§ç‰ˆæœ¬é€’å¢1.0.0']
    })
    selectVersion = version
    if (version !== 'none') {
      try {
        execSync(`npm version ${verMap[version]} --no-git-tag`)
        console.log(`æ›´æ–°ç‰ˆæœ¬å·å®Œæˆ`.info)
        execSync('npm run changelog')
        console.log(`ç”Ÿæˆchangelogå®Œæˆ`.info)
      } catch (error) {
        console.log(`æ›´æ–°ç‰ˆæœ¬å·å¤±è´¥${error}`.error)
      }
    }
  }
  spinner.start()
  exec(`npm run build:weapp:${buildEnv}`, (e, sdtout, sdterr) =&gt; {
    const { version: currentVersion } = require('../package.json')
    let noMergeDingContent = `
              æ‰“åŒ…å®Œæˆâœ…
              æ„å»ºäºº: ${lastCommitAuthor}
              æ„å»ºç‰ˆæœ¬: ${currentVersion}
              æ„å»ºç¯å¢ƒ: ${buildEnv}
              æ„å»ºåˆ†æ”¯: ${currentBranch}
              è¯¥ç‰ˆæœ¬å·²è‡ªåŠ¨ä¸Šä¼ ï¼Œè¯·åœ¨å°ç¨‹åºåå°é€‰ä¸ºä½“éªŒç‰ˆ
            `
    let hasMergeDingContent = `
              æ‰“åŒ…å®Œæˆâœ…
              æ„å»ºäºº: ${lastCommitAuthor}
              æ„å»ºç‰ˆæœ¬: ${currentVersion}
              æ„å»ºç¯å¢ƒ: ${buildEnv}
              æ„å»ºåˆ†æ”¯: ${currentBranch}
              åˆå¹¶åœ°å€: ${openUrl}
              åˆå¹¶è¯·æ±‚å·²åˆ›å»ºï¼Œè¾›è‹¦å¤§ä½¬åˆå¹¶ï½
            `
    spinner.stop()
    if (e) {
      console.log(`æ„å»ºå¤±è´¥ï¼š${e}`.error)
    } else {
      console.log(sdtout)
      console.log(sdterr)
      let content = noMergeDingContent
      let at = {}
      if (buildEnv === 'online') {
        try {
          if (selectVersion !== 'none') {
            content = hasMergeDingContent
            at = {
              atMobiles: ['18310536322'],
              isAtAll: false
            }
          } else {
            content = noMergeDingContent
          }
          if (selectVersion !== 'none') {
            try {
              execSync(`bash .bin/mr.sh`)
              console.log(`åˆ›å»ºåˆå¹¶è¯·æ±‚å®Œæˆ`.info)
            } catch (e) {
              console.log(`åˆ›å»ºåˆå¹¶è¯·æ±‚å¤±è´¥`.red, e.status)
            }
          }
        } catch (error) {
          if (selectVersion !== 'none') {
            console.log(`åˆ›å»ºåˆå¹¶è¯·æ±‚å¤±è´¥${error}`.error)
          }
        }
      }
      robot.text(content, at).then(async res =&gt; {
        if (!res.data.errcode) {
          console.log(`é’‰é’‰é€šçŸ¥å®Œæˆ`.info)
          const project = new ci.Project({
            appid: 'xxxx',
            type: 'miniProgram',
            projectPath: 'build/weapp',
            privateKeyPath: '.bin/private.xxxx.key',
            ignores: ['node_modules/**/*']
          })
          const uploadResult = await ci.upload({
            project,
            version: currentVersion,
            desc: `æ„å»ºäººï¼š${lastCommitAuthor}`,
            setting: {
              es6: false,
              minifyJS: true,
              minifyWXML: true
            },
            onProgressUpdate: console.log
          })
          console.log('è‡ªåŠ¨ä¸Šä¼ å·²å®Œæˆ'.green)
        } else {
          console.log(`é’‰é’‰é€šçŸ¥å¤±è´¥${res.data.errmsg}`.error)
        }
      })
    }
  })
}
buildEnv()
</code></pre>
</details>
<details>
<summary>mr.sh</summary>
<pre><code class="language-sh">#!/usr/bin

# æäº¤MR

PROJECT_ID=xxx
PRIVATE_TOKEN=&quot;xxx&quot;
# CURRENT_BRANCH=`git symbolic-ref --short -q HEAD`
CURRENT_BRANCH=`git rev-parse HEAD`

echo ${CURRENT_BRANCH}
TIME=$(date &quot;+%Y%m%d%H%M%S&quot;)
NEW_BRANCH=&quot;TaroBuild-${TIME}&quot;
GITLAB_HOST=&quot;https://code.inke.cn&quot;

# åˆ›å»ºåˆ†æ”¯
curl --request POST --header &quot;PRIVATE-TOKEN: ${PRIVATE_TOKEN}&quot; &quot;${GITLAB_HOST}/api/v4/projects/${PROJECT_ID}/repository/branches?branch=${NEW_BRANCH}&amp;ref=${CURRENT_BRANCH}&quot;
echo &quot;\næäº¤MR: æ·»åŠ ã€Œ${NEW_BRANCH}ã€åˆ†æ”¯å®Œæˆï¼&quot;

# MR data
DATA=&quot;{\&quot;id\&quot;:\&quot;${PROJECT_ID}\&quot;,\&quot;source_branch\&quot;:\&quot;${NEW_BRANCH}\&quot;,\&quot;target_branch\&quot;:\&quot;master\&quot;,\&quot;private_token\&quot;:\&quot;${PRIVATE_TOKEN}\&quot;,\&quot;title\&quot;:\&quot;Script Build Auto Submit Merge Resquest\&quot;,\&quot;description\&quot;:\&quot;æ„å»ºè‡ªåŠ¨æäº¤merge request\&quot;}&quot;
# åˆ›å»ºMR
curl -X POST -d &quot;${DATA}&quot; -H &quot;Content-Type: application/json, PRIVATE-TOKEN: ${PRIVATE_TOKEN}&quot; &quot;${GITLAB_HOST}/api/v4/projects/${PROJECT_ID}/merge_requests&quot;
echo &quot;\næäº¤MR: æäº¤MRå®Œæˆï¼&quot;
</code></pre>
</details>
<details>
<summary>check.sh</summary>
<pre><code class="language-sh">#!/usr/bin

PRIVATE_TOKEN=&quot;xxx&quot;
GITLAB_HOST=&quot;https://code.gitlab.cn&quot;
PROJECT_ID=xxx

MR_LIST=`curl -X GET --header &quot;PRIVATE-TOKEN: ${PRIVATE_TOKEN}&quot; &quot;${GITLAB_HOST}/api/v4/projects/${PROJECT_ID}/merge_requests?state=opened&quot;`
if [ ${MR_LIST} != '[]' ];then
  echo 'å­˜åœ¨æœªåˆå¹¶çš„è¯·æ±‚'
  exit 1
else
  echo 'ç»§ç»­æ‰§è¡Œ'
fi
</code></pre>
</details>
<p><img src="https://weidadeda.github.io/post-images/1685428233851.png" alt="" loading="lazy"><br>
è‡ªåŠ¨ç”Ÿæˆçš„changelogï¼Œæ¯æœŸåšäº†ä»€ä¹ˆä¸€ç›®äº†ç„¶</p>
<p><img src="https://weidadeda.github.io/post-images/1685428511981.png" alt="" loading="lazy"><br>
é€šè¿‡è„šæœ¬è‡ªåŠ¨ä¸Šä¼ çš„æ„å»ºåŒ…</p>
<p>æˆ‘ä»¬å’Œäº§å“åŒå­¦ä¸æµ‹è¯•åŒå­¦è¾¾æˆäº†ä¸€ä¸ªçº¦å®šçš„æ¨¡å¼ï¼Œæ¯æ¬¡ä¸Šçº¿ä¸æµ‹è¯•å¼€å‘åªç®¡è¿è¡Œå‘½ä»¤æ‰“å‡ºæ¥å¹¶è‡ªåŠ¨ä¸Šä¼ è‡³å°ç¨‹åºåå°ï¼Œå…¶ä»–çš„æ¯”å¦‚ä½“éªŒç‰ˆå°ç¨‹åºçš„åˆ‡æ¢ã€å°ç¨‹åºçš„æå®¡ã€å®¡æ ¸é€šè¿‡åå°ç¨‹åºçš„åˆ†æ‰¹å‘å¸ƒä¸å…¨é‡å‘å¸ƒç­‰èƒ½åœ¨åå°æ“ä½œçš„äº‹æƒ…å…¨éƒ½ç”±å¥¹ä»¬æ ¹æ®è‡ªå·±çš„éœ€è¦å»åšã€‚<br>
è¿™æ ·æˆ‘ä»¬çš„å¼€å‘åŒå­¦åªéœ€è¦è¿è¡Œä¸€æ¡<code>yarn build</code>å‘½ä»¤ï¼Œå…¶ä»–çš„ä»€ä¹ˆéƒ½ä¸ç”¨ç®¡äº†ï¼Œå¤§å¤§çš„æé«˜äº†æ•ˆç‡ã€‚ä¸ç„¶åˆ†å·¥å°±ä¼šä¸æ˜ç¡®ï¼Œå…¨éƒ½å¾—ç”±å¼€å‘åŒå­¦å»æ§åˆ¶ã€‚</p>
<p><img src="https://weidadeda.github.io/post-images/1685436119226.png" alt="" loading="lazy"><br>
<img src="https://weidadeda.github.io/post-images/1685436124184.png" alt="" loading="lazy"><br>
<img src="https://weidadeda.github.io/post-images/1685436128819.png" alt="" loading="lazy"><br>
å¦‚æœé€‰æ‹©çº¿ä¸Šç¯å¢ƒï¼Œåˆ™ä¼šè¯¢é—®è¦æ„å»ºçš„ç‰ˆæœ¬ï¼Œé»˜è®¤é€’å¢0.0.1</p>
<h4 id="é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ">é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ</h4>
<p>å› ä¸ºå¾®ä¿¡å°ç¨‹åºæœ‰ç€ä¸¥æ ¼çš„åŒ…ä½“ç§¯é™åˆ¶ï¼Œæ‰“åŒ…ä¸Šä¼ æ—¶ä¸»åŒ…ä½“ç§¯ä¸èƒ½è¶…è¿‡2Mï¼Œå¼€å‘ç¯å¢ƒé¢„è§ˆå’ŒçœŸæœºè°ƒè¯•æ—¶ä¸»åŒ…ä½“ç§¯ä¸èƒ½è¶…è¿‡4Mï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¯¹åŒ…ä½“ç§¯åšä¸€äº›å¤„ç†ï¼Œå¯¹æ­¤æˆ‘ä»¬åšäº†ä»¥ä¸‹æ“ä½œï¼š<br>
1ã€åˆ†åŒ…ï¼ˆä¸»åŒ…æ”¾é¦–é¡µçš„ä¸šåŠ¡ï¼Œå…¶ä»–çš„éƒ½æ”¾åˆ°åˆ†åŒ…ä¸­ï¼Œåˆ†åŒ…å¯ä»¥åˆ†å¤šä¸ªï¼ŒæŒ‰ä¸šåŠ¡æ¨¡å—è¿›è¡Œåˆ†åŒ…ï¼Œå¤§å®¶éƒ½çŸ¥é“å°±ä¸å¤šè¯´äº†ï¼‰<br>
2ã€æ¨¡å—ä¸npmåŒ…çš„æŒ‰éœ€åŠ è½½ï¼Œæ¯”å¦‚taro-uiã€lodashç­‰<br>
3ã€å¼€å‘ç¯å¢ƒå¼€å¯ä»£ç å‹ç¼©<br>
4ã€å¦‚æœè¶…è¿‡äº†åŒ…ä½“ç§¯é™åˆ¶ï¼Œåˆ™å¼€å¯åŒ…ä½“ç§¯åˆ†ææ’ä»¶ï¼Œçœ‹çœ‹å“ªäº›åœ°æ–¹è¿˜éœ€è¦ä¼˜åŒ–ï¼Œå¦‚ä¸‹å›¾<br>
<img src="https://weidadeda.github.io/post-images/1685436207249.png" alt="" loading="lazy"></p>
<h3 id="å››-ä¸šåŠ¡æ¶æ„">å››ã€ä¸šåŠ¡æ¶æ„</h3>
<p>æˆ‘ä»¬ä¸šåŠ¡ä¸­å¯¹äºå…¶ä»–å°ç¨‹åºéœ€è¦è¯´çš„ä¸»è¦è¿˜æ˜¯éŸ³è§†é¢‘ä¸IMï¼Œå…¶ä»–çš„æˆ‘ä¸ªäººè§‰å¾—å€’æ˜¯æ²¡å¿…è¦è¯¦ç»†è¯´ï¼Œä½†æœ‰ä¸€äº›æœ‰ç”¨çš„å’Œä¸€äº›å‘ç‚¹è¿˜æ˜¯å¯ä»¥åˆ†äº«ç»™å¤§å®¶ã€‚</p>
<h4 id="å°ç¨‹åºç›´æ’­">å°ç¨‹åºç›´æ’­</h4>
<p><img src="https://weidadeda.github.io/post-images/1685436315130.jpg" alt="" loading="lazy"><br>
æˆ¿é—´å†…éŸ³è§†é¢‘ä¸æ¶ˆæ¯æ¶æ„<br>
<img src="https://weidadeda.github.io/post-images/1685436362392.jpg" alt="" loading="lazy"></p>
<p>#####ï¼ˆ1ï¼‰è¿›æˆ¿æµç¨‹<br>
<img src="https://weidadeda.github.io/post-images/1685436411870.jpg" alt="" loading="lazy"></p>
<ul>
<li>
<p>è¿›å…¥æˆ¿é—´ä¹‹å‰<br>
å°è£…æˆå…¬ç”¨æ–¹æ³•ï¼Œé€šè¿‡ç‚¹å‡»é¦–é¡µå¡ç‰‡è°ƒç”¨ï¼Œç‚¹å‡»åˆ«äººåˆ†äº«çš„å°ç¨‹åºå¡ç‰‡è°ƒç”¨ï¼Œç‚¹å‡»åˆ«äººèµ„æ–™é¡µç›´æ’­ä¸­çŠ¶æ€å¤´åƒè°ƒç”¨ï¼Œå¤§å…ä¸­åŒæ„é‚€è¯·æ—¶è°ƒç”¨ï¼Œç‚¹å‡»æˆ¿é—´é£˜å±æ—¶è°ƒç”¨ç­‰ç­‰ã€‚<br>
1ã€å…ˆè°ƒç”¨æœåŠ¡ç«¯åŠ å…¥æˆ¿é—´æ¥å£<br>
2ã€åˆ¤æ–­è‡ªå·±æ˜¯å¦åœ¨æ¨æµï¼Œæ¨æµä¸­ä¸å…è®¸è·³è½¬<br>
3ã€åˆ¤æ–­è¦è¿›å…¥çš„æˆ¿é—´ç±»å‹<br>
4ã€å®ç°è·³è½¬å¯¹åº”æˆ¿é—´å¹¶ä¸”æŠŠæœåŠ¡ç«¯è¿”å›çš„æˆ¿é—´ä¿¡æ¯ä¸æ˜¯å¦é‚€è¯·ç­‰å‚æ•°å¸¦åˆ°æˆ¿é—´ä¸­</p>
</li>
<li>
<p>è¿›å…¥æˆ¿é—´ä¹‹å<br>
ä»¥ä¸‹æµä¿¡æ¯æ˜¯æŒ‡æµidä¸æµçš„é™„åŠ ä¿¡æ¯ã€‚</p>
<p>å°†æœåŠ¡ç«¯è¿”å›çš„live_idä½œä¸ºæˆ¿é—´å·ï¼ŒåŠ å…¥zegoæˆ¿é—´ã€åŠ å…¥èäº‘æˆ¿é—´ï¼Œå°†æˆ¿é—´ä¸­ä½¿ç”¨åˆ°çš„ä¿¡æ¯ä¸ç”¨æˆ·è§’è‰²ç­‰å…¨éƒ½æ”¾åœ¨reduxä¸­ï¼Œå¯ä¾›å„ä¸ªç»„ä»¶ä½¿ç”¨ã€‚</p>
<p>å¯¹äºæ¨æµç«¯ï¼Œéœ€è¦å°†æ¨æµäººçš„ä¿¡æ¯æ”¾åˆ°æµçš„é¢å¤–ä¿¡æ¯ä¸­ï¼Œä½†zegoåªæ”¯æŒä¼ å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æŠŠè¦ä¼ çš„å‚æ•°åšä¸€ä¸‹å­—ç¬¦ä¸²å¤„ç†</p>
<p>å°†æµç›¸å…³çš„ä¿¡æ¯å…¨éƒ½ç»„è£…åœ¨ä¸€èµ·ï¼Œæ¯”å¦‚éº¦ä½ä¿¡æ¯ã€æµidã€éº¦å…‹é£é™éŸ³çŠ¶æ€ã€æ˜¯å¦æ˜¯å…è´¹ä¸Šéº¦ã€ç”¨æˆ·æ€§åˆ«ç­‰ï¼Œé€šè¿‡ä¼ å‚æ”¾åˆ°æ¯ä¸ªæˆ‘ä»¬è‡ªå®šä¹‰çš„æµç»„ä»¶ä¸­</p>
<p>æ”¶åˆ°æ–­çº¿é‡è¿æ—¶ï¼Œéœ€è¦å…ˆåœæ­¢æ¨æµï¼Œç„¶åé‡æ–°å¼€å§‹æ¨æµï¼Œé‡è¯•ä¸‰æ¬¡ä¸æˆåŠŸï¼Œåˆ™æç¤ºã€‚</p>
<p>ç‚¹å‡»é™éŸ³æ—¶ï¼Œéœ€è¦ç»™è¦é™éŸ³çš„äººå‘é€æ¶ˆæ¯ï¼Œç„¶åç›®æ ‡äººæ”¶åˆ°æ¶ˆæ¯æ—¶å»å°†è‡ªå·±çš„éº¦å…‹é£å…³æ‰ï¼Œå¹¶ä¸”æ›´æ–°è‡ªå·±çš„æµä¿¡æ¯</p>
<p>ä¸Šéº¦ä¹‹å‰æ ¡éªŒæ˜¯å¦å¼€å¯éŸ³è§†é¢‘æƒé™</p>
<p>æ¥æ”¶åˆ°æµå˜åŒ–ä¹‹åå¯¹éº¦ä½ä¸Šçš„æµè¿›è¡Œå¯¹åº”çš„æ–°å¢å’Œåˆ é™¤</p>
<p>æ”¶åˆ°zegoæˆ¿é—´æ–­å¼€è¿æ¥çŠ¶æ€æ—¶ï¼Œéœ€è¦å¯¹æ¯”æ–­å¼€çš„æˆ¿é—´ä¸å½“å‰æˆ¿é—´æ˜¯å¦ä¸€è‡´ï¼ˆå‘ç‚¹ï¼‰</p>
</li>
<li>
<p>å¦‚ä½•å†³å®šæ˜¯æ¨æµè¿˜æ˜¯æ‹‰æµ<br>
æˆ‘ä»¬çš„ä¸šåŠ¡æœ€å¤šèƒ½æœ‰ä¸ƒè·¯æµï¼Œä½ç½®ä¿¡æ¯æ˜¯æ ¹æ®æœåŠ¡ç«¯è¿”å›çš„ï¼Œæ˜¯æ ¹æ®èº«ä»½æ¥åˆ¤æ–­æ˜¯å¦æ¨æµï¼Œæˆ‘ä»¬ç›®å‰æœ‰å››ç§ï¼Œ<br>
1æˆ¿ä¸»ï¼ˆä¸€ç›´æ¨æµï¼‰ã€2éº¦ä¸Šå˜‰å®¾ï¼ˆæ¨æµï¼Œä¸‹éº¦æ—¶åœæ­¢æ¨æµå¹¶åˆ‡æ¢èº«ä»½ä¸º3ï¼‰ã€3éº¦ä¸‹è§‚ä¼—ï¼ˆæ‹‰æµï¼‰ã€4éšèº«äººç£å¯¼ï¼ˆæ‹‰æµï¼‰<br>
æ¯ä¸€ä¸ªéº¦ä½éƒ½æ˜¯æ”¾çš„æˆ‘ä»¬è‡ªå·±å°è£…çš„ç»„ä»¶ï¼Œç»„ä»¶å†…æ ¹æ®ä¼ å…¥çš„èº«ä»½è‡ªå·±åˆ¤æ–­æ˜¾ç¤ºæ¨æµç»„ä»¶å’Œæ‹‰æµç»„ä»¶</p>
<p>æ¨æµç»„ä»¶æ˜¯ç”¨çš„å°ç¨‹åºè‡ªå¸¦çš„<live-pusher/><a href="https://developers.weixin.qq.com/miniprogram/dev/component/live-pusher.html">ç»„ä»¶</a>ï¼Œæ‹‰æµç»„ä»¶æ˜¯ç”¨çš„å°ç¨‹åºè‡ªå¸¦çš„<live-player/>ç»„ä»¶ï¼Œå¼€é€šéœ€è¦ç±»ç›®å®¡æ ¸</p>
</li>
<li>
<p>é€€å‡ºæˆ¿é—´<br>
å°†æˆ¿é—´ç›¸å…³çš„reduxå…¨éƒ¨é‡æ–°åˆå§‹åŒ–<br>
æ¸…ç©ºæ‰€æœ‰å®šæ—¶å™¨<br>
è°ƒç”¨æœåŠ¡ç«¯é€€å‡ºæˆ¿é—´æ¥å£<br>
é”€æ¯æ‰€æœ‰ç›‘å¬äº‹ä»¶<br>
é€€å‡ºèäº‘æˆ¿é—´ä¸zegoæˆ¿é—´</p>
</li>
</ul>
<h5 id="2å¼‚å¸¸åœºæ™¯å¤„ç†">ï¼ˆ2ï¼‰å¼‚å¸¸åœºæ™¯å¤„ç†</h5>
<p>å…³äºåˆ‡åå°çš„æƒ…å†µï¼Œæˆ‘ä»¬æ•´ç†äº†å¦‚ä¸‹è¡¨ç°<br>
<img src="https://weidadeda.github.io/post-images/1685436885815.png" alt="" loading="lazy"></p>
<ul>
<li>
<p>æ¨æµæƒ…å†µä¸‹ï¼Œå½“åˆ‡åå°è¶…è¿‡90sï¼Œzegoçš„æœåŠ¡ç«¯ï¼ˆå¿ƒè·³æ—¶é—´90sï¼‰ä¼šå°†æµåˆ é™¤ï¼Œå›åˆ°å‰å°çš„æ—¶å€™æˆ‘ä»¬éœ€è¦æš‚åœæ¨æµåŒæ—¶è°ƒç”¨å°ç¨‹åºç»„ä»¶çš„åœæ­¢æ¨æµï¼Œç„¶åé‡æ–°zegoæ¨æµåŠ å°ç¨‹åºç»„ä»¶æ¨æµï¼Œæ³¨æ„éœ€è¦zegoå’Œæ¨æµç»„ä»¶åŒæ—¶åœæ­¢ä¸å¼€å§‹ã€‚</p>
</li>
<li>
<p>æ¨æµæƒ…å†µä¸‹ï¼Œåˆ‡åå°90så†…å›æ¥ï¼Œåˆ™ä¸éœ€è¦åšå…¶ä»–æ“ä½œï¼Œzegoä¼šè‡ªåŠ¨é‡è¿</p>
</li>
<li>
<p>æ‹‰æµæƒ…å†µä¸‹ï¼Œå¯¹äºåˆ‡åå°ä¸éœ€è¦åšä»»ä½•å¤„ç†ï¼Œç›¸å¯¹ç¨³å®šï¼Œåªè¦æœ‰æµè¿‡æ¥å°±èƒ½å±•ç¤º</p>
</li>
<li>
<p>å¦‚æœå› ä¸ºç½‘ç»œé—®é¢˜ï¼Œzegoè¿æ¥ä¸­çŠ¶æ€å’Œå·²è¿æ¥çŠ¶æ€ç›¸å·®90sä»¥ä¸Š5åˆ†é’Ÿä»¥å†…ï¼Œåˆ™éœ€è¦é‡æ–°æ‰§è¡Œä¸Šè¿°å…³æµæ¨æµï¼Œ5åˆ†é’Ÿä¸€ç›´éƒ½æ˜¯è¿æ¥ä¸­çŠ¶æ€ï¼Œzegoä¼šè‡ªåŠ¨èµ°åˆ°æ–­å¼€è¿æ¥å›æ‰ã€‚</p>
</li>
<li>
<p>å¦‚æœæˆ¿é—´å¼‚å¸¸æ–­å¼€æˆ–è€…ç½‘ç»œå¼‚å¸¸ç™»å½•è¶…æ—¶ï¼Œåˆ™éœ€è¦é‡æ–°åŠ å…¥zegoæˆ¿é—´ï¼Œç„¶ååˆ¤æ–­è‡ªå·±ä¹‹å‰æ˜¯å¦åœ¨éº¦ï¼Œåœ¨éº¦æ‰§è¡Œç”¨æˆ·é‡æ–°æ¨æµé€»è¾‘ï¼Œé‡æ¨3æ¬¡ä¾ç„¶å¤±è´¥ï¼Œåˆ™é€€å‡ºæˆ¿é—´</p>
</li>
</ul>
<h5 id="3æ€§èƒ½ä¼˜åŒ–">ï¼ˆ3ï¼‰æ€§èƒ½ä¼˜åŒ–</h5>
<ul>
<li>
<p>å¯¹äºæµï¼šå› ä¸ºæ˜¯å¤šè·¯æµï¼Œæ‰€ä»¥æ¯”è¾ƒåƒæ€§èƒ½å’Œç½‘ç»œï¼Œå¯ä»¥å°†æ¨æµç»„ä»¶çš„maxBitrateå‚æ•°è®¾ç½®çš„å°ä¸€äº›ï¼Œåˆ†è¾¨ç‡ä¹Ÿå¯ä»¥å°ä¸€äº›ï¼Œæˆ‘ä»¬è¿™è¾¹è®¾ç½®çš„æœ€å¤§ç ç‡ä¸ºä¸ƒäººé—´150ï¼Œä¸‰äººé—´300ï¼Œå®½é«˜æ¯”è®¾ç½®ä¸º3:4ï¼Œè§†é¢‘å®½é«˜ä¸º180*240ã€‚å¯èƒ½å¤§å®¶çœ‹è¿™ä¸ªå‚æ•°è§‰å¾—ä¼šç³Šï¼Œè¯·å¤§å®¶æ”¾å¿ƒï¼Œæˆ‘ä»¬ç»è¿‡å®è·µï¼Œè¿™æ ·ä¸ä¼šçœ‹ç€ç‰¹åˆ«æ¨¡ç³Šã€‚</p>
</li>
<li>
<p>å¯¹äºç½‘ç»œè¯·æ±‚ï¼šwx.requestå‘èµ·çš„è€—æ—¶è¶…è¿‡ 300ms çš„è¯·æ±‚å¹¶å‘æ•°ä¸è¶…è¿‡ 10 ä¸ªï¼Œè°ƒç”¨æ—¶éœ€è¦èŠ‚æµå¤„ç†</p>
</li>
<li>
<p>å¯¹äºèŠ‚ç‚¹æ•°ï¼šé¡µé¢å†…æ˜¾ç¤ºè¶…è¿‡1000ä¸ªèŠ‚ç‚¹ä¼šç™½å±ï¼Œéœ€è¦åˆç†å¤„ç†ï¼Œæ¯”å¦‚å¯¹äºåˆ—è¡¨ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨</p>
</li>
<li>
<p>å¯¹äºè¿ç»­é€ç¤¼åœºæ™¯ç­‰ï¼Œèƒ½å¤Ÿè¿ç»­æ”¶åˆ°æ¶ˆæ¯ä¸æ–­æ›´æ–°reduxçš„ï¼Œåˆ™å…ˆå­˜åˆ°é˜Ÿåˆ—ä¸­ï¼Œå°†æ•°æ®æ‰¹é‡ä¼ ç»™redux</p>
</li>
<li>
<p>å¯¹äºåŒæ—¶è¦æ›´æ”¹å¤šä¸ªreduxçš„namespaceä¸­å†…å®¹çš„ï¼Œå¯ä»¥ä½¿ç”¨redux-batchè¿›è¡Œæ•´åˆæ›´æ”¹ï¼Œè€Œä¸æ˜¯è°ƒç”¨å¤šæ¡</p>
</li>
<li>
<p>ä»£ç ç¼–å†™æ—¶æœ€å¥½ä½¿ç”¨usecallbackä¸usememoï¼Œå¯¹äºæ›´æ–°é¢‘ç¹çš„ï¼Œè¦ä¸¥æ ¼ä½¿ç”¨usecallbackæˆ–è€…shouldComponentUpdateç­‰è¿›è¡Œå¯¹æ¯”ï¼Œé¿å…å¤šæ¬¡æ¸²æŸ“</p>
</li>
<li>
<p>å¯¹äºéœ€è¦åŠ è½½çš„ä¸ä¼šå˜åŒ–çš„é™æ€èµ„æºï¼Œæ¯”å¦‚æ¸¸æˆçš„åŠ¨ç”»æ–‡ä»¶ï¼Œå¯ä»¥é¦–æ¬¡ä¸‹è½½ä¸‹æ¥ï¼Œæ”¾åˆ°ç”¨æˆ·æœ¬åœ°ï¼Œåé¢ç›´æ¥ä»æœ¬åœ°è·å–</p>
</li>
<li>
<p>å¤§æ–‡ä»¶é¢„åŠ è½½ï¼Œä½†è¦æ³¨æ„å–èˆï¼Œå…¨éƒ½æ”¾åœ¨é¦–é¡µä¼šå ç”¨ä¸»åŒ…ä½“ç§¯ã€‚èƒ½ä¸Šcdnçš„å°½é‡ä¸Šcdnï½</p>
</li>
</ul>
<h5 id="4é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ">ï¼ˆ4ï¼‰é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ</h5>
<ul>
<li>
<p>live-pusheræ¨æµç»„ä»¶ä¸­çš„autopushå±æ€§éœ€è¦è®¾ç½®ä¸ºfalseï¼Œå› ä¸ºéƒ½æ˜¯å‘ï¼Œå¼€å‘ä¸­ä¼šé‡åˆ°-1301çš„é”™è¯¯ç ï¼Œæ˜¯å°ç¨‹åºçš„å…¼å®¹æ€§bugã€‚é¡ºä¾¿è¯´ä¸‹-1301çš„è§£å†³æ–¹æ¡ˆ</p>
<ol>
<li>åœ¨æœ‰é—®é¢˜çš„æœºå™¨ä¸Šé¢ï¼Œå°† autopush è®¾ç½®ä¸º falseï¼Œé¿å…è‡ªåŠ¨æ¨æµï¼›</li>
<li>åœ¨å¼€å§‹æ¨æµå‰ï¼Œè®¾ç½®æ‘„åƒå¤´å’Œéº¦å…‹é£ä¸ºå…³é—­çŠ¶æ€</li>
<li>æ‹¿åˆ°å®é™…å¯æ¨æµçš„ url åï¼Œå…ˆå¼€å¯æ‘„åƒå¤´ã€éº¦å…‹é£ï¼Œå†å¯åŠ¨æ¨æµ</li>
<li>åœ¨æ¨æµçš„ç»„ä»¶ bindstatechange ç»‘å®šçš„ onPushStateChange äº‹ä»¶å›è°ƒ code ä¸º -1307 -1301 ç­‰é”™è¯¯æ˜¯ï¼Œåœæ­¢æ¨æµã€ é‡æ–°æ¨æµ</li>
</ol>
</li>
<li>
<p>ä½¿ç”¨zegoæ—¶ï¼Œä»–ä»¬æä¾›ä¸¤ç§æ¥å…¥æ–¹å¼ï¼Œéœ€è¦é€‰æ‹©æ—§ç‰ˆæœ¬ï¼Œå› ä¸ºæ–°ç‰ˆæœ¬ä¸æ”¯æŒTaroã€‚</p>
</li>
<li>
<p>å¦‚ä½•ä½¿ç›´æ’­åˆ‡æ¢äº†é¡µé¢è¿˜èƒ½å¬åˆ°å£°éŸ³ï¼šéœ€è¦å°†LivePlayerç»„ä»¶çš„autoPauseIfNavigateå’ŒautoPauseIfOpenNavigateå±æ€§è®¾ç½®ä¸ºfalse</p>
</li>
<li>
<p>é™éŸ³å¤±æ•ˆé—®é¢˜ï¼šéœ€è¦å°†livePusherå®ä¾‹çš„setMICVolumeæ–¹æ³•çš„volumeå­—æ®µè®¾ç½®ä¸º0ï¼Œlivepushç»„ä»¶çš„å±æ€§çš„enableMicæœ‰æ—¶ä¼šä¸ç”Ÿæ•ˆ</p>
</li>
<li>
<p>åœ¨å°ç¨‹åºç«¯ï¼Œç”¨æˆ·çš„æ‰‹æœºå·¦æ»‘é€€å‡ºæˆ‘ä»¬æ— æ³•æ§åˆ¶ï¼Œæ‰€ä»¥å¯ä»¥åœ¨é¡µé¢ç»„ä»¶é”€æ¯æ—¶è®¤ä¸ºä»–é€€å‡ºäº†æˆ¿é—´</p>
</li>
</ul>
<h4 id="å°ç¨‹åºç¾é¢œ">å°ç¨‹åºç¾é¢œ</h4>
<p>ä½¿ç”¨çš„æ˜¯å°ç¨‹åºè‡ªå¸¦çš„æ¨æµç»„ä»¶ç¾é¢œï¼Œåœ¨æˆ¿é—´å¤–é€‰æ‹©å®Œç¾ç™½æ»¤é•œåå¸¦å…¥åˆ°æˆ¿é—´å†…çš„æ¨æµç»„ä»¶ä¸­ã€‚é‡åˆ°é»‘å±çš„æƒ…å†µï¼Œéœ€è¦å…ˆåœæ­¢é¢„è§ˆå†å¯åŠ¨é¢„è§ˆ</p>
<h4 id="å°ç¨‹åºæ”¯ä»˜">å°ç¨‹åºæ”¯ä»˜</h4>
<p><img src="https://weidadeda.github.io/post-images/1685437229551.png" alt="" loading="lazy"><br>
æˆ‘ä»¬ä½¿ç”¨çš„v2ç‰ˆæœ¬ï¼ŒsignTypeé€‰æ‹©çš„â€˜MD5â€™ï¼Œå…¶å®è¿™é‡Œè°ƒè¯•è¿˜æ˜¯æ¯”è¾ƒè´¹æ—¶é—´çš„ï¼Œä½†ä¸»è¦è¿˜æ˜¯å’Œåç«¯è”è°ƒæ—¶åç«¯è¿”å›çš„å‚æ•°æœ‰é—®é¢˜ã€‚å°ç¨‹åºçš„æ”¯ä»˜ç›¸æ¯”äºå…¬ä¼—å·çš„æ”¯ä»˜ï¼Œå‰ç«¯è¦ç®€å•çš„å¤šã€‚<br>
å‰ç«¯éœ€è¦å°†ç”¨æˆ·çš„wx.loginçš„codeç ä¼ ç»™åç«¯ï¼Œåç«¯å¯ä»¥å»æ¢å–openidï¼Œnoncestrã€signã€prepayidç­‰å‚æ•°è¿”å›ç»™å‰ç«¯ï¼Œå‰ç«¯å»è°ƒç”¨wx.requestPaymentæ–¹æ³•ï¼Œå°†ä¸Šé¢æœåŠ¡ç«¯è¿”å›çš„å‚æ•°ä¼ ç»™å¾®ä¿¡ï¼Œå°±èƒ½å¤ŸæˆåŠŸè°ƒèµ·å¾®ä¿¡æ”¯ä»˜ï¼ŒæˆåŠŸä¸å¤±è´¥éƒ½æœ‰ç›¸å…³å›æ‰ã€‚</p>
<h4 id="å°ç¨‹åºåˆ†äº«">å°ç¨‹åºåˆ†äº«</h4>
<p><img src="https://weidadeda.github.io/post-images/1685437278552.jpg" alt="" loading="lazy"><br>
å¯¹äºåˆ†äº«ï¼Œæ¯”è¾ƒå¤æ‚çš„å°±æ˜¯åˆ†äº«è¿›æˆ¿ï¼Œå¦‚æœè¢«åˆ†äº«çš„ç”¨æˆ·æ˜¯ç™»å½•è¿‡çš„ï¼Œåˆ™ä¸éœ€è¦åšå¤ªå¤šå¤„ç†ï¼Œä½†çœŸå®åœºæ™¯å¾€å¾€æ˜¯æœªç™»å½•çš„æƒ…å†µå±…å¤šï¼Œæ‰€ä»¥éœ€è¦å…ˆè·³è½¬ç™»å½•ï¼Œå¼€å§‹æˆ‘ä»¬çš„æ–¹æ¡ˆæ˜¯å°†å‚æ•°å¸¦åˆ°ç™»å½•é¡µï¼Œä½†éšç€ä¸šåŠ¡è¶Šæ¥è¶Šå¤æ‚ï¼Œæˆ‘ä»¬æ”¾å¼ƒäº†è¿™ç§æ–¹å¼ï¼Œé‡‡ç”¨å°†å‚æ•°ç›´æ¥æ”¾åˆ°reduxä¸­ã€‚ä½†æ˜¯æ€æƒ³éƒ½ä¸€æ ·ï¼Œå°±æ˜¯è¦æŠŠå‚æ•°è®°å½•ä¸‹æ¥ã€‚</p>
<h4 id="å°ç¨‹åºåŠ¨ç”»">å°ç¨‹åºåŠ¨ç”»</h4>
<p>å°ç¨‹åºä¸­æ’­æ”¾åŠ¨ç”»æ˜¯ä½¿ç”¨canvasè¿›è¡Œæ’­æ”¾ï¼Œä½¿ç”¨spineæ ¼å¼å’Œsvgaæ ¼å¼ä¸¤ç§åŠ¨ç”»ï¼Œæ¨èspineæ ¼å¼ï¼Œä½†ä»ç„¶éœ€è¦å¯¹æ—§çš„svgaæ ¼å¼çš„ç¤¼ç‰©åŠ¨ç”»åšå…¼å®¹</p>
<ul>
<li>
<p>å¯¹äºsvgaæ ¼å¼çš„ç¤¼ç‰©ï¼Œä½¿ç”¨svgaplayer-weappè¿™ä¸ªåº“ï¼Œå¦‚æœé‡åˆ°åŠ¨ç”»æ’­æ”¾æ…¢çš„é—®é¢˜ï¼Œåˆ™éœ€è¦å°†æ–‡ä»¶æå‰åŠ è½½ã€‚</p>
</li>
<li>
<p>å¯¹äºspineæ ¼å¼çš„ç¤¼ç‰©ï¼Œå› ä¸ºç¤¾åŒºä¸Šå¯¹äºspineæ ¼å¼åŠ¨ç”»è§£å†³æ–¹æ¡ˆå¾ˆå°‘ï¼Œæ‰€ä»¥æˆ‘ä»¬è‡ªå·±å°è£…äº†æ”¯æŒspineåŠ¨ç”»çš„åº“ã€‚<br>
åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­æˆ‘ä»¬å‘ç°äº†ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯åŠ¨ç”»æ— æ³•æ’­æ”¾æ—¶ï¼Œå°ç¨‹åºcanvas 2d çš„ç”»å¸ƒæœ‰ 4096 å¤§å°é™åˆ¶ã€‚æ’­æ”¾ä¸€äº›ç¤¼ç‰©çš„spineåŠ¨ç”»æ—¶ï¼Œç¤¼ç‰©è¿‡å¤§ï¼Œéœ€è¦å°†ç¤¼ç‰©å°ºå¯¸é™¤2ï¼Œç„¶åèµ‹å€¼ç»™canvasã€‚</p>
</li>
<li>
<p>æ’­æ”¾åŠ¨ç”»éŸ³æ•ˆçš„å‘ï¼šå¯¹äºå°ç¨‹åºiosçš„é™éŸ³æ¨¡å¼createInnerAudioContextå£°éŸ³ä¸æ’­æ”¾é—®é¢˜ï¼Œéœ€è¦å…¨å±€æŠŠwx.setInnerAudioOptionçš„obeyMuteSwitchè®¾ç½®ä¸ºfalse,è¿™æ ·å³ä½¿æ˜¯åœ¨é™éŸ³æ¨¡å¼ä¸‹ï¼Œä¹Ÿèƒ½æ’­æ”¾å£°éŸ³ã€‚</p>
</li>
</ul>
<h4 id="å°ç¨‹åºå‡çº§">å°ç¨‹åºå‡çº§</h4>
<p>æˆ‘ä»¬ç›®å‰å…¨éƒ½æ˜¯é‡‡ç”¨çš„å¼ºåˆ¶å‡çº§ï¼Œåªæœ‰ç¡®å®šæŒ‰é’®ï¼Œç‚¹å‡»ç¡®å®šå°±ä¼šç«‹åˆ»è¿›è¡Œé‡å¯å¹¶å‡çº§ã€‚ä»£ç å¦‚ä¸‹</p>
<details>
<summary>æ›´æ–°å°ç¨‹åºä»£ç </summary>
<pre><code class="language-js">/*
 * @Date: 2022-05-30 15:27:36
 * @LastEditors: ç‹å¤§ä¼Ÿ
 * @LastEditTime: 2022-06-15 22:00:21
 */
import Taro from '@tarojs/taro'
export const updateWeapp = (isForce?: boolean): void =&gt; {
  function tipModal(updateManager) {
    Taro.showModal({
      title: 'æ›´æ–°æç¤º',
      content: 'æ–°ç‰ˆæœ¬å·²ç»å‡†å¤‡å¥½ï¼Œæ˜¯å¦é©¬ä¸Šé‡å¯å°ç¨‹åºï¼Ÿ',
      showCancel: false,
      success: function (res) {
        if (res.confirm) {
          // æ–°çš„ç‰ˆæœ¬å·²ç»ä¸‹è½½å¥½ï¼Œè°ƒç”¨ applyUpdate åº”ç”¨æ–°ç‰ˆæœ¬å¹¶é‡å¯
          updateManager.applyUpdate()
        } else {
          if (isForce) {
            // æ–°ç‰ˆæœ¬çš„å°ç¨‹åºéœ€è¦ç­‰ä¸‹ä¸€æ¬¡å†·å¯åŠ¨æ‰ä¼šä½¿ç”¨ï¼Œæ‰€ä»¥è®©ç”¨æˆ·å¼ºåˆ¶æ›´æ–°
            tipModal(updateManager)
          }
        }
      }
    })
  }
  if (process.env.TARO_ENV === 'weapp') {
    const updateManager = Taro.getUpdateManager()
    updateManager.onCheckForUpdate(function (res) {
      // è¯·æ±‚å®Œæ–°ç‰ˆæœ¬ä¿¡æ¯çš„å›è°ƒ
      console.log('æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬: ', res)
      if (res.hasUpdate) {
        updateManager.onUpdateReady(function () {
          console.log('å‡†å¤‡å¥½æ›´æ–°')
          tipModal(updateManager)
        })

        updateManager.onUpdateFailed(function () {
          // æ–°çš„ç‰ˆæœ¬ä¸‹è½½å¤±è´¥
          console.log('æ–°çš„ç‰ˆæœ¬ä¸‹è½½å¤±è´¥,èµ°è‡ªåŠ¨å¼‚æ­¥æ›´æ–°')
        })
      }
    })
  }
}
</code></pre>
</details>
<h4 id="å°ç¨‹åºwebview">å°ç¨‹åºwebview</h4>
<p>é…ç½®ä¸å…¬ä¼—å·ã€‚å°ç¨‹åºä¸­åŠ è½½webviewï¼Œåªèƒ½å…¨å‡­åŠ è½½ï¼Œè€Œä¸”ç½‘é¡µçš„åŸŸåéœ€è¦åœ¨å°ç¨‹åºåå°é…ç½®æˆä¸šåŠ¡åŸŸåï¼Œæœ‰ä¸€ç§æƒ…å†µæ˜¯ä¸éœ€è¦çš„ï¼Œå°±æ˜¯åŠ è½½ä¸æ­¤å°ç¨‹åºç›¸å…³è”çš„å…¬ä¼—å·é¡µé¢æ—¶ï¼Œè¿™éœ€è¦å»å…¬ä¼—å·çš„åå°å»é…ç½®å…³è”å°ç¨‹åºã€‚</p>
<h4 id="å°ç¨‹åºå›¾ç‰‡">å°ç¨‹åºå›¾ç‰‡</h4>
<p>ä½ç«¯æœºå‹ä¸æ”¯æŒwebpï¼Œéœ€è¦å¯¹å›¾ç‰‡åšå¤„ç†ï¼Œæ£€æµ‹åˆ°ä¸æ”¯æŒwebpæ ¼å¼åˆ™å±•ç¤ºjpgæ ¼å¼å›¾ç‰‡ï¼Œä¸ç„¶æ— æ³•åŠ è½½ï¼Œæ£€æµ‹æ˜¯å¦æ”¯æŒwebpæ ¼å¼ä»£ç å¦‚ä¸‹</p>
<details>
<summary>webpå›¾ç‰‡æ”¯æŒæ£€æµ‹</summary>
<pre><code class="language-js">/**
 * webpå›¾ç‰‡æ”¯æŒæ£€æµ‹
 * @returns support æ˜¯å¦æ”¯æŒwebpå›¾ç‰‡
 */
function detectWebp() {
  if (_webpSupport === undefined) {
    let support = false

    try {
      let _wx$getSystemInfoSync = wx.getSystemInfoSync(),
        platform = _wx$getSystemInfoSync.platform,
        system = _wx$getSystemInfoSync.system
      // æ£€æµ‹IOSç³»ç»Ÿwebpæ”¯æŒ
      let versionResult = /[0-9.]*$/.exec(system)
      let systemVersion = versionResult ? versionResult[0] : ''
      let iosSystemSupport = platform === 'ios' &amp;&amp; !!systemVersion &amp;&amp; compareVersion(systemVersion, '14.0') &gt;= 0

      support = platform === 'devtools' || platform === 'android' || iosSystemSupport

      _webpSupport = support
    } catch (e) {
      console.log(e)
      _webpSupport = false
    }
  }
  return _webpSupport
}
function compareVersion(v1, v2) {
  v1 = v1.split('.')
  v2 = v2.split('.')
  const len = Math.max(v1.length, v2.length)
  while (v1.length &lt; len) {
    v1.push('0')
  }
  while (v2.length &lt; len) {
    v2.push('0')
  }
  for (let i = 0; i &lt; len; i++) {
    const num1 = parseInt(v1[i])
    const num2 = parseInt(v2[i])
    if (num1 &gt; num2) {
      return 1
    } else if (num1 &lt; num2) {
      return -1
    }
  }
  return 0
}
</code></pre>
</details>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[jsæš‚æ—¶æ€§æ­»åŒº]]></title>
        <id>https://weidadeda.github.io/post/js-zan-shi-xing-si-qu</id>
        <link href="https://weidadeda.github.io/post/js-zan-shi-xing-si-qu">
        </link>
        <updated>2022-04-15T03:10:36.000Z</updated>
        <content type="html"><![CDATA[<blockquote>
<p>æš‚æ—¶æ€§æ­»åŒº(TDZ)æ˜¯é’ˆå¯¹'const','let'è¿™ä¸¤ä¸ªå…³é”®å­—è€Œäº§ç”Ÿçš„æ¦‚å¿µã€‚<br>
é¦–å…ˆå˜é‡æå‡è¿™ä¸ªjsçš„åŸºæœ¬æ¦‚å¿µæ— æ³•æ’¼åŠ¨ï¼Œ'const'å’Œ'let'ä½œä¸ºå—çº§ä½œç”¨åŸŸä¹Ÿä¸èƒ½é¿å…ã€‚<br>
å’Œ'var'ä¸åŒï¼Œè¿™ä¸¤ä¸ªå…³é”®å­—å°†ä½œç”¨åŸŸé™åˆ¶åœ¨äº†â€˜å—â€™ä¸­ï¼Œä¸”è§„å®šäº†åœ¨è¯¥å—ä¸­ï¼Œç”±è¿™ä¸¤ä¸ªå…³é”®å­—å®šä¹‰çš„å˜é‡å·²ç»è¢«åˆ†é…å†…å­˜ã€‚<br>
å³å…¶å®å·²ç»'å­˜åœ¨'äº†ï¼Œä½†ç¨‹åºæœªæ‰§è¡Œåˆ°å£°æ˜å¤„æ—¶ï¼Œè®¿é—®è¯¥å˜é‡éƒ½ä¼šæŠ¥å¼•ç”¨é”™è¯¯ã€‚<br>
è¿™ä¸ªæ—¶å€™ï¼Œå¯¹äºè¯¥å˜é‡æ¥è¯´å°±æ˜¯'æš‚æ—¶æ€§æ­»åŒº'ï¼Œé€šä¿—æ¥è¯´å°±æ˜¯è¯¥å˜é‡å­˜åœ¨ï¼Œä½†å¹¶æœªå®Œå…¨å­˜åœ¨</p>
</blockquote>
<pre><code class="language-js">if (true) {
  // TDZå¼€å§‹
  tmp = 'abc'; // ReferenceError
  console.log(tmp); // ReferenceError


  let tmp; // TDZç»“æŸ
  console.log(tmp); // undefined


  tmp = 123;
  console.log(tmp); // 123
}
</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­ï¼Œåœ¨letå‘½ä»¤å£°æ˜å˜é‡tmpä¹‹å‰ï¼Œéƒ½å±äºå˜é‡tmpçš„â€œæ­»åŒºâ€</p>
<pre><code class="language-js">var tmp = 123;
if (true) {
  tmp = 'abc'; // ReferenceError
  let tmp;
}
</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­ï¼Œå­˜åœ¨å…¨å±€å˜é‡tmpï¼Œä½†æ˜¯å—çº§ä½œç”¨åŸŸå†…letåˆå£°æ˜äº†ä¸€ä¸ªå±€éƒ¨å˜é‡tmpï¼Œå¯¼è‡´åè€…ç»‘å®šè¿™ä¸ªå—çº§ä½œç”¨åŸŸï¼Œæ‰€ä»¥åœ¨letå£°æ˜å˜é‡å‰ï¼Œå¯¹tmpèµ‹å€¼ä¼šæŠ¥é”™ã€‚</p>
<p>ES6 æ˜ç¡®è§„å®šï¼Œå¦‚æœåŒºå—ä¸­å­˜åœ¨letå’Œconstå‘½ä»¤ï¼Œè¿™ä¸ªåŒºå—å¯¹è¿™äº›å‘½ä»¤å£°æ˜çš„å˜é‡ï¼Œä»ä¸€å¼€å§‹å°±å½¢æˆäº†å°é—­ä½œç”¨åŸŸã€‚å‡¡æ˜¯åœ¨å£°æ˜ä¹‹å‰å°±ä½¿ç”¨è¿™äº›å˜é‡ï¼Œå°±ä¼šæŠ¥é”™ã€‚</p>
<pre><code class="language-js">// ä¸æŠ¥é”™
var x = x;
// æŠ¥é”™
let x = x;
// ReferenceError: x is not defined
</code></pre>
<p>ä¸Šé¢ä»£ç æŠ¥é”™ï¼Œä¹Ÿæ˜¯å› ä¸ºæš‚æ—¶æ€§æ­»åŒºã€‚ä½¿ç”¨letå£°æ˜å˜é‡æ—¶ï¼Œåªè¦å˜é‡åœ¨è¿˜æ²¡æœ‰å£°æ˜å®Œæˆå‰ä½¿ç”¨ï¼Œå°±ä¼šæŠ¥é”™ã€‚ä¸Šé¢è¿™è¡Œå°±å±äºè¿™ä¸ªæƒ…å†µï¼Œåœ¨å˜é‡xçš„å£°æ˜è¯­å¥è¿˜æ²¡æœ‰æ‰§è¡Œå®Œæˆå‰ï¼Œå°±å»å–xçš„å€¼ï¼Œå¯¼è‡´æŠ¥é”™â€x æœªå®šä¹‰â€œ</p>
<p>æœ¬æ–‡è½¬è½½è‡ªhttps://blog.csdn.net/zzzzz111333/article/details/122562000</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[åˆ©ç”¨ ImageData å®ç°å›¾ç‰‡ç¿»è½¬å’Œè§†é¢‘é•œåƒ]]></title>
        <id>https://weidadeda.github.io/post/li-yong-imagedata-shi-xian-tu-pian-fan-zhuan-he-shi-pin-jing-xiang</id>
        <link href="https://weidadeda.github.io/post/li-yong-imagedata-shi-xian-tu-pian-fan-zhuan-he-shi-pin-jing-xiang">
        </link>
        <updated>2022-03-09T11:21:10.000Z</updated>
        <summary type="html"><![CDATA[<p>æœ€è¿‘åœ¨æè§†é¢‘ç›´æ’­ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªåŠŸèƒ½æ˜¯è§†é¢‘é•œåƒï¼Œé‚£ä¹ˆæœ‰ä¸¤ç§å®ç°æ–¹å¼ã€‚<br>
ä¸€ç§æ˜¯è€å¸ˆç«¯ç‚¹å‡»é•œåƒï¼Œé€šè¿‡cssæŠŠè‡ªå·±çš„videoæ ‡ç­¾é•œåƒï¼Œç„¶åå‘é€ä¿¡ä»¤ç»™å­¦ç”Ÿç«¯ï¼Œå­¦ç”Ÿç«¯æ”¶åˆ°æ¶ˆæ¯ä¹‹åä¹Ÿé€šè¿‡csså»å®ç°é•œåƒï¼›<br>
ç¬¬äºŒç§å°±æ˜¯è€å¸ˆç«¯å¯¹è§†é¢‘æµåšä¸€ä¸ªé•œåƒå¤„ç†ï¼Œå­¦ç”Ÿç«¯æ— éœ€æ“ä½œï¼Œå¾ˆæ˜¾ç„¶ç¬¬äºŒç§æ–¹æ³•æ¯”è¾ƒå¥½ï¼›</p>
<p>æ€ä¹ˆå®ç°å¯¹è§†é¢‘æµçš„é•œåƒå‘¢ï¼Œé¦–å…ˆè¦çŸ¥é“çš„å°±æ˜¯è§†é¢‘æ˜¯ç”±ä¸€å¸§å¸§çš„å›¾ç‰‡ç»„åˆè€Œæˆï¼Œæˆ‘ä»¬è¦å¯¹è§†é¢‘æµé•œåƒï¼Œé¦–å…ˆè¦å¯¹å›¾ç‰‡è¿›è¡Œé•œåƒã€‚</p>
<p>å¯¹å›¾ç‰‡é•œåƒçš„è¯ï¼Œå°±è¦å¯¹ImageDataåšå¤„ç†<br>
é¦–å…ˆäº†è§£ä¸€ä¸‹ä»€ä¹ˆæ˜¯ImageDataï¼š</p>
<blockquote>
<p>ImageData æ¥å£æè¿° canvas å…ƒç´ çš„ä¸€ä¸ªéšå«åƒç´ æ•°æ®çš„åŒºåŸŸã€‚ä½¿ç”¨ ImageData() æ„é€ å‡½æ•°åˆ›å»ºæˆ–è€…ä½¿ç”¨å’Œ canvas åœ¨ä¸€èµ·çš„ CanvasRenderingContext2D å¯¹è±¡çš„åˆ›å»ºæ–¹æ³•ï¼š createImageData() å’Œ getImageData()ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨ putImageData() è®¾ç½® canvas çš„ä¸€éƒ¨åˆ†ã€‚</p>
</blockquote>
<h4 id="æˆ‘ä»¬å…ˆä»¥æ—‹è½¬å›¾ç‰‡ä¸ºä¾‹å­åšä¸ªè¯´æ˜">æˆ‘ä»¬å…ˆä»¥æ—‹è½¬å›¾ç‰‡ä¸ºä¾‹å­åšä¸ªè¯´æ˜</h4>
<h5 id="åŸºæœ¬åŸç†1åƒç´ çŸ©é˜µå˜æ¢">åŸºæœ¬åŸç†1â€”â€”åƒç´ çŸ©é˜µå˜æ¢</h5>
<p>ImageDataå¯¹è±¡ä¸­å­˜å‚¨ç€canvaså¯¹è±¡çœŸå®çš„åƒç´ æ•°æ®ï¼Œå®ƒåŒ…å«ä»¥ä¸‹å‡ ä¸ªåªè¯»å±æ€§ï¼š</p>
<ul>
<li>width  å›¾ç‰‡å®½åº¦ï¼Œå•ä½æ˜¯åƒç´ </li>
<li>height  å›¾ç‰‡é«˜åº¦ï¼Œå•ä½æ˜¯åƒç´ </li>
<li>data  <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Uint8ClampedArray">Uint8ClampedArray</a>ç±»å‹çš„ä¸€ç»´æ•°ç»„ï¼ŒåŒ…å«ç€RGBAæ ¼å¼çš„æ•´å‹æ•°æ®ï¼ŒèŒƒå›´åœ¨0è‡³255ä¹‹é—´ï¼ˆåŒ…æ‹¬255ï¼‰ã€‚<br>
dataå±æ€§è¿”å›ä¸€ä¸ª Uint8ClampedArrayï¼Œå®ƒå¯ä»¥è¢«ä½¿ç”¨ä½œä¸ºæŸ¥çœ‹åˆå§‹åƒç´ æ•°æ®ã€‚æ¯ä¸ªåƒç´ ç”¨4ä¸ª1byteså€¼(æŒ‰ç…§çº¢ï¼Œç»¿ï¼Œè“å’Œé€æ˜å€¼çš„é¡ºåº; è¿™å°±æ˜¯&quot;RGBA&quot;æ ¼å¼) æ¥ä»£è¡¨ã€‚æ¯ä¸ªé¢œè‰²å€¼éƒ¨ä»½ç”¨0è‡³255æ¥ä»£è¡¨ã€‚æ¯ä¸ªéƒ¨ä»½è¢«åˆ†é…åˆ°ä¸€ä¸ªåœ¨æ•°ç»„å†…è¿ç»­çš„ç´¢å¼•ï¼Œå·¦ä¸Šè§’åƒç´ çš„çº¢è‰²éƒ¨ä»½åœ¨æ•°ç»„çš„ç´¢å¼•0ä½ç½®ã€‚åƒç´ ä»å·¦åˆ°å³è¢«å¤„ç†ï¼Œç„¶åå¾€ä¸‹ï¼Œéå†æ•´ä¸ªæ•°ç»„ã€‚</li>
</ul>
<p>å…·ä½“è¯·çœ‹<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Canvas_API/Tutorial/Pixel_manipulation_with_canvas">åƒç´ æ“ä½œ</a></p>
<p>æˆ‘ä»¬é€šè¿‡ImageDataå¯ä»¥å¯¹å›¾ç‰‡çš„æ¯ä¸ªåƒç´ ç‚¹åšæ“ä½œã€‚æ¯”å¦‚æˆ‘ä»¬ç°åœ¨è¦å°†å›¾ç‰‡å‘å³æ—‹è½¬90åº¦</p>
<p>ä¸€ä¸ª 4 Ã— 3 åƒç´ çš„åŸå§‹å›¾ç‰‡ï¼Œå¯ä»¥çœ‹ä½œå¦‚ä¸‹å½¢å¼çš„åƒç´ çŸ©é˜µ Aï¼š<br>
<img src="https://weidadeda.github.io/post-images/1647858122464.png" alt="" loading="lazy"><br>
å›¾ç‰‡å‘å³æ—‹è½¬ 90Â°ï¼Œå®è´¨å°±æ˜¯è®¾æ³•å°† A å˜ä¸º Aâ€™ â€”â€”<br>
<img src="https://weidadeda.github.io/post-images/1647858132107.png" alt="" loading="lazy"><br>
è¿™å¯ä»¥é€šè¿‡åŸçŸ©é˜µä¸€æ¬¡ è½¬ç½®ã€ä¸å¤šæ¬¡åˆç­‰ åˆ— å˜æ¢ï¼ˆé€†åºæ’åˆ—å„åˆ—ï¼‰å¾—åˆ°ï¼š<br>
<img src="https://weidadeda.github.io/post-images/1647858162556.png" alt="" loading="lazy"><br>
åŒç†ï¼Œå›¾ç‰‡å‘å·¦æ—‹è½¬ 90Â°ï¼Œå®é™…ä¸Šå°±æ˜¯å¾—åˆ°çŸ©é˜µ Aâ€™' ï¼š<br>
<img src="https://weidadeda.github.io/post-images/1647858170777.png" alt="" loading="lazy"><br>
è¿™å¯ä»¥é€šè¿‡åŸçŸ©é˜µä¸€æ¬¡ è½¬ç½®ã€ä¸å¤šæ¬¡åˆç­‰ è¡Œ å˜æ¢ï¼ˆé€†åºæ’åˆ—å„è¡Œï¼‰å¾—åˆ°â€”â€”<br>
<img src="https://weidadeda.github.io/post-images/1647858177575.png" alt="" loading="lazy"></p>
<h5 id="åŸºæœ¬åŸç†2åƒç´ æ•°ç»„ä¸çŸ©é˜µçš„å¯¹åº”å…³ç³»">åŸºæœ¬åŸç†2â€”â€”åƒç´ æ•°ç»„ä¸çŸ©é˜µçš„å¯¹åº”å…³ç³»</h5>
<p>ç”±äº ImageData.data å¯¹åº”ä¸€ä¸ªæ•°ç»„ï¼Œå¯¹äº 4 Ã— 3 çš„å›¾ç‰‡è€Œè¨€ï¼ŒImageData.data å°±æ˜¯ä¸€ä¸ªå…·æœ‰ 48 ä¸ªå…ƒç´ çš„æ•°ç»„ Dï¼Œä¸å¦¨æ¯ä¸ªå…ƒç´ çš„å€¼å°±æ˜¯å…¶ä¸‹æ ‡å€¼ï¼Œåˆ™ï¼š</p>
<pre><code class="language-js">D=[0,1,2,3,4,5,6,7...44,45,46,47]
</code></pre>
<p>å…¶ä¸­ï¼š<br>
å…ƒç»„ (0, 1, 2, 3) è¡¨ç¤ºç¬¬ 1(= 0 / 4 + 1) ä¸ªåƒç´ çš„é¢œè‰²ä¸º rgba(0, 1, 2, 3/255)ï¼›<br>
å…ƒç»„ (4, 5, 6, 7) è¡¨ç¤ºç¬¬ 2(= 4 / 4 + 1) ä¸ªåƒç´ çš„é¢œè‰²ä¸º rgba(4, 5, 6, 7/255)ï¼›<br>
å…ƒç»„ (8, 9, 10, 11) è¡¨ç¤ºç¬¬ 3(= 8 / 4 + 1) ä¸ªåƒç´ çš„é¢œè‰²ä¸º rgba(8, 9, 10, 11/255)ï¼›<br>
â€¦</p>
<p>å…ƒç»„ (i, i+1, i+2, i+3) è¡¨ç¤ºç¬¬ (i / 4 + 1) ä¸ªåƒç´ çš„é¢œè‰²ä¸º rgba(i, i+1, i+2, (i+3)/255)ï¼›<br>
â€¦<br>
å…ƒç»„ (44, 45, 46, 47) è¡¨ç¤ºç¬¬ 12(= 44 / 4 + 1) ä¸ªåƒç´ çš„é¢œè‰²ä¸º rgba(44, 45, 46, 47/255)ã€‚</p>
<p>å¯è§ä» 0 å¼€å§‹éå† D æ•°ç»„ï¼Œæ¯æ¬¡é€’å¢ 4 ä¸ªå•ä½ï¼Œå³å¯ä¾æ¬¡å¾—åˆ°å„ä¸ªåƒç´ çš„çº¢è‰²å€¼ Rï¼Œå†ä¾æ¬¡åŠ 1ã€åŠ 2ã€åŠ 3ï¼Œå³å¾—åˆ°å¯¹åº”çš„ç»¿è‰²å€¼ Gã€è“è‰²å€¼ Bã€ç­‰æ•ˆ Î± é€šé“å€¼ Aã€‚</p>
<p>åä¹‹ï¼Œå¦‚æœçŸ¥é“å›¾ç‰‡çš„åƒç´ å°ºå¯¸ä¸º 4 Ã— 3ï¼Œåˆ™å¯ä»¥é€šè¿‡ä¸‹å›¾æ‰¾åˆ°æ•°ç»„ D çš„å„ä¸ªå…ƒç´ ï¼š<br>
<img src="https://weidadeda.github.io/post-images/1647858189293.png" alt="" loading="lazy"></p>
<p>å¯è§å„åƒç´ ç‚¹æ˜¯æŒ‰ç…§ ä»å·¦è‡³å³ã€ä»ä¸Šè‡³ä¸‹ çš„é¡ºåºæ’åˆ—çš„ã€‚è®¾å›¾ç‰‡æ€»å®½åº¦åƒç´ ä¸º Wï¼Œæ€»é«˜åº¦åƒç´ ä¸º Hï¼Œä»»ä¸€åƒç´ ç‚¹ P çš„åæ ‡ä¸º (x, y)ï¼ŒP çš„çº¢è‰²å€¼åœ¨æ•°ç»„ D çš„ä¸‹æ ‡ä¸º R(x, y)ï¼Œåˆ™ï¼š</p>
<pre><code class="language-js">R(x,y)=(x+W*y)Ã—4
</code></pre>
<p>éªŒè¯ï¼šï¼ˆx ä¸ y å‡ä» 0 å¼€å§‹è®¡æ•°ï¼‰</p>
<p>R(2, 1) = (2 + 1 Ã— 4) Ã— 4 = 24<br>
R(1, 2) = (1 + 2 Ã— 4) Ã— 4 = 36<br>
R(3, 1) = (3 + 1 Ã— 4) Ã— 4 = 28</p>
<p>æ‹¿åˆ°äº† R(x, y)ï¼Œä¸éš¾æ±‚å‡ºè¯¥åƒç´ çš„çºµå‘ä¸­å¿ƒå¯¹ç§°åƒç´  Rh(x, y)ã€æ¨ªå‘ä¸­å¿ƒå¯¹ç§°åƒç´  Rw(x, y)ã€ä»¥åŠä¸»å¯¹è§’çº¿å¯¹ç§°åƒç´  Rd(x, y)ï¼š</p>
<pre><code class="language-js">Rh(x,y)=[x+W*(Hâˆ’1âˆ’y)]*4 // åˆç­‰è¡Œå˜æ¢
Rw(x,y)=[(Wâˆ’1âˆ’x)+W*y]*4 // åˆç­‰åˆ—å˜æ¢
Rd(x,y)=(y+H*x)*4
</code></pre>
<h5 id="å…·ä½“å®ç°">å…·ä½“å®ç°</h5>
<p>åŸºæœ¬æ€è·¯ï¼š</p>
<ul>
<li>é€šè¿‡ canvas è·å–ç›®æ ‡å›¾ç‰‡çš„ ImageData å¯¹è±¡ï¼›</li>
<li>è½¬ç½®åŸå›¾ç‰‡æ•°ç»„ï¼Œå¾—åˆ°æ•°ç»„ ATï¼›</li>
<li>å¯¹ AT æ‰§è¡Œä¸€ç»„åˆç­‰è¡Œå˜æ¢ï¼Œä½¿å„è¡Œé€†åºæ’åˆ—ï¼Œå¾—åˆ°å·¦æ—‹ 90Â° æ•ˆæœï¼›</li>
<li>å¯¹ AT æ‰§è¡Œä¸€ç»„åˆç­‰åˆ—å˜æ¢ï¼Œä½¿å„åˆ—é€†åºæ’åˆ—ï¼Œå¾—åˆ°å³æ—‹ 90Â° æ•ˆæœï¼›</li>
<li>å°†æ–°çš„åƒç´ æ•°ç»„å†™å›å›¾ç‰‡æºæ ‡ç­¾ã€‚</li>
</ul>
<p>HTMLï¼š</p>
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;title&gt;Rotate by ImageData&lt;/title&gt;
    &lt;style&gt;
        .image{ margin-top: 5px; }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div class=&quot;btns&quot;&gt;
        &lt;input type=&quot;button&quot; value=&quot;å·¦è½¬ 90Â°&quot; id=&quot;turnLeft&quot; /&gt;
        &lt;input type=&quot;button&quot; value=&quot;å³è½¬ 90Â°&quot; id=&quot;turnRight&quot; /&gt;
    &lt;/div&gt;
    &lt;div class=&quot;image&quot;&gt;
        &lt;img id=&quot;fruit&quot; src=&quot;fruit.jpg&quot; class=&quot;image&quot; alt=&quot;fruit&quot; title=&quot;fruit&quot; /&gt;
    &lt;/div&gt;
    &lt;script src=&quot;imageRotate.js&quot;&gt;&lt;/script&gt;
&lt;/body&gt;

&lt;/html&gt;
</code></pre>
<p>imageRotate.jsï¼š</p>
<pre><code class="language-js">document.querySelector('#turnLeft' ).addEventListener('click', e =&gt; rotateImage('l'))
document.querySelector('#turnRight').addEventListener('click', e =&gt; rotateImage('r'))

function rotateImage(direction = 'l') {
    // 1. Prepare ImageData
    let img = document.querySelector('#fruit')
    const { width: W, height: H } = img
    let cvs = document.createElement('canvas')
    cvs.width = W
    cvs.height = H
    let ctx = cvs.getContext('2d')
    ctx.drawImage(img, 0, 0)
    let imgDt0 = ctx.getImageData(0, 0, W, H)
    let imgDt1 = new ImageData(H, W)
    let imgDt2 = new ImageData(H, W)
    let dt0 = imgDt0.data
    let dt1 = imgDt1.data
    let dt2 = imgDt2.data

    // 2. Transpose
    let r = r1 = 0  // index of red pixel in old and new ImageData, respectively
    for (let y = 0, lenH = H; y &lt; lenH; y++) {
        for (let x = 0, lenW = W; x &lt; lenW; x++) {
            r  = (x + lenW * y) * 4
            r1 = (y + lenH * x) * 4
            dt1[r1 + 0] = dt0[r + 0]
            dt1[r1 + 1] = dt0[r + 1]
            dt1[r1 + 2] = dt0[r + 2]
            dt1[r1 + 3] = dt0[r + 3]
        }
    }
    
    // 3. Reverse width / height
    for (let y = 0, lenH = W; y &lt; lenH; y++) {
        for (let x = 0, lenW = H; x &lt; lenW; x++) {
            r  = (x + lenW * y) * 4
            r1 = direction === 'l'
                ? (x + lenW * (lenH - 1 - y)) * 4
                : ((lenW - 1 - x) + lenW * y) * 4
            dt2[r1 + 0] = dt1[r + 0]
            dt2[r1 + 1] = dt1[r + 1]
            dt2[r1 + 2] = dt1[r + 2]
            dt2[r1 + 3] = dt1[r + 3]
        }
    }
    
    // 4. Redraw image
    cvs.width = H
    cvs.height = W
    ctx.clearRect(0, 0, W, H)
    ctx.putImageData(imgDt2, 0, 0, 0, 0, H, W)
    img.src = cvs.toDataURL('image/jpeg', 1)
}
</code></pre>
<p>è¿è¡Œç»“æœï¼š<br>
åŸå§‹å›¾ç‰‡<br>
<img src="https://weidadeda.github.io/post-images/1647858200595.png" alt="" loading="lazy"><br>
å·¦è½¬90åº¦<br>
<img src="https://weidadeda.github.io/post-images/1647858207477.png" alt="" loading="lazy"><br>
å³è½¬90åº¦<br>
<img src="https://weidadeda.github.io/post-images/1647858214763.png" alt="" loading="lazy"></p>
<p>å¥½äº†ï¼Œç°åœ¨å®ç°äº†å›¾ç‰‡æ—‹è½¬ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥ç€å¥—ç”¨å…¬å¼å®ç°å›¾ç‰‡é•œåƒå’Œè§†é¢‘é•œåƒ</p>
<p>html</p>
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot; /&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot; /&gt;
    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;ie=edge&quot; /&gt;
    &lt;title&gt;jsé€šè¿‡æµè§ˆå™¨è°ƒç”¨æ‘„åƒå¤´&lt;/title&gt;
    &lt;style&gt;
    #video {
        /* transform: rotate3d(1, 1, 1, 45deg); */
    }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div class=&quot;banner&quot;&gt;
    &lt;video id=&quot;video&quot; width=&quot;500px&quot; height=&quot;500px&quot; autoplay=&quot;autoplay&quot; /&gt;
    &lt;/div&gt;
    &lt;canvas width=&quot;500&quot; height=&quot;500&quot; id=&quot;canvas&quot;&gt;&lt;/canvas&gt;
    &lt;video
    id=&quot;video2&quot;
    width=&quot;500px&quot;
    height=&quot;500px&quot;
    autoplay=&quot;autoplay&quot;
    controls=&quot;controls&quot;
    /&gt;
&lt;/body&gt;
&lt;!-- &lt;script src=&quot;./test.js&quot;&gt;&lt;/script&gt; --&gt;
&lt;script&gt;
    function getMedia() {
    let video = document.getElementById(&quot;video&quot;);
    let constraints = {
        video: { width: 500, height: 500 },
        audio: false,
    };
    navigator.getUserMedia =
        navigator.getUserMedia ||
        navigator.webkitGetUserMedia ||
        navigator.mozGetUserMedia ||
        navigator.msGetUserMedia;
    let promise = navigator.mediaDevices.getUserMedia(
        constraints,
        function (stream) {
        video.src = stream;
        video.play();
        },
        function (error) {
        console.log(error);
        }
    );
    promise.then(function (MediaStream) {
        video.srcObject = MediaStream;
        video.play();
    });
    }

    getMedia();
    window.onload = () =&gt; {
    const data = [];
    var recorder;
    // è·å–è§†é¢‘æµä¹‹åï¼Œç”¨canvaså¯¹è§†é¢‘è¿›è¡Œåè½¬ï¼Œç„¶åä½¿ç”¨captureStreamè·å–è§†é¢‘æµï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡å£°ç½‘è‡ªå®šä¹‰æµè·å–è§†é¢‘è½¨é“getVideoTracksã€‚ä»£ç ä¸­ä¸ºäº†æµ‹è¯•canvasè½¬è§†é¢‘å¯ç”¨ï¼Œè°ƒç”¨äº†MediaRecorderå½•åˆ¶
    function imageDataHRevert(sourceData, newData) {
        for (var i = 0, h = sourceData.height; i &lt; h; i++) {
        for (j = 0, w = sourceData.width; j &lt; w; j++) {
            newData.data[i * w * 4 + j * 4 + 0] =
            // (y*W+x)*4
            sourceData.data[i * w * 4 + (w - j) * 4  -4+ 0];
            // (y*W+(W-x-1))*4
            newData.data[i * w * 4 + j * 4 + 1] =
            sourceData.data[i * w * 4 + (w - j) * 4 -4+ 1];

            newData.data[i * w * 4 + j * 4 + 2] =
            sourceData.data[i * w * 4 + (w - j) * 4 -4+ 2];

            newData.data[i * w * 4 + j * 4 + 3] =
            sourceData.data[i * w * 4 + (w - j) * 4-4 + 3];
        }
        }
        return newData;
    }
    function imageDataVRevert(sourceData, newData) {
        for (var i = 0, h = sourceData.height; i &lt; h; i++) {
        for (var j = 0, w = sourceData.width; j &lt; w; j++) {
            newData.data[i * w * 4 + j * 4 + 0] =
            sourceData.data[(h - i) * w * 4 + j * 4 + 0];

            newData.data[i * w * 4 + j * 4 + 1] =
            sourceData.data[(h - i) * w * 4 + j * 4 + 1];

            newData.data[i * w * 4 + j * 4 + 2] =
            sourceData.data[(h - i) * w * 4 + j * 4 + 2];

            newData.data[i * w * 4 + j * 4 + 3] =
            sourceData.data[(h - i) * w * 4 + j * 4 + 3];
        }
        }

        return newData;
    }

    function render() {
        var canvas = document.getElementById(&quot;canvas&quot;);
        var video = document.getElementById(&quot;video&quot;);
        var ctx1 = canvas.getContext(&quot;2d&quot;);
        ctx1.drawImage(video, 0, 0, 500, 500);
        var imgData = ctx1.getImageData(0, 0, 500, 500);
        var newImgData = ctx1.getImageData(0, 0, 500, 500);
        const HRevet = imageDataHRevert(newImgData, imgData);
        console.error(HRevet, &quot;HRevet&quot;);
        // äº®ä¸€ç‚¹
        for (var i = 0; i &lt; HRevet.data.length; i += 4) {
        HRevet.data[i] += 5;
        HRevet.data[i + 1] += 5;
        HRevet.data[i + 2] += 5;
        }
        ctx1.putImageData(HRevet, 0, 0);
        requestAnimationFrame(render);
    }
    requestAnimationFrame(render);
    const stream = canvas.captureStream(30);
    // todo è‡ªå®šä¹‰è§†é¢‘ canvas.captureStream(30).getVideoTracks()[0]
    console.error(stream, &quot;stream&quot;);
    // è‡ªå·±æµ‹è¯•å½•åˆ¶è§†é¢‘çš„ï¼Œå¯ä»¥ä¸ç”¨çœ‹
    recorder = new MediaRecorder(stream, { mimeType: &quot;video/webm&quot; });
    recorder.ondataavailable = function (event) {
        if (event.data &amp;&amp; event.data.size) {
        data.push(event.data);
        }
    };
    recorder.onstop = () =&gt; {
        const url = URL.createObjectURL(new Blob(data, { type: &quot;video/webm&quot; }));
        document.getElementById(&quot;video2&quot;).src = url;
    };
    recorder.start();
    setTimeout(() =&gt; {
        recorder.stop();
    }, 6000);
    };
&lt;/script&gt;
&lt;/html&gt;
</code></pre>
<p>ç»“æœï¼š<br>
<img src="https://weidadeda.github.io/post-images/1647859629847.png" alt="" loading="lazy"></p>
]]></summary>
        <content type="html"><![CDATA[<p>æœ€è¿‘åœ¨æè§†é¢‘ç›´æ’­ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªåŠŸèƒ½æ˜¯è§†é¢‘é•œåƒï¼Œé‚£ä¹ˆæœ‰ä¸¤ç§å®ç°æ–¹å¼ã€‚<br>
ä¸€ç§æ˜¯è€å¸ˆç«¯ç‚¹å‡»é•œåƒï¼Œé€šè¿‡cssæŠŠè‡ªå·±çš„videoæ ‡ç­¾é•œåƒï¼Œç„¶åå‘é€ä¿¡ä»¤ç»™å­¦ç”Ÿç«¯ï¼Œå­¦ç”Ÿç«¯æ”¶åˆ°æ¶ˆæ¯ä¹‹åä¹Ÿé€šè¿‡csså»å®ç°é•œåƒï¼›<br>
ç¬¬äºŒç§å°±æ˜¯è€å¸ˆç«¯å¯¹è§†é¢‘æµåšä¸€ä¸ªé•œåƒå¤„ç†ï¼Œå­¦ç”Ÿç«¯æ— éœ€æ“ä½œï¼Œå¾ˆæ˜¾ç„¶ç¬¬äºŒç§æ–¹æ³•æ¯”è¾ƒå¥½ï¼›</p>
<p>æ€ä¹ˆå®ç°å¯¹è§†é¢‘æµçš„é•œåƒå‘¢ï¼Œé¦–å…ˆè¦çŸ¥é“çš„å°±æ˜¯è§†é¢‘æ˜¯ç”±ä¸€å¸§å¸§çš„å›¾ç‰‡ç»„åˆè€Œæˆï¼Œæˆ‘ä»¬è¦å¯¹è§†é¢‘æµé•œåƒï¼Œé¦–å…ˆè¦å¯¹å›¾ç‰‡è¿›è¡Œé•œåƒã€‚</p>
<p>å¯¹å›¾ç‰‡é•œåƒçš„è¯ï¼Œå°±è¦å¯¹ImageDataåšå¤„ç†<br>
é¦–å…ˆäº†è§£ä¸€ä¸‹ä»€ä¹ˆæ˜¯ImageDataï¼š</p>
<blockquote>
<p>ImageData æ¥å£æè¿° canvas å…ƒç´ çš„ä¸€ä¸ªéšå«åƒç´ æ•°æ®çš„åŒºåŸŸã€‚ä½¿ç”¨ ImageData() æ„é€ å‡½æ•°åˆ›å»ºæˆ–è€…ä½¿ç”¨å’Œ canvas åœ¨ä¸€èµ·çš„ CanvasRenderingContext2D å¯¹è±¡çš„åˆ›å»ºæ–¹æ³•ï¼š createImageData() å’Œ getImageData()ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨ putImageData() è®¾ç½® canvas çš„ä¸€éƒ¨åˆ†ã€‚</p>
</blockquote>
<h4 id="æˆ‘ä»¬å…ˆä»¥æ—‹è½¬å›¾ç‰‡ä¸ºä¾‹å­åšä¸ªè¯´æ˜">æˆ‘ä»¬å…ˆä»¥æ—‹è½¬å›¾ç‰‡ä¸ºä¾‹å­åšä¸ªè¯´æ˜</h4>
<h5 id="åŸºæœ¬åŸç†1åƒç´ çŸ©é˜µå˜æ¢">åŸºæœ¬åŸç†1â€”â€”åƒç´ çŸ©é˜µå˜æ¢</h5>
<p>ImageDataå¯¹è±¡ä¸­å­˜å‚¨ç€canvaså¯¹è±¡çœŸå®çš„åƒç´ æ•°æ®ï¼Œå®ƒåŒ…å«ä»¥ä¸‹å‡ ä¸ªåªè¯»å±æ€§ï¼š</p>
<ul>
<li>width  å›¾ç‰‡å®½åº¦ï¼Œå•ä½æ˜¯åƒç´ </li>
<li>height  å›¾ç‰‡é«˜åº¦ï¼Œå•ä½æ˜¯åƒç´ </li>
<li>data  <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Uint8ClampedArray">Uint8ClampedArray</a>ç±»å‹çš„ä¸€ç»´æ•°ç»„ï¼ŒåŒ…å«ç€RGBAæ ¼å¼çš„æ•´å‹æ•°æ®ï¼ŒèŒƒå›´åœ¨0è‡³255ä¹‹é—´ï¼ˆåŒ…æ‹¬255ï¼‰ã€‚<br>
dataå±æ€§è¿”å›ä¸€ä¸ª Uint8ClampedArrayï¼Œå®ƒå¯ä»¥è¢«ä½¿ç”¨ä½œä¸ºæŸ¥çœ‹åˆå§‹åƒç´ æ•°æ®ã€‚æ¯ä¸ªåƒç´ ç”¨4ä¸ª1byteså€¼(æŒ‰ç…§çº¢ï¼Œç»¿ï¼Œè“å’Œé€æ˜å€¼çš„é¡ºåº; è¿™å°±æ˜¯&quot;RGBA&quot;æ ¼å¼) æ¥ä»£è¡¨ã€‚æ¯ä¸ªé¢œè‰²å€¼éƒ¨ä»½ç”¨0è‡³255æ¥ä»£è¡¨ã€‚æ¯ä¸ªéƒ¨ä»½è¢«åˆ†é…åˆ°ä¸€ä¸ªåœ¨æ•°ç»„å†…è¿ç»­çš„ç´¢å¼•ï¼Œå·¦ä¸Šè§’åƒç´ çš„çº¢è‰²éƒ¨ä»½åœ¨æ•°ç»„çš„ç´¢å¼•0ä½ç½®ã€‚åƒç´ ä»å·¦åˆ°å³è¢«å¤„ç†ï¼Œç„¶åå¾€ä¸‹ï¼Œéå†æ•´ä¸ªæ•°ç»„ã€‚</li>
</ul>
<p>å…·ä½“è¯·çœ‹<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Canvas_API/Tutorial/Pixel_manipulation_with_canvas">åƒç´ æ“ä½œ</a></p>
<p>æˆ‘ä»¬é€šè¿‡ImageDataå¯ä»¥å¯¹å›¾ç‰‡çš„æ¯ä¸ªåƒç´ ç‚¹åšæ“ä½œã€‚æ¯”å¦‚æˆ‘ä»¬ç°åœ¨è¦å°†å›¾ç‰‡å‘å³æ—‹è½¬90åº¦</p>
<p>ä¸€ä¸ª 4 Ã— 3 åƒç´ çš„åŸå§‹å›¾ç‰‡ï¼Œå¯ä»¥çœ‹ä½œå¦‚ä¸‹å½¢å¼çš„åƒç´ çŸ©é˜µ Aï¼š<br>
<img src="https://weidadeda.github.io/post-images/1647858122464.png" alt="" loading="lazy"><br>
å›¾ç‰‡å‘å³æ—‹è½¬ 90Â°ï¼Œå®è´¨å°±æ˜¯è®¾æ³•å°† A å˜ä¸º Aâ€™ â€”â€”<br>
<img src="https://weidadeda.github.io/post-images/1647858132107.png" alt="" loading="lazy"><br>
è¿™å¯ä»¥é€šè¿‡åŸçŸ©é˜µä¸€æ¬¡ è½¬ç½®ã€ä¸å¤šæ¬¡åˆç­‰ åˆ— å˜æ¢ï¼ˆé€†åºæ’åˆ—å„åˆ—ï¼‰å¾—åˆ°ï¼š<br>
<img src="https://weidadeda.github.io/post-images/1647858162556.png" alt="" loading="lazy"><br>
åŒç†ï¼Œå›¾ç‰‡å‘å·¦æ—‹è½¬ 90Â°ï¼Œå®é™…ä¸Šå°±æ˜¯å¾—åˆ°çŸ©é˜µ Aâ€™' ï¼š<br>
<img src="https://weidadeda.github.io/post-images/1647858170777.png" alt="" loading="lazy"><br>
è¿™å¯ä»¥é€šè¿‡åŸçŸ©é˜µä¸€æ¬¡ è½¬ç½®ã€ä¸å¤šæ¬¡åˆç­‰ è¡Œ å˜æ¢ï¼ˆé€†åºæ’åˆ—å„è¡Œï¼‰å¾—åˆ°â€”â€”<br>
<img src="https://weidadeda.github.io/post-images/1647858177575.png" alt="" loading="lazy"></p>
<h5 id="åŸºæœ¬åŸç†2åƒç´ æ•°ç»„ä¸çŸ©é˜µçš„å¯¹åº”å…³ç³»">åŸºæœ¬åŸç†2â€”â€”åƒç´ æ•°ç»„ä¸çŸ©é˜µçš„å¯¹åº”å…³ç³»</h5>
<p>ç”±äº ImageData.data å¯¹åº”ä¸€ä¸ªæ•°ç»„ï¼Œå¯¹äº 4 Ã— 3 çš„å›¾ç‰‡è€Œè¨€ï¼ŒImageData.data å°±æ˜¯ä¸€ä¸ªå…·æœ‰ 48 ä¸ªå…ƒç´ çš„æ•°ç»„ Dï¼Œä¸å¦¨æ¯ä¸ªå…ƒç´ çš„å€¼å°±æ˜¯å…¶ä¸‹æ ‡å€¼ï¼Œåˆ™ï¼š</p>
<pre><code class="language-js">D=[0,1,2,3,4,5,6,7...44,45,46,47]
</code></pre>
<p>å…¶ä¸­ï¼š<br>
å…ƒç»„ (0, 1, 2, 3) è¡¨ç¤ºç¬¬ 1(= 0 / 4 + 1) ä¸ªåƒç´ çš„é¢œè‰²ä¸º rgba(0, 1, 2, 3/255)ï¼›<br>
å…ƒç»„ (4, 5, 6, 7) è¡¨ç¤ºç¬¬ 2(= 4 / 4 + 1) ä¸ªåƒç´ çš„é¢œè‰²ä¸º rgba(4, 5, 6, 7/255)ï¼›<br>
å…ƒç»„ (8, 9, 10, 11) è¡¨ç¤ºç¬¬ 3(= 8 / 4 + 1) ä¸ªåƒç´ çš„é¢œè‰²ä¸º rgba(8, 9, 10, 11/255)ï¼›<br>
â€¦</p>
<p>å…ƒç»„ (i, i+1, i+2, i+3) è¡¨ç¤ºç¬¬ (i / 4 + 1) ä¸ªåƒç´ çš„é¢œè‰²ä¸º rgba(i, i+1, i+2, (i+3)/255)ï¼›<br>
â€¦<br>
å…ƒç»„ (44, 45, 46, 47) è¡¨ç¤ºç¬¬ 12(= 44 / 4 + 1) ä¸ªåƒç´ çš„é¢œè‰²ä¸º rgba(44, 45, 46, 47/255)ã€‚</p>
<p>å¯è§ä» 0 å¼€å§‹éå† D æ•°ç»„ï¼Œæ¯æ¬¡é€’å¢ 4 ä¸ªå•ä½ï¼Œå³å¯ä¾æ¬¡å¾—åˆ°å„ä¸ªåƒç´ çš„çº¢è‰²å€¼ Rï¼Œå†ä¾æ¬¡åŠ 1ã€åŠ 2ã€åŠ 3ï¼Œå³å¾—åˆ°å¯¹åº”çš„ç»¿è‰²å€¼ Gã€è“è‰²å€¼ Bã€ç­‰æ•ˆ Î± é€šé“å€¼ Aã€‚</p>
<p>åä¹‹ï¼Œå¦‚æœçŸ¥é“å›¾ç‰‡çš„åƒç´ å°ºå¯¸ä¸º 4 Ã— 3ï¼Œåˆ™å¯ä»¥é€šè¿‡ä¸‹å›¾æ‰¾åˆ°æ•°ç»„ D çš„å„ä¸ªå…ƒç´ ï¼š<br>
<img src="https://weidadeda.github.io/post-images/1647858189293.png" alt="" loading="lazy"></p>
<p>å¯è§å„åƒç´ ç‚¹æ˜¯æŒ‰ç…§ ä»å·¦è‡³å³ã€ä»ä¸Šè‡³ä¸‹ çš„é¡ºåºæ’åˆ—çš„ã€‚è®¾å›¾ç‰‡æ€»å®½åº¦åƒç´ ä¸º Wï¼Œæ€»é«˜åº¦åƒç´ ä¸º Hï¼Œä»»ä¸€åƒç´ ç‚¹ P çš„åæ ‡ä¸º (x, y)ï¼ŒP çš„çº¢è‰²å€¼åœ¨æ•°ç»„ D çš„ä¸‹æ ‡ä¸º R(x, y)ï¼Œåˆ™ï¼š</p>
<pre><code class="language-js">R(x,y)=(x+W*y)Ã—4
</code></pre>
<p>éªŒè¯ï¼šï¼ˆx ä¸ y å‡ä» 0 å¼€å§‹è®¡æ•°ï¼‰</p>
<p>R(2, 1) = (2 + 1 Ã— 4) Ã— 4 = 24<br>
R(1, 2) = (1 + 2 Ã— 4) Ã— 4 = 36<br>
R(3, 1) = (3 + 1 Ã— 4) Ã— 4 = 28</p>
<p>æ‹¿åˆ°äº† R(x, y)ï¼Œä¸éš¾æ±‚å‡ºè¯¥åƒç´ çš„çºµå‘ä¸­å¿ƒå¯¹ç§°åƒç´  Rh(x, y)ã€æ¨ªå‘ä¸­å¿ƒå¯¹ç§°åƒç´  Rw(x, y)ã€ä»¥åŠä¸»å¯¹è§’çº¿å¯¹ç§°åƒç´  Rd(x, y)ï¼š</p>
<pre><code class="language-js">Rh(x,y)=[x+W*(Hâˆ’1âˆ’y)]*4 // åˆç­‰è¡Œå˜æ¢
Rw(x,y)=[(Wâˆ’1âˆ’x)+W*y]*4 // åˆç­‰åˆ—å˜æ¢
Rd(x,y)=(y+H*x)*4
</code></pre>
<h5 id="å…·ä½“å®ç°">å…·ä½“å®ç°</h5>
<p>åŸºæœ¬æ€è·¯ï¼š</p>
<ul>
<li>é€šè¿‡ canvas è·å–ç›®æ ‡å›¾ç‰‡çš„ ImageData å¯¹è±¡ï¼›</li>
<li>è½¬ç½®åŸå›¾ç‰‡æ•°ç»„ï¼Œå¾—åˆ°æ•°ç»„ ATï¼›</li>
<li>å¯¹ AT æ‰§è¡Œä¸€ç»„åˆç­‰è¡Œå˜æ¢ï¼Œä½¿å„è¡Œé€†åºæ’åˆ—ï¼Œå¾—åˆ°å·¦æ—‹ 90Â° æ•ˆæœï¼›</li>
<li>å¯¹ AT æ‰§è¡Œä¸€ç»„åˆç­‰åˆ—å˜æ¢ï¼Œä½¿å„åˆ—é€†åºæ’åˆ—ï¼Œå¾—åˆ°å³æ—‹ 90Â° æ•ˆæœï¼›</li>
<li>å°†æ–°çš„åƒç´ æ•°ç»„å†™å›å›¾ç‰‡æºæ ‡ç­¾ã€‚</li>
</ul>
<p>HTMLï¼š</p>
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;title&gt;Rotate by ImageData&lt;/title&gt;
    &lt;style&gt;
        .image{ margin-top: 5px; }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div class=&quot;btns&quot;&gt;
        &lt;input type=&quot;button&quot; value=&quot;å·¦è½¬ 90Â°&quot; id=&quot;turnLeft&quot; /&gt;
        &lt;input type=&quot;button&quot; value=&quot;å³è½¬ 90Â°&quot; id=&quot;turnRight&quot; /&gt;
    &lt;/div&gt;
    &lt;div class=&quot;image&quot;&gt;
        &lt;img id=&quot;fruit&quot; src=&quot;fruit.jpg&quot; class=&quot;image&quot; alt=&quot;fruit&quot; title=&quot;fruit&quot; /&gt;
    &lt;/div&gt;
    &lt;script src=&quot;imageRotate.js&quot;&gt;&lt;/script&gt;
&lt;/body&gt;

&lt;/html&gt;
</code></pre>
<p>imageRotate.jsï¼š</p>
<pre><code class="language-js">document.querySelector('#turnLeft' ).addEventListener('click', e =&gt; rotateImage('l'))
document.querySelector('#turnRight').addEventListener('click', e =&gt; rotateImage('r'))

function rotateImage(direction = 'l') {
    // 1. Prepare ImageData
    let img = document.querySelector('#fruit')
    const { width: W, height: H } = img
    let cvs = document.createElement('canvas')
    cvs.width = W
    cvs.height = H
    let ctx = cvs.getContext('2d')
    ctx.drawImage(img, 0, 0)
    let imgDt0 = ctx.getImageData(0, 0, W, H)
    let imgDt1 = new ImageData(H, W)
    let imgDt2 = new ImageData(H, W)
    let dt0 = imgDt0.data
    let dt1 = imgDt1.data
    let dt2 = imgDt2.data

    // 2. Transpose
    let r = r1 = 0  // index of red pixel in old and new ImageData, respectively
    for (let y = 0, lenH = H; y &lt; lenH; y++) {
        for (let x = 0, lenW = W; x &lt; lenW; x++) {
            r  = (x + lenW * y) * 4
            r1 = (y + lenH * x) * 4
            dt1[r1 + 0] = dt0[r + 0]
            dt1[r1 + 1] = dt0[r + 1]
            dt1[r1 + 2] = dt0[r + 2]
            dt1[r1 + 3] = dt0[r + 3]
        }
    }
    
    // 3. Reverse width / height
    for (let y = 0, lenH = W; y &lt; lenH; y++) {
        for (let x = 0, lenW = H; x &lt; lenW; x++) {
            r  = (x + lenW * y) * 4
            r1 = direction === 'l'
                ? (x + lenW * (lenH - 1 - y)) * 4
                : ((lenW - 1 - x) + lenW * y) * 4
            dt2[r1 + 0] = dt1[r + 0]
            dt2[r1 + 1] = dt1[r + 1]
            dt2[r1 + 2] = dt1[r + 2]
            dt2[r1 + 3] = dt1[r + 3]
        }
    }
    
    // 4. Redraw image
    cvs.width = H
    cvs.height = W
    ctx.clearRect(0, 0, W, H)
    ctx.putImageData(imgDt2, 0, 0, 0, 0, H, W)
    img.src = cvs.toDataURL('image/jpeg', 1)
}
</code></pre>
<p>è¿è¡Œç»“æœï¼š<br>
åŸå§‹å›¾ç‰‡<br>
<img src="https://weidadeda.github.io/post-images/1647858200595.png" alt="" loading="lazy"><br>
å·¦è½¬90åº¦<br>
<img src="https://weidadeda.github.io/post-images/1647858207477.png" alt="" loading="lazy"><br>
å³è½¬90åº¦<br>
<img src="https://weidadeda.github.io/post-images/1647858214763.png" alt="" loading="lazy"></p>
<p>å¥½äº†ï¼Œç°åœ¨å®ç°äº†å›¾ç‰‡æ—‹è½¬ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥ç€å¥—ç”¨å…¬å¼å®ç°å›¾ç‰‡é•œåƒå’Œè§†é¢‘é•œåƒ</p>
<p>html</p>
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot; /&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot; /&gt;
    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;ie=edge&quot; /&gt;
    &lt;title&gt;jsé€šè¿‡æµè§ˆå™¨è°ƒç”¨æ‘„åƒå¤´&lt;/title&gt;
    &lt;style&gt;
    #video {
        /* transform: rotate3d(1, 1, 1, 45deg); */
    }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div class=&quot;banner&quot;&gt;
    &lt;video id=&quot;video&quot; width=&quot;500px&quot; height=&quot;500px&quot; autoplay=&quot;autoplay&quot; /&gt;
    &lt;/div&gt;
    &lt;canvas width=&quot;500&quot; height=&quot;500&quot; id=&quot;canvas&quot;&gt;&lt;/canvas&gt;
    &lt;video
    id=&quot;video2&quot;
    width=&quot;500px&quot;
    height=&quot;500px&quot;
    autoplay=&quot;autoplay&quot;
    controls=&quot;controls&quot;
    /&gt;
&lt;/body&gt;
&lt;!-- &lt;script src=&quot;./test.js&quot;&gt;&lt;/script&gt; --&gt;
&lt;script&gt;
    function getMedia() {
    let video = document.getElementById(&quot;video&quot;);
    let constraints = {
        video: { width: 500, height: 500 },
        audio: false,
    };
    navigator.getUserMedia =
        navigator.getUserMedia ||
        navigator.webkitGetUserMedia ||
        navigator.mozGetUserMedia ||
        navigator.msGetUserMedia;
    let promise = navigator.mediaDevices.getUserMedia(
        constraints,
        function (stream) {
        video.src = stream;
        video.play();
        },
        function (error) {
        console.log(error);
        }
    );
    promise.then(function (MediaStream) {
        video.srcObject = MediaStream;
        video.play();
    });
    }

    getMedia();
    window.onload = () =&gt; {
    const data = [];
    var recorder;
    // è·å–è§†é¢‘æµä¹‹åï¼Œç”¨canvaså¯¹è§†é¢‘è¿›è¡Œåè½¬ï¼Œç„¶åä½¿ç”¨captureStreamè·å–è§†é¢‘æµï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡å£°ç½‘è‡ªå®šä¹‰æµè·å–è§†é¢‘è½¨é“getVideoTracksã€‚ä»£ç ä¸­ä¸ºäº†æµ‹è¯•canvasè½¬è§†é¢‘å¯ç”¨ï¼Œè°ƒç”¨äº†MediaRecorderå½•åˆ¶
    function imageDataHRevert(sourceData, newData) {
        for (var i = 0, h = sourceData.height; i &lt; h; i++) {
        for (j = 0, w = sourceData.width; j &lt; w; j++) {
            newData.data[i * w * 4 + j * 4 + 0] =
            // (y*W+x)*4
            sourceData.data[i * w * 4 + (w - j) * 4  -4+ 0];
            // (y*W+(W-x-1))*4
            newData.data[i * w * 4 + j * 4 + 1] =
            sourceData.data[i * w * 4 + (w - j) * 4 -4+ 1];

            newData.data[i * w * 4 + j * 4 + 2] =
            sourceData.data[i * w * 4 + (w - j) * 4 -4+ 2];

            newData.data[i * w * 4 + j * 4 + 3] =
            sourceData.data[i * w * 4 + (w - j) * 4-4 + 3];
        }
        }
        return newData;
    }
    function imageDataVRevert(sourceData, newData) {
        for (var i = 0, h = sourceData.height; i &lt; h; i++) {
        for (var j = 0, w = sourceData.width; j &lt; w; j++) {
            newData.data[i * w * 4 + j * 4 + 0] =
            sourceData.data[(h - i) * w * 4 + j * 4 + 0];

            newData.data[i * w * 4 + j * 4 + 1] =
            sourceData.data[(h - i) * w * 4 + j * 4 + 1];

            newData.data[i * w * 4 + j * 4 + 2] =
            sourceData.data[(h - i) * w * 4 + j * 4 + 2];

            newData.data[i * w * 4 + j * 4 + 3] =
            sourceData.data[(h - i) * w * 4 + j * 4 + 3];
        }
        }

        return newData;
    }

    function render() {
        var canvas = document.getElementById(&quot;canvas&quot;);
        var video = document.getElementById(&quot;video&quot;);
        var ctx1 = canvas.getContext(&quot;2d&quot;);
        ctx1.drawImage(video, 0, 0, 500, 500);
        var imgData = ctx1.getImageData(0, 0, 500, 500);
        var newImgData = ctx1.getImageData(0, 0, 500, 500);
        const HRevet = imageDataHRevert(newImgData, imgData);
        console.error(HRevet, &quot;HRevet&quot;);
        // äº®ä¸€ç‚¹
        for (var i = 0; i &lt; HRevet.data.length; i += 4) {
        HRevet.data[i] += 5;
        HRevet.data[i + 1] += 5;
        HRevet.data[i + 2] += 5;
        }
        ctx1.putImageData(HRevet, 0, 0);
        requestAnimationFrame(render);
    }
    requestAnimationFrame(render);
    const stream = canvas.captureStream(30);
    // todo è‡ªå®šä¹‰è§†é¢‘ canvas.captureStream(30).getVideoTracks()[0]
    console.error(stream, &quot;stream&quot;);
    // è‡ªå·±æµ‹è¯•å½•åˆ¶è§†é¢‘çš„ï¼Œå¯ä»¥ä¸ç”¨çœ‹
    recorder = new MediaRecorder(stream, { mimeType: &quot;video/webm&quot; });
    recorder.ondataavailable = function (event) {
        if (event.data &amp;&amp; event.data.size) {
        data.push(event.data);
        }
    };
    recorder.onstop = () =&gt; {
        const url = URL.createObjectURL(new Blob(data, { type: &quot;video/webm&quot; }));
        document.getElementById(&quot;video2&quot;).src = url;
    };
    recorder.start();
    setTimeout(() =&gt; {
        recorder.stop();
    }, 6000);
    };
&lt;/script&gt;
&lt;/html&gt;
</code></pre>
<p>ç»“æœï¼š<br>
<img src="https://weidadeda.github.io/post-images/1647859629847.png" alt="" loading="lazy"></p>
<!-- more -->
<h5 id="å¤§å®¶çœ‹çš„å¯èƒ½æœ‰ç‚¹æ‡µæ²¡å…³ç³»æ‹¿ä¸ªçº¸ç”»ä¸€ä¸‹ç„¶åå»å¥—ç”¨å…¬å¼å°±å¥½äº†ä¸€æ¬¡ä¸æ‡‚å°±å¤šè¯•å‡ æ¬¡-çœ‹ä¸æ‡‚ä¸€å®šè¦æ‹¿å¼ çº¸ç”»ä¸€ä¸‹">å¤§å®¶çœ‹çš„å¯èƒ½æœ‰ç‚¹æ‡µï¼Œæ²¡å…³ç³»ï¼Œæ‹¿ä¸ªçº¸ç”»ä¸€ä¸‹ï¼Œç„¶åå»å¥—ç”¨å…¬å¼å°±å¥½äº†ï¼Œä¸€æ¬¡ä¸æ‡‚å°±å¤šè¯•å‡ æ¬¡ã€‚çœ‹ä¸æ‡‚ä¸€å®šè¦æ‹¿å¼ çº¸ç”»ä¸€ä¸‹ï¼</h5>
<p>ç®€å•çš„å¢åŠ ç¾ç™½æ•ˆæœï¼ˆäº®åº¦ï¼‰ï¼Œå¯ç»™æ¯ä¸ªrgbé€šé“åŠ ç‰¹å®šå€¼ã€‚</p>
<pre><code class="language-js">r1 = (x + W * y) * 4;
r1 = (x + W * (H - 1 - y)) * 4;
</code></pre>
<p>æ¨èä¸€ä¸ªç¾é¢œåº“ï¼šopencvjs<br>
æ¨èä¸€ä¸ªäººè„¸è¯†åˆ«åº“ï¼šface-api.js https://www.cnblogs.com/neozhu/p/11771148.html</p>
<p>éƒ¨åˆ†å†…å®¹å‚è€ƒè‡ª https://blog.csdn.net/frgod/article/details/106055830</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Taroè§£å†³å°ç¨‹åºåŒ…ä½“ç§¯è¿‡å¤§çš„é—®é¢˜]]></title>
        <id>https://weidadeda.github.io/post/taro-jie-jue-xiao-cheng-xu-bao-ti-ji-guo-da-de-wen-ti</id>
        <link href="https://weidadeda.github.io/post/taro-jie-jue-xiao-cheng-xu-bao-ti-ji-guo-da-de-wen-ti">
        </link>
        <updated>2022-03-01T12:27:38.000Z</updated>
        <content type="html"><![CDATA[<figure data-type="image" tabindex="1"><img src="https://weidadeda.github.io/post-images/1646137679298.png" alt="" loading="lazy"></figure>
<blockquote>
<p>ç›®å‰å°ç¨‹åºåˆ†åŒ…å¤§å°æœ‰ä»¥ä¸‹é™åˆ¶ï¼š<br>
æ•´ä¸ªå°ç¨‹åºæ‰€æœ‰åˆ†åŒ…å¤§å°ä¸è¶…è¿‡ 8M<br>
å•ä¸ªåˆ†åŒ…/ä¸»åŒ…å¤§å°ä¸èƒ½è¶…è¿‡ 2M</p>
</blockquote>
<p>æ‰€ä»¥è¯´8Mçš„é™åˆ¶æ˜¯è¦åˆ†åŒ…è‡³å°‘4ä¸ªåŒ…ï¼Œå•ä¸ªåˆ†åŒ…ä¸Šé™å…¶å®è¿˜æ˜¯2M</p>
<h3 id="è§£å†³è¿™ä¸ªé—®é¢˜ä¸€ç§æ˜¯åˆ†åŒ…">è§£å†³è¿™ä¸ªé—®é¢˜ä¸€ç§æ˜¯åˆ†åŒ…</h3>
<p>å®˜æ–¹ç»™å‡ºçš„åˆ†åŒ…<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/subpackages/basic.html">å®˜ç½‘æ–‡æ¡£</a></p>
<h3 id="å¦ä¸€ç§æ˜¯å‡å°‘åŒ…ä¸­çš„å›¾ç‰‡">å¦ä¸€ç§æ˜¯å‡å°‘åŒ…ä¸­çš„å›¾ç‰‡</h3>
<p>å…¶å®é€ æˆåŒ…ä½“ç§¯è¿‡å¤§çš„å› ç´ ï¼Œå¾ˆå¤§åŸå› æ˜¯å› ä¸ºåŒ…é‡Œæœ‰å›¾ç‰‡ï¼Œé‚£ä½“ç§¯å°±ä¼šå˜å¾—å¾ˆå¤§ã€‚é‚£æˆ‘ä»¬å¯ä»¥å°†å›¾ç‰‡ä¸Šä¼ åˆ°CDNä¸Šï¼Œå˜æˆç½‘ç»œé“¾æ¥ï¼Œè¿™æ ·çš„è¯å°±ä¸ä¼šæŠŠå›¾ç‰‡æ‰“åŒ…è¿›å»äº†ã€‚ä½†æ˜¯è¿™æ ·åˆæœ‰ä¸€ä¸ªä¸è¶³ï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬ä¸€å¼€å§‹å¼€å‘é¡¹ç›®çš„æ—¶å€™ï¼ŒUIåŒå­¦ç»™äº†æˆ‘ä»¬è®¾è®¡å›¾ï¼Œé‚£æˆ‘ä»¬è¦å°†å›¾ç‰‡ä¸€å¼ å¼ çš„ä¸Šä¼ åˆ°CDNä¸Šå»å—ï¼Ÿå¦‚æœåæœŸUIèµ°æŸ¥çš„æ—¶å€™è¦æ¢å›¾ç‰‡å‘¢ï¼Ÿè€Œä¸”ä¸‡ä¸€CDNä¸Šçš„å›¾ç‰‡è¢«äººè¯¯åˆ äº†æˆ–è€…æœåŠ¡åˆ°æœŸäº†å‘¢ï¼ˆå½“ç„¶è¿™ç§å¯èƒ½æ€§å¾ˆå°ï¼Œä½†ä¹Ÿå¯ä»¥è€ƒè™‘è¿›å»ï¼‰ï¼Œè¿™æ—¶å€™æˆ‘ä»¬çš„åŸå›¾éƒ½ä¼šæ‰¾ä¸åˆ°ï¼Œåªèƒ½å¹²ç€æ€¥ã€‚ã€‚ã€‚</p>
<h4 id="é‚£ä¹ˆæœ€å¥½çš„æ–¹å¼å°±æ˜¯å°†å›¾ç‰‡æ”¾åœ¨é¡¹ç›®ä¸­æœ¬åœ°å¼€å‘çš„æ—¶å€™å¼•ç”¨çš„å°±æ˜¯æœ¬åœ°çš„å¢åˆ æ”¹æ‰¾èµ·æ¥ä¹Ÿæ–¹ä¾¿ä½†æ˜¯æ‰“åŒ…æ„å»ºçš„æ—¶å€™å°†å›¾ç‰‡å‹ç¼©å¹¶ä¸Šä¼ cdnåŒæ—¶å°†é¡¹ç›®ä¸­çš„å›¾ç‰‡å¼•ç”¨è·¯å¾„æ”¹æˆç½‘ç»œé“¾æ¥ç„¶ååˆ é™¤distä¸­çš„æ‰€æœ‰å›¾ç‰‡-é‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬å°±å†™ä¸ªè„šæœ¬å®ç°ä¸€ä¸‹">é‚£ä¹ˆæœ€å¥½çš„æ–¹å¼å°±æ˜¯å°†å›¾ç‰‡æ”¾åœ¨é¡¹ç›®ä¸­ï¼Œæœ¬åœ°å¼€å‘çš„æ—¶å€™å¼•ç”¨çš„å°±æ˜¯æœ¬åœ°çš„ï¼Œå¢åˆ æ”¹æ‰¾èµ·æ¥ä¹Ÿæ–¹ä¾¿ï¼Œä½†æ˜¯æ‰“åŒ…æ„å»ºçš„æ—¶å€™å°†å›¾ç‰‡å‹ç¼©å¹¶ä¸Šä¼ CDNï¼ŒåŒæ—¶å°†é¡¹ç›®ä¸­çš„å›¾ç‰‡å¼•ç”¨è·¯å¾„æ”¹æˆç½‘ç»œé“¾æ¥ï¼Œç„¶ååˆ é™¤distä¸­çš„æ‰€æœ‰å›¾ç‰‡ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬å°±å†™ä¸ªè„šæœ¬å®ç°ä¸€ä¸‹ã€‚</h4>
<p>ç›´æ¥ä¸Šä»£ç å§</p>
<h4 id="å…ˆå†™ä¸Šä¼ æ–¹æ³•ç”¨äºæ‰“åŒ…å®Œä¸Šä¼ å…ˆå‹ç¼©å†ä¸Šä¼ åˆ°é˜¿é‡Œoss">å…ˆå†™ä¸Šä¼ æ–¹æ³•ï¼Œç”¨äºæ‰“åŒ…å®Œä¸Šä¼ ï¼Œå…ˆå‹ç¼©å†ä¸Šä¼ åˆ°é˜¿é‡Œoss</h4>
<pre><code class="language-js">// config/upload.js
const OSS = require(&quot;ali-oss&quot;);
const fs = require(&quot;fs&quot;);
const path = require(&quot;path&quot;);
const rimraf = require(&quot;rimraf&quot;);
const imagemin = require('imagemin')
const imageminJpegtran = require('imagemin-jpegtran')
const imageminPngquant = require('imagemin-pngquant')
const imageminSvgo = require('imagemin-svgo')
const imageminGifsicle = require('imagemin-gifsicle')

const client = new OSS({
  region: &quot;&quot;,
  endpoint: &quot;&quot;,
  accessKeyId: &quot;&quot;,
  accessKeySecret: &quot;&quot;,
  bucket: &quot;&quot;
});
async function compress() {
  const files = await imagemin(['../dist/**/*.{jpg,jpeg,png,svg,gif}'], {
    destination: '../dist/assets',
    plugins: [
      imageminJpegtran({
        progressive: true,
        quality: 80,
      }),
      imageminPngquant({
        quality: [0.6, 0.8],
      }),
      imageminSvgo({
        plugins: [{ removeViewBox: false }],
      }),
      imageminGifsicle(),
    ],
  })
  console.log('compress all images success!'.info)
  return files
}
const putOSS = async function(src, dist) {
  try {
    let result = await client.put(dist, src);
    console.log(&quot;ossä¸Šä¼ æˆåŠŸ: &quot; + result.name);
  } catch (e) {
    console.log(e);
  }
};

const workList = [];

/**
 *
 * @param {string} src éœ€è¦ä¸Šä¼ çš„æ–‡ä»¶å¤¹
 * @param {string} dist ossæ–‡ä»¶å¤¹
 */

const addFileToOSSSync = function(src, dist) {
  try {
    await compress()
    var docs = fs.readdirSync(src);
  } catch (error) {
    console.log(src + &quot;ä¸å­˜åœ¨&quot;);
    return;
  }

  docs.forEach(function(doc) {
    const _src = src + &quot;/&quot; + doc;
    const _dist = dist + &quot;/&quot; + doc;
    const st = fs.statSync(_src);
    // åˆ¤æ–­æ˜¯å¦ä¸ºæ–‡ä»¶
    if (st.isFile() &amp;&amp; doc !== &quot;.DS_Store&quot;) {
      workList.push(putOSS(_src, _dist));
      // console.log(_src + 'æ˜¯æ–‡ä»¶', _dist);
    } else if (st.isDirectory()) {
      addFileToOSSSync(_src, _dist);
    }
  });
};

addFileToOSSSync(&quot;dist/assets&quot;, &quot;weixin/gongyi/sdg/images&quot;);

Promise.all(workList).then(res =&gt; {
  rimraf(path.join(__dirname, &quot;../dist/assets&quot;), error =&gt; {
    if (error) {
      throw error;
    }
    console.log(&quot;done!&quot;);
  });
});

</code></pre>
<h4 id="ä¸Šä¼ æ–¹æ³•å†™å®Œäº†ä»€ä¹ˆæ—¶å€™è°ƒç”¨å‘¢åº”è¯¥åœ¨æ„å»ºå®Œä¹‹åè°ƒç”¨å› ä¸ºä¸Šä¼ å®Œè¦åˆ é™¤åŒ…ä¸­distä¸‹çš„å›¾ç‰‡é‚£ä¹ˆæˆ‘ä»¬åº”è¯¥packagejsonä¸­æ›´æ”¹å‘½ä»¤">ä¸Šä¼ æ–¹æ³•å†™å®Œäº†ï¼Œä»€ä¹ˆæ—¶å€™è°ƒç”¨å‘¢ï¼Œåº”è¯¥åœ¨æ„å»ºå®Œä¹‹åè°ƒç”¨ï¼Œå› ä¸ºä¸Šä¼ å®Œè¦åˆ é™¤åŒ…ä¸­distä¸‹çš„å›¾ç‰‡ï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”è¯¥package.jsonä¸­æ›´æ”¹å‘½ä»¤</h4>
<pre><code class="language-js">// package.json
&quot;build:weapp&quot;: &quot;NODE_ENV=online taro build --type weapp &amp;&amp; node config/upload.js&quot;
</code></pre>
<h4 id="è¿˜æœ‰è®¾ç½®ä¸€ä¸ªå…¨å±€å˜é‡">è¿˜æœ‰è®¾ç½®ä¸€ä¸ªå…¨å±€å˜é‡</h4>
<pre><code class="language-js">// Taroæ‰“åŒ…å…¥å£å¤„
const ossPath = 'ä½ çš„cdnåŸŸå'
let projectPublicPath = '/'

if (process.env.NODE_ENV !== 'development') {
  // ä½ ä¸Šä¼ çš„cdnè·¯å¾„
  projectPublicPath = `${ossPath}/1v1mp/${process.env.TARO_ENV}/${process.env.NODE_ENV}`
}

let assetsPre =
  process.env.TARO_ENV === 'weapp'
    ? process.env.NODE_ENV === 'development'
      ? ''
      : projectPublicPath
    : ''
var config = {
  // ...å…¶ä»–é…ç½®æ­£å¸¸å†™ï¼Œä¸»è¦æ˜¯æ³¨æ„è¿™ä¸¤é¡¹
  alias: {
    '@': path.resolve(__dirname, '..', 'src'),
  },
  defineConstants: {
    assetsPre: `&quot;${assetsPre}&quot;`,
  },
}
</code></pre>
<h4 id="æœ€åä½¿ç”¨éœ€è¦æ³¨æ„">æœ€åä½¿ç”¨éœ€è¦æ³¨æ„ï¼š</h4>
<ul>
<li>
<p>æ‰€æœ‰å›¾ç‰‡æ–‡ä»¶æ”¾å…¥<code>src/assets</code>ç›®å½•ä¸‹ï¼Œå¯ä»¥åœ¨<code>assets</code>ç›®å½•ä¸‹åˆ›å»ºå„æ¨¡å—ç›®å½•</p>
</li>
<li>
<p>ä½¿ç”¨ <code>import</code> å¼•å…¥ååœ¨<code>src</code>å¤„ä½¿ç”¨ <code>${assetsPre}${pic}</code>çš„æ–¹å¼ä½¿ç”¨, <code>assetsPre</code>æ˜¯å…¨å±€å®šä¹‰å¥½çš„å¸¸é‡ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<pre><code class="language-jsx">import pic from '@/assets/defualt.jpg'

export default function Index() {
  // do some logic

  return &lt;Image src={`${assetsPre}${pic}`} /&gt;
}
</code></pre>
</li>
</ul>
<blockquote>
<p>tip: æœ‰ä¸€ç‚¹è¦è¯´ä¸€ä¸‹ï¼Œè™½ç„¶importå¼•å…¥äº†ï¼Œä½†å…¶å®æ˜¯ä¸ªpicæ˜¯ä¸ªè·¯å¾„ï¼Œwebpack5ä»¥å‰ä¼šæŠŠå®ƒé€šè¿‡loaderè½¬ä¸ºè·¯å¾„ï¼Œwebpack5é€šè¿‡å†…ç½®Asset Modulesè½¬ä¸ºè·¯å¾„ã€‚å…·ä½“æ–‡æ¡£å¯è§ï¼š<a href="https://webpack.docschina.org/guides/asset-management/#loading-images">åŠ è½½imageså›¾åƒ</a></p>
</blockquote>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[createjs åˆ›å»ºå›¾ç‰‡ä½å›¾å¹¶è®¾ç½®ä¸­å¿ƒç‚¹ä¸ºå›¾ç‰‡ä¸­å¿ƒ]]></title>
        <id>https://weidadeda.github.io/post/createjs-chuang-jian-tu-pian-wei-tu-bing-she-zhi-zhong-xin-dian-wei-tu-pian-zhong-xin</id>
        <link href="https://weidadeda.github.io/post/createjs-chuang-jian-tu-pian-wei-tu-bing-she-zhi-zhong-xin-dian-wei-tu-pian-zhong-xin">
        </link>
        <updated>2022-02-22T03:38:28.000Z</updated>
        <content type="html"><![CDATA[<pre><code class="language-js">public static createBitmap(imgUrl: string): Promise&lt;any&gt; {
    return new Promise&lt;object | number&gt;((resolve, reject) =&gt; {
      const image: any = new Image()
      image.src = imgUrl || ''
      image.onload = () =&gt; {
        const Bitmap = new createjs.Bitmap(image)
        const { width, height } = Bitmap.image
        // Bitmap.setBounds(0, 0, width, height);
        Bitmap.regX = width / 2
        Bitmap.regY = height / 2
        resolve(Bitmap)
      }
      image.onerror = (error: any) =&gt; {
        console.warn(`&quot;image load fail&quot;${imgUrl}`, error)
      }
    })
  }
</code></pre>
<h4 id="æ³¨æ„é»˜è®¤æ³¨å†Œä¸­å¿ƒç‚¹æ—‹è½¬æ—¶å›´ç»•çš„ç‚¹æ˜¯åœ¨å·¦ä¸Šè§’regxregyå¹¶ä¸æ˜¯æ”¹å˜æ³¨å†Œä¸­å¿ƒç‚¹è€Œæ˜¯å‘å·¦ä¸Šæ–¹å‘åç§»å®½é«˜çš„ä¸€åŠä½†åªæ˜¯åç§»ç‰©ä½“è¿™ä¸ªç‰©ä½“çš„æ³¨å†Œä¸­å¿ƒç‚¹æ˜¯ä¸å˜çš„-æƒ³æ”¹å˜æ³¨å†Œä¸­å¿ƒç‚¹åªèƒ½é xyæ¥è®¾ç½®ä½ç½®æ³¨å†Œä¸­å¿ƒç‚¹æ°¸è¿œéƒ½åœ¨å·¦ä¸Šè§’ä½†é€šè¿‡regxregyå¯ä»¥æŠŠç‰©ä½“æœ¬èº«å¾€åæ–¹å‘å¹³ç§»ä¸€åŠä½†æ³¨å†Œä¸­å¿ƒç‚¹è¿˜åœ¨ä¹‹å‰çš„ä½ç½®è¿™æ ·çš„è¯æˆ‘ä»¬çš„æ—‹è½¬ä½ç½®çœ‹èµ·æ¥å°±æ˜¯å›´ç€ä¸­é—´ç‚¹æ—‹è½¬äº†-è¿™ä¹ˆè¯´å¤§å®¶å¯èƒ½æœ‰ç‚¹æ‡µæ²¡å…³ç³»è¿™é‡Œç¡®å®æœ‰ç‚¹éš¾ç†è§£~æœ‰ä¸ªåšå®¢å†™çš„å¾ˆå¥½å¤§å®¶å¯ä»¥ç»“åˆæˆ‘æ€»ç»“çš„çœ‹ä¸€ä¸‹">æ³¨æ„ï¼šé»˜è®¤æ³¨å†Œä¸­å¿ƒç‚¹ï¼ˆæ—‹è½¬æ—¶å›´ç»•çš„ç‚¹ï¼‰æ˜¯åœ¨å·¦ä¸Šè§’ï¼ŒregXï¼ŒregYå¹¶ä¸æ˜¯æ”¹å˜æ³¨å†Œä¸­å¿ƒç‚¹ï¼Œè€Œæ˜¯å‘å·¦ä¸Šæ–¹å‘åç§»å®½é«˜çš„ä¸€åŠï¼Œä½†åªæ˜¯åç§»ç‰©ä½“ï¼Œè¿™ä¸ªç‰©ä½“çš„æ³¨å†Œä¸­å¿ƒç‚¹æ˜¯ä¸å˜çš„ã€‚æƒ³æ”¹å˜æ³¨å†Œä¸­å¿ƒç‚¹ï¼Œåªèƒ½é x,yæ¥è®¾ç½®ä½ç½®ï¼Œæ³¨å†Œä¸­å¿ƒç‚¹æ°¸è¿œéƒ½åœ¨å·¦ä¸Šè§’ï¼Œä½†é€šè¿‡regXï¼ŒregYå¯ä»¥æŠŠç‰©ä½“æœ¬èº«å¾€åæ–¹å‘å¹³ç§»ä¸€åŠï¼ˆä½†æ³¨å†Œä¸­å¿ƒç‚¹è¿˜åœ¨ä¹‹å‰çš„ä½ç½®ï¼‰ï¼Œè¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬çš„æ—‹è½¬ä½ç½®çœ‹èµ·æ¥å°±æ˜¯å›´ç€ä¸­é—´ç‚¹æ—‹è½¬äº†ã€‚è¿™ä¹ˆè¯´å¤§å®¶å¯èƒ½æœ‰ç‚¹æ‡µï¼Œæ²¡å…³ç³»ï¼Œè¿™é‡Œç¡®å®æœ‰ç‚¹éš¾ç†è§£ï½æœ‰ä¸ªåšå®¢å†™çš„å¾ˆå¥½ï¼Œå¤§å®¶å¯ä»¥ç»“åˆæˆ‘æ€»ç»“çš„çœ‹ä¸€ä¸‹ï¼š</h4>
<p><a href="https://segmentfault.com/a/1190000016445744">Easeljsä¹‹regX/regYè¯¦è§£</a></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[viteè‡ªå®šä¹‰ä¸Šä¼ æ’ä»¶]]></title>
        <id>https://weidadeda.github.io/post/vite-zi-ding-yi-cha-jian</id>
        <link href="https://weidadeda.github.io/post/vite-zi-ding-yi-cha-jian">
        </link>
        <updated>2022-02-15T11:53:23.000Z</updated>
        <content type="html"><![CDATA[<p><a href="https://vitejs.cn/guide/api-plugin.html">viteå®˜ç½‘è‡ªå®šä¹‰æ’ä»¶</a></p>
<p>Vite æ’ä»¶æ‰©å±•äº†è®¾è®¡å‡ºè‰²çš„ Rollup æ¥å£ï¼Œå¸¦æœ‰ä¸€äº› Vite ç‹¬æœ‰çš„é…ç½®é¡¹ã€‚å› ä¸ºviteæ˜¯ä½¿ç”¨rollupæ‰“åŒ…çš„æ‰€ä»¥æœ€å¥½ä½ èƒ½äº†è§£<a href="https://rollupjs.org/guide/en/#plugin-development">Rollup æ’ä»¶æ–‡æ¡£</a></p>
<blockquote>
<p>ä¸‹é¢çš„éƒ½æ˜¯æŒ‰ç…§å®˜ç½‘ä»‹ç»å†™çš„ï¼Œå› ä¸ºæ¯•ç«Ÿä½ çœ‹åˆ°æˆ‘è¿™äº†ï¼Œç›´æ¥ç»™ä½ ä¸ªé“¾æ¥å†è®©ä½ è·³è½¬åˆ°å®˜ç½‘å»çœ‹æœ‰ç‚¹ä¸è´Ÿè´£ä»»ï¼Œå¦‚æœä½ å·²ç»ä»å®˜ç½‘çœ‹è¿‡äº†ï¼Œå¹¶ä¸”å¯¹è‡ªå®šä¹‰æ’ä»¶å¾ˆç†Ÿæ‚‰äº†ï¼Œé‚£ä¹ˆè¯·ç›´æ¥åˆ°æœ€ä¸‹é¢çœ‹ <a href="#test">é¡¹ç›®å®æˆ˜éƒ¨åˆ†</a></p>
</blockquote>
<h3 id="çº¦å®š">çº¦å®š</h3>
<p>å¦‚æœæ’ä»¶ä¸ä½¿ç”¨ Vite ç‰¹æœ‰çš„é’©å­ï¼Œå¯ä»¥ä½œä¸º <a href="https://vitejs.cn/guide/api-plugin.html#rollup-plugin-compatibility">å…¼å®¹ Rollup çš„æ’ä»¶</a> æ¥å®ç°ï¼Œæ¨èä½¿ç”¨ <a href="https://rollupjs.org/guide/en/#conventions">Rollup æ’ä»¶åç§°çº¦å®š</a>ã€‚</p>
<ul>
<li>Rollup æ’ä»¶åº”è¯¥æœ‰ä¸€ä¸ªå¸¦ rollup-plugin- å‰ç¼€ã€è¯­ä¹‰æ¸…æ™°çš„åç§°ã€‚</li>
<li>åœ¨ package.json ä¸­åŒ…å« rollup-plugin å’Œ vite-plugin å…³é”®å­—ã€‚</li>
</ul>
<p>è¿™æ ·ï¼Œæ’ä»¶ä¹Ÿå¯ä»¥ç”¨äºçº¯ Rollup æˆ–åŸºäº WMR çš„é¡¹ç›®ã€‚</p>
<p>å¯¹äº Vite ä¸“å±çš„æ’ä»¶ï¼š</p>
<ul>
<li>Vite æ’ä»¶åº”è¯¥æœ‰ä¸€ä¸ªå¸¦ vite-plugin- å‰ç¼€ã€è¯­ä¹‰æ¸…æ™°çš„åç§°ã€‚</li>
<li>åœ¨ package.json ä¸­åŒ…å« vite-plugin å…³é”®å­—ã€‚</li>
<li>åœ¨æ’ä»¶æ–‡æ¡£å¢åŠ ä¸€éƒ¨åˆ†å…³äºä¸ºä»€ä¹ˆæœ¬æ’ä»¶æ˜¯ä¸€ä¸ª Vite ä¸“å±æ’ä»¶çš„è¯¦ç»†è¯´æ˜ï¼ˆå¦‚ï¼Œæœ¬æ’ä»¶ä½¿ç”¨äº† Vite ç‰¹æœ‰çš„æ’ä»¶é’©å­ï¼‰ã€‚</li>
</ul>
<p>å¦‚æœä½ çš„æ’ä»¶åªé€‚ç”¨äºç‰¹å®šçš„æ¡†æ¶ï¼Œå®ƒçš„åå­—åº”è¯¥éµå¾ªä»¥ä¸‹å‰ç¼€æ ¼å¼ï¼š</p>
<ul>
<li>vite-plugin-vue- å‰ç¼€ä½œä¸º Vue æ’ä»¶</li>
<li>vite-plugin-react- å‰ç¼€ä½œä¸º React æ’ä»¶</li>
<li>vite-plugin-svelte- å‰ç¼€ä½œä¸º Svelte æ’ä»¶</li>
</ul>
<h3 id="æ’ä»¶é…ç½®">æ’ä»¶é…ç½®</h3>
<p>ç”¨æˆ·ä¼šå°†æ’ä»¶æ·»åŠ åˆ°é¡¹ç›®çš„ devDependencies ä¸­å¹¶ä½¿ç”¨æ•°ç»„å½¢å¼çš„ plugins é€‰é¡¹é…ç½®å®ƒä»¬ã€‚</p>
<pre><code class="language-js">// vite.config.js
import vitePlugin from 'vite-plugin-feature'
import rollupPlugin from 'rollup-plugin-feature'

export default defineConfig({
  plugins: [vitePlugin(), rollupPlugin()]
})
</code></pre>
<p>å‡å€¼çš„æ’ä»¶å°†è¢«å¿½ç•¥ï¼Œå¯ä»¥ç”¨æ¥è½»æ¾åœ°å¯ç”¨æˆ–åœç”¨æ’ä»¶ã€‚</p>
<p>plugins ä¹Ÿå¯ä»¥æ¥å—å°†å¤šä¸ªæ’ä»¶ä½œä¸ºå•ä¸ªå…ƒç´ çš„é¢„è®¾ã€‚è¿™å¯¹äºä½¿ç”¨å¤šä¸ªæ’ä»¶å®ç°çš„å¤æ‚ç‰¹æ€§ï¼ˆå¦‚æ¡†æ¶é›†æˆï¼‰å¾ˆæœ‰ç”¨ã€‚è¯¥æ•°ç»„å°†åœ¨å†…éƒ¨è¢«æ‰å¹³åŒ–ï¼ˆflattenï¼‰ã€‚</p>
<pre><code class="language-js">// æ¡†æ¶æ’ä»¶
import frameworkRefresh from 'vite-plugin-framework-refresh'
import frameworkDevtools from 'vite-plugin-framework-devtools'

export default function framework(config) {
  return [frameworkRefresh(config), frameworkDevTools(config)]
}
</code></pre>
<pre><code class="language-js">// vite.config.js
import { defineConfig } from 'vite'
import framework from 'vite-plugin-framework'

export default defineConfig({
  plugins: [framework()]
})
</code></pre>
<h3 id="ç®€å•ç¤ºä¾‹">ç®€å•ç¤ºä¾‹</h3>
<blockquote>
<p>TIP<br>
é€šå¸¸çš„æƒ¯ä¾‹æ˜¯åˆ›å»ºä¸€ä¸ª Vite/Rollup æ’ä»¶ä½œä¸ºä¸€ä¸ªè¿”å›å®é™…æ’ä»¶å¯¹è±¡çš„å·¥å‚å‡½æ•°ã€‚è¯¥å‡½æ•°å¯ä»¥æ¥å—å…è®¸ç”¨æˆ·è‡ªå®šä¹‰æ’ä»¶è¡Œä¸ºçš„é€‰é¡¹ã€‚</p>
</blockquote>
<h4 id="è½¬æ¢è‡ªå®šä¹‰æ–‡ä»¶ç±»å‹">è½¬æ¢è‡ªå®šä¹‰æ–‡ä»¶ç±»å‹</h4>
<pre><code class="language-js">const fileRegex = /\.(my-file-ext)$/

export default function myPlugin() {
  return {
    name: 'transform-file',

    transform(src, id) {
      if (fileRegex.test(id)) {
        return {
          code: compileFileToJS(src),
          map: null // å¦‚æœå¯è¡Œå°†æä¾› source map
        }
      }
    }
  }
}
</code></pre>
<h3 id="é€šç”¨é’©å­">é€šç”¨é’©å­</h3>
<p>åœ¨å¼€å‘ä¸­ï¼ŒVite å¼€å‘æœåŠ¡å™¨ä¼šåˆ›å»ºä¸€ä¸ªæ’ä»¶å®¹å™¨æ¥è°ƒç”¨ <a href="https://rollupjs.org/guide/en/#build-hooks">Rollup æ„å»ºé’©å­</a>ï¼Œä¸ Rollup å¦‚å‡ºä¸€è¾™ã€‚</p>
<p>ä»¥ä¸‹é’©å­åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶è¢«è°ƒç”¨ï¼š</p>
<ul>
<li>
<p>options</p>
</li>
<li>
<p>buildStart<br>
ä»¥ä¸‹é’©å­ä¼šåœ¨æ¯ä¸ªä¼ å…¥æ¨¡å—è¯·æ±‚æ—¶è¢«è°ƒç”¨ï¼š</p>
</li>
<li>
<p>resolveId</p>
</li>
<li>
<p>load</p>
</li>
<li>
<p>transform<br>
ä»¥ä¸‹é’©å­åœ¨æœåŠ¡å™¨å…³é—­æ—¶è¢«è°ƒç”¨ï¼š</p>
</li>
<li>
<p>buildEnd</p>
</li>
<li>
<p>closeBundle<br>
è¯·æ³¨æ„ moduleParsed é’©å­åœ¨å¼€å‘ä¸­æ˜¯ ä¸ä¼š è¢«è°ƒç”¨çš„ï¼Œå› ä¸º Vite ä¸ºäº†æ€§èƒ½ä¼šé¿å…å®Œæ•´çš„ AST è§£æã€‚<br>
Output Generation Hooksï¼ˆé™¤äº† closeBundle) åœ¨å¼€å‘ä¸­æ˜¯ ä¸ä¼š è¢«è°ƒç”¨çš„ã€‚ä½ å¯ä»¥è®¤ä¸º Vite çš„å¼€å‘æœåŠ¡å™¨åªè°ƒç”¨äº† rollup.rollup() è€Œæ²¡æœ‰è°ƒç”¨ bundle.generate()ã€‚<br>
<img src="https://weidadeda.github.io/post-images/1645006280268.jpeg" alt="" loading="lazy"></p>
</li>
</ul>
<h3 id="vite-ç‹¬æœ‰é’©å­">Vite ç‹¬æœ‰é’©å­</h3>
<p>Vite æ’ä»¶ä¹Ÿå¯ä»¥æä¾›é’©å­æ¥æœåŠ¡äºç‰¹å®šçš„ Vite ç›®æ ‡ã€‚è¿™äº›é’©å­ä¼šè¢« Rollup å¿½ç•¥ã€‚</p>
<h4 id="config">config</h4>
<ul>
<li>
<p>ç±»å‹ï¼š (config: UserConfig, env: { mode: string, command: string }) =&gt; UserConfig | null | void</p>
</li>
<li>
<p>ç§ç±»ï¼š async, sequential</p>
</li>
</ul>
<p>åœ¨è§£æ Vite é…ç½®å‰è°ƒç”¨ã€‚é’©å­æ¥æ”¶åŸå§‹ç”¨æˆ·é…ç½®ï¼ˆå‘½ä»¤è¡Œé€‰é¡¹æŒ‡å®šçš„ä¼šä¸é…ç½®æ–‡ä»¶åˆå¹¶ï¼‰å’Œä¸€ä¸ªæè¿°é…ç½®ç¯å¢ƒçš„å˜é‡ï¼ŒåŒ…å«æ­£åœ¨ä½¿ç”¨çš„ mode å’Œ commandã€‚å®ƒå¯ä»¥è¿”å›ä¸€ä¸ªå°†è¢«æ·±åº¦åˆå¹¶åˆ°ç°æœ‰é…ç½®ä¸­çš„éƒ¨åˆ†é…ç½®å¯¹è±¡ï¼Œæˆ–è€…ç›´æ¥æ”¹å˜é…ç½®ï¼ˆå¦‚æœé»˜è®¤çš„åˆå¹¶ä¸èƒ½è¾¾åˆ°é¢„æœŸçš„ç»“æœï¼‰ã€‚</p>
<p>ç¤ºä¾‹ï¼š</p>
<pre><code class="language-js">// è¿”å›éƒ¨åˆ†é…ç½®ï¼ˆæ¨èï¼‰
const partialConfigPlugin = () =&gt; ({
  name: 'return-partial',
  config: () =&gt; ({
    alias: {
      foo: 'bar'
    }
  })
})

// ç›´æ¥æ”¹å˜é…ç½®ï¼ˆåº”ä»…åœ¨åˆå¹¶ä¸èµ·ä½œç”¨æ—¶ä½¿ç”¨ï¼‰
const mutateConfigPlugin = () =&gt; ({
  name: 'mutate-config',
  config(config, { command }) {
    if (command === 'build') {
      config.root = __dirname
    }
  }
})
</code></pre>
<blockquote>
<p>æ³¨æ„<br>
ç”¨æˆ·æ’ä»¶åœ¨è¿è¡Œè¿™ä¸ªé’©å­ä¹‹å‰ä¼šè¢«è§£æï¼Œå› æ­¤åœ¨ config é’©å­ä¸­æ³¨å…¥å…¶ä»–æ’ä»¶ä¸ä¼šæœ‰ä»»ä½•æ•ˆæœã€‚</p>
</blockquote>
<h4 id="configresolved">configResolved</h4>
<ul>
<li>
<p>ç±»å‹ï¼š (config: ResolvedConfig) =&gt; void | Promise<void></p>
</li>
<li>
<p>ç§ç±»ï¼š async, parallel</p>
</li>
</ul>
<p>åœ¨è§£æ Vite é…ç½®åè°ƒç”¨ã€‚ä½¿ç”¨è¿™ä¸ªé’©å­è¯»å–å’Œå­˜å‚¨æœ€ç»ˆè§£æçš„é…ç½®ã€‚å½“æ’ä»¶éœ€è¦æ ¹æ®è¿è¡Œçš„å‘½ä»¤åšä¸€äº›ä¸åŒçš„äº‹æƒ…æ—¶ï¼Œå®ƒä¹Ÿå¾ˆæœ‰ç”¨ã€‚</p>
<p>ç¤ºä¾‹ï¼š</p>
<pre><code class="language-js">const exmaplePlugin = () =&gt; {
  let config

  return {
    name: 'read-config',

    configResolved(resolvedConfig) {
      // å­˜å‚¨æœ€ç»ˆè§£æçš„é…ç½®
      config = resolvedConfig
    },

    // åœ¨å…¶ä»–é’©å­ä¸­ä½¿ç”¨å­˜å‚¨çš„é…ç½®
    transform(code, id) {
      if (config.command === 'serve') {
        // dev: ç”±å¼€å‘æœåŠ¡å™¨è°ƒç”¨çš„æ’ä»¶
      } else {
        // build: ç”± Rollup è°ƒç”¨çš„æ’ä»¶
      }
    }
  }
}
</code></pre>
<blockquote>
<p>æ³¨æ„ï¼Œåœ¨å¼€å‘ç¯å¢ƒä¸‹ï¼Œcommand çš„å€¼ä¸º serveï¼ˆåœ¨ CLI ä¸­ï¼Œvite å’Œ vite dev æ˜¯ vite serve çš„åˆ«åï¼‰ã€‚</p>
</blockquote>
<h4 id="configureserver">configureServer</h4>
<ul>
<li>
<p>ç±»å‹ï¼š (server: ViteDevServer) =&gt; (() =&gt; void) | void | Promise&lt;(() =&gt; void) | void&gt;</p>
</li>
<li>
<p>ç§ç±»ï¼š async, sequential</p>
</li>
<li>
<p>æ­¤å¤–è¯·çœ‹ <a href="https://vitejs.cn/guide/api-javascript.html#vitedevserver">ViteDevServer</a></p>
</li>
</ul>
<p>æ˜¯ç”¨äºé…ç½®å¼€å‘æœåŠ¡å™¨çš„é’©å­ã€‚æœ€å¸¸è§çš„ç”¨ä¾‹æ˜¯åœ¨å†…éƒ¨ connect åº”ç”¨ç¨‹åºä¸­æ·»åŠ è‡ªå®šä¹‰ä¸­é—´ä»¶:</p>
<pre><code class="language-js">const myPlugin = () =&gt; ({
  name: 'configure-server',
  configureServer(server) {
    server.middlewares.use((req, res, next) =&gt; {
      // è‡ªå®šä¹‰è¯·æ±‚å¤„ç†...
    })
  }
})
</code></pre>
<p>æ³¨å…¥åç½®ä¸­é—´ä»¶</p>
<p>configureServer é’©å­å°†åœ¨å†…éƒ¨ä¸­é—´ä»¶è¢«å®‰è£…å‰è°ƒç”¨ï¼Œæ‰€ä»¥è‡ªå®šä¹‰çš„ä¸­é—´ä»¶å°†ä¼šé»˜è®¤ä¼šæ¯”å†…éƒ¨ä¸­é—´ä»¶æ—©è¿è¡Œã€‚å¦‚æœä½ æƒ³æ³¨å…¥ä¸€ä¸ªåœ¨å†…éƒ¨ä¸­é—´ä»¶ ä¹‹å è¿è¡Œçš„ä¸­é—´ä»¶ï¼Œä½ å¯ä»¥ä» configureServer è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œå°†ä¼šåœ¨å†…éƒ¨ä¸­é—´ä»¶å®‰è£…åè¢«è°ƒç”¨ï¼š</p>
<pre><code class="language-js">const myPlugin = () =&gt; ({
  name: 'configure-server',
  configureServer(server) {
    // è¿”å›ä¸€ä¸ªåœ¨å†…éƒ¨ä¸­é—´ä»¶å®‰è£…å
    // è¢«è°ƒç”¨çš„åç½®é’©å­
    return () =&gt; {
      server.middlewares.use((req, res, next) =&gt; {
        // è‡ªå®šä¹‰è¯·æ±‚å¤„ç†...
      })
    }
  }
})
</code></pre>
<p>å­˜å‚¨æœåŠ¡å™¨è®¿é—®</p>
<p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå…¶ä»–æ’ä»¶é’©å­å¯èƒ½éœ€è¦è®¿é—®å¼€å‘æœåŠ¡å™¨å®ä¾‹ï¼ˆä¾‹å¦‚è®¿é—® websocket æœåŠ¡å™¨ã€æ–‡ä»¶ç³»ç»Ÿç›‘è§†ç¨‹åºæˆ–æ¨¡å—å›¾ï¼‰ã€‚è¿™ä¸ªé’©å­ä¹Ÿå¯ä»¥ç”¨æ¥å­˜å‚¨æœåŠ¡å™¨å®ä¾‹ä»¥ä¾›å…¶ä»–é’©å­è®¿é—®:</p>
<pre><code class="language-js">const myPlugin = () =&gt; {
  let server
  return {
    name: 'configure-server',
    configureServer(_server) {
      server = _server
    },
    transform(code, id) {
      if (server) {
        // ä½¿ç”¨ server...
      }
    }
  }
}
</code></pre>
<p>æ³¨æ„ configureServer åœ¨è¿è¡Œç”Ÿäº§ç‰ˆæœ¬æ—¶ä¸ä¼šè¢«è°ƒç”¨ï¼Œæ‰€ä»¥å…¶ä»–é’©å­éœ€è¦é˜²èŒƒå®ƒç¼ºå¤±ã€‚</p>
<h4 id="transformindexhtml">transformIndexHtml</h4>
<ul>
<li>
<p>ç±»å‹ï¼š IndexHtmlTransformHook | { enforce?: 'pre' | 'post', transform: IndexHtmlTransformHook }</p>
</li>
<li>
<p>ç§ç±»ï¼š async, sequential</p>
</li>
</ul>
<p>è½¬æ¢ index.html çš„ä¸“ç”¨é’©å­ã€‚é’©å­æ¥æ”¶å½“å‰çš„ HTML å­—ç¬¦ä¸²å’Œè½¬æ¢ä¸Šä¸‹æ–‡ã€‚ä¸Šä¸‹æ–‡åœ¨å¼€å‘æœŸé—´æš´éœ²ViteDevServerå®ä¾‹ï¼Œåœ¨æ„å»ºæœŸé—´æš´éœ² Rollup è¾“å‡ºçš„åŒ…ã€‚<br>
è¿™ä¸ªé’©å­å¯ä»¥æ˜¯å¼‚æ­¥çš„ï¼Œå¹¶ä¸”å¯ä»¥è¿”å›ä»¥ä¸‹å…¶ä¸­ä¹‹ä¸€:</p>
<ul>
<li>ç»è¿‡è½¬æ¢çš„ HTML å­—ç¬¦ä¸²</li>
<li>æ³¨å…¥åˆ°ç°æœ‰ HTML ä¸­çš„æ ‡ç­¾æè¿°ç¬¦å¯¹è±¡æ•°ç»„ï¼ˆ{ tag, attrs, children }ï¼‰ã€‚æ¯ä¸ªæ ‡ç­¾ä¹Ÿå¯ä»¥æŒ‡å®šå®ƒåº”è¯¥è¢«æ³¨å…¥åˆ°å“ªé‡Œï¼ˆé»˜è®¤æ˜¯åœ¨ <head> ä¹‹å‰ï¼‰</li>
<li>ä¸€ä¸ªåŒ…å« { html, tags } çš„å¯¹è±¡</li>
</ul>
<p>åŸºç¡€ç¤ºä¾‹ï¼š</p>
<pre><code class="language-js">const htmlPlugin = () =&gt; {
  return {
    name: 'html-transform',
    transformIndexHtml(html) {
      return html.replace(
        /&lt;title&gt;(.*?)&lt;\/title&gt;/,
        `&lt;title&gt;Title replaced!&lt;/title&gt;`
      )
    }
  }
}
</code></pre>
<h4 id="handlehotupdate">handleHotUpdate</h4>
<ul>
<li>ç±»å‹ï¼š (ctx: HmrContext) =&gt; Array<ModuleNode> | void | Promise&lt;Array<ModuleNode> | void&gt;</li>
</ul>
<p>æ‰§è¡Œè‡ªå®šä¹‰ HMR æ›´æ–°å¤„ç†ã€‚é’©å­æ¥æ”¶ä¸€ä¸ªå¸¦æœ‰ä»¥ä¸‹ç­¾åçš„ä¸Šä¸‹æ–‡å¯¹è±¡ï¼š</p>
<pre><code class="language-js">interface HmrContext {
  file: string
  timestamp: number
  modules: Array&lt;ModuleNode&gt;
  read: () =&gt; string | Promise&lt;string&gt;
  server: ViteDevServer
}
</code></pre>
<ul>
<li>
<p>modules æ˜¯å—æ›´æ”¹æ–‡ä»¶å½±å“çš„æ¨¡å—æ•°ç»„ã€‚å®ƒæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå› ä¸ºå•ä¸ªæ–‡ä»¶å¯èƒ½æ˜ å°„åˆ°å¤šä¸ªæœåŠ¡æ¨¡å—ï¼ˆä¾‹å¦‚ Vue å•æ–‡ä»¶ç»„ä»¶ï¼‰ã€‚</p>
</li>
<li>
<p>read è¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥è¯»å‡½æ•°ï¼Œå®ƒè¿”å›æ–‡ä»¶çš„å†…å®¹ã€‚ä¹‹æ‰€ä»¥è¿™æ ·åšï¼Œæ˜¯å› ä¸ºåœ¨æŸäº›ç³»ç»Ÿä¸Šï¼Œæ–‡ä»¶æ›´æ”¹çš„å›è°ƒå‡½æ•°å¯èƒ½ä¼šåœ¨ç¼–è¾‘å™¨å®Œæˆæ–‡ä»¶æ›´æ–°ä¹‹å‰è¿‡å¿«åœ°è§¦å‘ï¼Œå¹¶ fs.readFile ç›´æ¥ä¼šè¿”å›ç©ºå†…å®¹ã€‚ä¼ å…¥çš„ read å‡½æ•°è§„èŒƒäº†è¿™ç§è¡Œä¸ºã€‚</p>
</li>
</ul>
<p>é’©å­å¯ä»¥é€‰æ‹©:</p>
<ul>
<li>
<p>è¿‡æ»¤å’Œç¼©å°å—å½±å“çš„æ¨¡å—åˆ—è¡¨ï¼Œä½¿ HMR æ›´å‡†ç¡®ã€‚</p>
</li>
<li>
<p>è¿”å›ä¸€ä¸ªç©ºæ•°ç»„ï¼Œå¹¶é€šè¿‡å‘å®¢æˆ·ç«¯å‘é€è‡ªå®šä¹‰äº‹ä»¶æ¥æ‰§è¡Œå®Œæ•´çš„è‡ªå®šä¹‰ HMR å¤„ç†:</p>
</li>
</ul>
<pre><code class="language-js">handleHotUpdate({ server }) {
  server.ws.send({
    type: 'custom',
    event: 'special-update',
    data: {}
  })
  return []
}
</code></pre>
<p>å®¢æˆ·ç«¯ä»£ç åº”è¯¥ä½¿ç”¨ <a href="https://vitejs.cn/guide/api-hmr.html">HMR API</a> æ³¨å†Œç›¸åº”çš„å¤„ç†å™¨ï¼ˆè¿™åº”è¯¥è¢«ç›¸åŒæ’ä»¶çš„ transform é’©å­æ³¨å…¥ï¼‰ï¼š</p>
<pre><code class="language-js">if (import.meta.hot) {
  import.meta.hot.on('special-update', (data) =&gt; {
    // æ‰§è¡Œè‡ªå®šä¹‰æ›´æ–°
  })
}
</code></pre>
<h3 id="æ’ä»¶é¡ºåº">æ’ä»¶é¡ºåº</h3>
<p>ä¸€ä¸ª Vite æ’ä»¶å¯ä»¥é¢å¤–æŒ‡å®šä¸€ä¸ª enforce å±æ€§ï¼ˆç±»ä¼¼äº webpack åŠ è½½å™¨ï¼‰æ¥è°ƒæ•´å®ƒçš„åº”ç”¨é¡ºåºã€‚enforce çš„å€¼å¯ä»¥æ˜¯pre æˆ– postã€‚è§£æåçš„æ’ä»¶å°†æŒ‰ç…§ä»¥ä¸‹é¡ºåºæ’åˆ—ï¼š</p>
<ul>
<li>Alias</li>
<li>å¸¦æœ‰ enforce: 'pre' çš„ç”¨æˆ·æ’ä»¶</li>
<li>Vite æ ¸å¿ƒæ’ä»¶</li>
<li>æ²¡æœ‰ enforce å€¼çš„ç”¨æˆ·æ’ä»¶</li>
<li>Vite æ„å»ºç”¨çš„æ’ä»¶</li>
<li>å¸¦æœ‰ enforce: 'post' çš„ç”¨æˆ·æ’ä»¶</li>
<li>Vite åç½®æ„å»ºæ’ä»¶ï¼ˆæœ€å°åŒ–ï¼Œmanifestï¼ŒæŠ¥å‘Šï¼‰</li>
</ul>
<h3 id="æƒ…æ™¯åº”ç”¨">æƒ…æ™¯åº”ç”¨</h3>
<p>é»˜è®¤æƒ…å†µä¸‹æ’ä»¶åœ¨å¼€å‘ï¼ˆserveï¼‰å’Œæ„å»ºï¼ˆbuildï¼‰æ¨¡å¼ä¸­éƒ½ä¼šè°ƒç”¨ã€‚å¦‚æœæ’ä»¶åªéœ€è¦åœ¨é¢„è§ˆæˆ–æ„å»ºæœŸé—´æœ‰æ¡ä»¶åœ°åº”ç”¨ï¼Œè¯·ä½¿ç”¨ apply å±æ€§æŒ‡æ˜å®ƒä»¬ä»…åœ¨ 'build' æˆ– 'serve' æ¨¡å¼æ—¶è°ƒç”¨ï¼š</p>
<pre><code class="language-js">function myPlugin() {
  return {
    name: 'build-only',
    apply: 'build' // æˆ– 'serve'
  }
}
</code></pre>
<p>åŒæ—¶ï¼Œè¿˜å¯ä»¥ä½¿ç”¨å‡½æ•°æ¥è¿›è¡Œæ›´ç²¾å‡†çš„æ§åˆ¶ï¼š</p>
<pre><code class="language-js">apply(config, { command }) {
  // é SSR æƒ…å†µä¸‹çš„ build
  return command === 'build' &amp;&amp; !config.build.ssr
}
</code></pre>
<h3 id="rollup-æ’ä»¶å…¼å®¹æ€§">Rollup æ’ä»¶å…¼å®¹æ€§</h3>
<p>ç›¸å½“æ•°é‡çš„ Rollup æ’ä»¶å°†ç›´æ¥ä½œä¸º Vite æ’ä»¶å·¥ä½œï¼ˆä¾‹å¦‚ï¼š@rollup/plugin-alias æˆ– @rollup/plugin-jsonï¼‰ï¼Œä½†å¹¶ä¸æ˜¯æ‰€æœ‰çš„ï¼Œå› ä¸ºæœ‰äº›æ’ä»¶é’©å­åœ¨éæ„å»ºå¼çš„å¼€å‘æœåŠ¡å™¨ä¸Šä¸‹æ–‡ä¸­æ²¡æœ‰æ„ä¹‰ã€‚</p>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œåªè¦ Rollup æ’ä»¶ç¬¦åˆä»¥ä¸‹æ ‡å‡†ï¼Œå®ƒå°±åº”è¯¥åƒ Vite æ’ä»¶ä¸€æ ·å·¥ä½œï¼š</p>
<ul>
<li>æ²¡æœ‰ä½¿ç”¨ moduleParsed é’©å­ã€‚</li>
<li>å®ƒåœ¨æ‰“åŒ…é’©å­å’Œè¾“å‡ºé’©å­ä¹‹é—´æ²¡æœ‰å¾ˆå¼ºçš„è€¦åˆã€‚</li>
</ul>
<p>å¦‚æœä¸€ä¸ª Rollup æ’ä»¶åªåœ¨æ„å»ºé˜¶æ®µæœ‰æ„ä¹‰ï¼Œåˆ™åœ¨ build.rollupOptions.plugins ä¸‹æŒ‡å®šå³å¯ã€‚</p>
<p>ä½ ä¹Ÿå¯ä»¥ç”¨ Vite ç‹¬æœ‰çš„å±æ€§æ¥æ‰©å±•ç°æœ‰çš„ Rollup æ’ä»¶:</p>
<pre><code class="language-js">// vite.config.js
import example from 'rollup-plugin-example'
import { defineConfig } from 'vite'

export default defineConfig({
  plugins: [
    {
      ...example(),
      enforce: 'post',
      apply: 'build'
    }
  ]
})
</code></pre>
<p>æŸ¥çœ‹ <a href="https://vite-rollup-plugins.patak.dev/">Vite Rollup æ’ä»¶</a> è·å–å…¼å®¹çš„å®˜æ–¹ Rollup æ’ä»¶åˆ—è¡¨åŠå…¶ä½¿ç”¨æŒ‡å—ã€‚</p>
<h3 id="a-idtest-nametesté¡¹ç›®å®æˆ˜a"><a id="test" name="test">é¡¹ç›®å®æˆ˜</a></h3>
<p>å…ˆè¯´ä¸‹æˆ‘ä»¬è¦åšä»€ä¹ˆï¼Œæˆ‘ä»¬ç”¨viteæ‰“åŒ…å®Œä¹‹åéœ€è¦å°†æ‰“åŒ…å‡ºæ¥çš„é™æ€èµ„æºä¸Šä¼ åˆ°cdnä¸Šï¼Œä½†ç°æœ‰çš„æ’ä»¶ä¸å¤Ÿçµæ´»ï¼Œæ¯”å¦‚<a href="https://www.npmjs.com/package/vite-plugin-assets-uploader">vite-plugin-assets-uploader<br>
</a>è¿™ä¸ªå¾ˆå¥½ï¼Œä½†æ˜¯éœ€è¦å°†ossçš„å¯†é’¥ç­‰ä¿¡æ¯å†™åœ¨å‰ç«¯ï¼Œä¸å¤Ÿå®‰å…¨ã€‚å¯¹æ­¤æˆ‘ä»¬å°±ç”¨nodeå†™äº†ä¸ªæ¥å£ï¼Œå‰ç«¯åªéœ€è¦è°ƒç”¨nodeæ¥å£å°±èƒ½å¤Ÿä¸Šä¼ åˆ°ossã€‚è€Œä¸”å°†ä»£ç ä¸Šä¼ åˆ°cdnä¹‹åï¼Œæˆ‘ä»¬çš„baseè·¯å¾„ä¹Ÿè¦æ”¹æˆcdnçš„è·¯å¾„ã€‚</p>
<p>è‡ªå®šä¹‰ä¸Šä¼ æ’ä»¶ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-js">/* eslint-disable no-prototype-builtins */
/* eslint-disable no-self-assign */
const path = require('path')
const fs = require('fs-extra')
const request = require('request')
const glob = require('glob')
import { Ioptions } from '../type'
import 'colors'
const packageInfo: any = require(path.resolve('package.json'))
class FileUploader {
  bucket?: string
  uploadUrl: string
  domain: string
  env: string
  prefix?: string
  constructor({ bucket, prefix, env }: { bucket?: string; prefix?: string; env: string }) {
    this.env = env
    if (!env) {
      new Error('è¯·ä¼ å…¥env')
      return
    }
    this.bucket = bucket || 'é»˜è®¤bucket'
    this.prefix = prefix || `${packageInfo.name}/${this.env}/${packageInfo.version}/`
    this.uploadUrl = 'æ¥å£åŸŸå'
    this.domain = 'domain'
  }
  // è·å–base
  getBase() {
    return `${this.domain}/${this.prefix}`
  }
  // viteä¸Šä¼ æ’ä»¶
  UploadPlugin() {
    const options: Ioptions = {
      assetsDir: '',
      mode: '',
      outDir: ''
    }
    const that = this
    return {
      name: 'vite-plugin-upload',
      configResolved: function(config: any) {
        const outDir = config.build.hasOwnProperty('outDir') ? config.build.outDir : 'dist'
        const outDirArr = outDir.split(path.sep)
        options.outDir = outDirArr[outDirArr.length - 1]
        options.assetsDir = `${options.outDir}/${config.build.assetsDir}`
        options.mode = config.mode
      },
      closeBundle() {
        const files = glob.sync(`${options.assetsDir}/*`)
        files.map((item: any) =&gt; {
          that.uploadPre(path.relative(options.outDir, path.resolve(item)), options.outDir)
        })
      }
    }
  }
  // initåˆ¤æ–­æ˜¯å¦æ”¯æŒæ­¤bucket
  init() {
    return new Promise((resolve, reject) =&gt; {
      request.get(
        { url: this.uploadUrl + '/api/bucketList' },
        (err: any, response: { statusCode: any }, body: string) =&gt; {
          const { code, data } = typeof body === 'object' ? body : JSON.parse(body)
          if (err) {
            reject(false)
          }
          if (code !== 0) {
            reject(false)
          } else {
            let cdnInfo = new Map([])
            data.forEach((v: any) =&gt; {
              cdnInfo.set(v.bucket, v.url)
            })
            if (!cdnInfo.has(this.bucket)) {
              throw new Error(`ç›®å‰ä»…æ”¯æŒä»¥ä¸‹bucket${data.map((v: any) =&gt; v.bucket).join(' | ')}`)
            } else {
              this.domain = cdnInfo.get(this.bucket) as string
              resolve(this.getBase())
            }
          }
        }
      )
    })
  }
  // æ£€æŸ¥æ˜¯å¦å­˜åœ¨è¯¥æ–‡ä»¶
  isExistObject(filePath: string) {
    return new Promise(reslove =&gt; {
      request.get(
        {
          url: `${this.uploadUrl}/api/isExistObject?name=${this.prefix + filePath}&amp;bucket=${
            this.bucket
          }`
        },
        (err: any, response: any, body: string) =&gt; {
          if (err) {
            console.log('err', err)
            process.exit(1)
          }
          if (response.statusCode !== 200) {
            console.log('err', 'http err')
            process.exit(1)
          }
          const bodys = JSON.parse(body)
          if (bodys.code === 0) {
            console.log(this.prefix + filePath, 'å·²å­˜åœ¨'.yellow)
            reslove(0)
          } else {
            reslove(1)
          }
        }
      )
    })
  }
  // ä¸Šä¼ 
  upload(filePath: string, outDir: string) {
    return new Promise(reslove =&gt; {
      const formData = {
        key: this.prefix + filePath,
        file: fs.createReadStream(path.resolve(path.join(outDir, filePath))),
        bucket: this.bucket
      }
      request.post(
        {
          url: `${this.uploadUrl}/api/upload`,
          formData
        },
        (err: any, response: any, body: string) =&gt; {
          if (err) {
            console.log('err', err)
            process.exit(1)
          }
          if (response.statusCode !== 200) {
            console.log('err', 'http err')
            process.exit(1)
          }
          const bodys = JSON.parse(body)
          if (bodys.code === 0) {
            console.log(bodys.data.fixUrl, 'success~'.green)
            reslove(1)
          }
        }
      )
    })
  }
  // ä¸Šä¼ å‰æ£€æµ‹
  uploadPre(filePath: string, outDir: string) {
    this.isExistObject(filePath).then((res: number) =&gt; {
      if (res === 1) {
        return this.upload(filePath, outDir)
      }
    })
  }
}
export default FileUploader

</code></pre>
<p>æˆ‘ä»¬å°†å®ƒå°è£…åˆ°å‰ç«¯ç»„ä»¶åº“ä¸­ï¼Œç„¶ååœ¨viteä¸­ä½¿ç”¨</p>
<pre><code class="language-js">// vite.config.js
import { FileUploader } from '@msb-next/vite-plugin-upload'
const isProd = process.env.VITE_APP_ENV &amp;&amp; process.env.VITE_APP_ENV !== 'dev'
  let plugins = [
    reactRefresh(),
    antdDayjs(),
    vitePluginImp({
      libList: [
        {
          libName: 'lodash',
          libDirectory: '',
          camel2DashComponentName: false,
          style: () =&gt; {
            return false
          },
        },
        {
          libName: 'antd',
          style(name) {
            return `antd/es/${name}/style/index.css`
          },
        },
      ],
    }),
  ]
  let base = '/'
  let sourcemap = true
  //////////////////////////// ä¸»è¦æ˜¯è¿™é‡Œ /////////////////////////////////////
  if (isProd) {
    const uploader = new FileUploader({
      env: process.env.VITE_APP_ENV,
    })
    // ä¿®æ”¹baseè·¯å¾„
    base = (await uploader.init()) as string
    plugins.push(uploader.UploadPlugin())
    sourcemap = false
  }
</code></pre>
<p>åˆ°è¿™é‡Œï¼Œå…¶å®æ€è·¯å°±å¾ˆæ¸…æ™°äº†ï¼Œå¤§å®¶åŸºæœ¬èƒ½å¤Ÿå®Œæˆä¸€ä¸ªè‡ªå®šä¹‰viteæ’ä»¶äº†ï¼Œä¸‹é¢å°±æ˜¯æˆ‘nodeå±‚çš„ä»£ç äº†ï¼Œå¤§å®¶åº”è¯¥èƒ½çœ‹æ˜ç™½ï¼š<br>
å…ˆè‡ªå®šä¹‰ä¸€ä¸ªkoaä¸­é—´ä»¶</p>
<pre><code class="language-js">const OSS = require('ali-oss');
/**
 * oss è¿æ¥oss
 * @param ctx
 * @param next
 * @returns {Promise&lt;void&gt;}
 */
const connect = async (ctx, next) =&gt; {
  let bucket = '';
  if (ctx.request.method === 'POST') {
    const body = ctx.request.body;
    bucket = body.bucket;
  } else {
    bucket = ctx.query.bucket;
  }
  // ä»redisä¸­è·å–osså¯†é’¥ç­‰é‡è¦ä¿¡æ¯ï¼Œçœ‹çœ‹æ˜¯å¦æ”¯æŒå½“å‰çš„bucketï¼Œè¿™æ ·æ–°å¢bucketæ—¶æ¯”è¾ƒçµæ´»ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥å†™æ­»ã€‚
  const ossAccessRes = await redisClient.get('ossAccess');
  const ossAccess = JSON.parse(ossAccessRes);

  const ossConf = ossAccess.find(v =&gt; v.bucket === bucket);
  let client, urlPrefix;
  try {
    client = new OSS(ossConf);
    urlPrefix = ossConf.url;
  } catch (e) {
    ctx.DATA.msg = 'æš‚ä¸æ”¯æŒå½“å‰bucket';
    ctx.body = ctx.DATA;
    throw new HttpError(200);
  }
  ctx.OSS = client;
  ctx.urlPrefix = urlPrefix;
  await next();
};

module.exports = {
  connect
};
</code></pre>
<p>router.js</p>
<pre><code class="language-js">const router = require('koa-router')();

// åˆšæ‰å®šä¹‰çš„ oss ä¸­é—´ä»¶
const oss = require('../utils/middleware/oss');

// æ§åˆ¶å™¨
const {index, bucketList} = require('../controllers/index');
const api = require('../controllers/api');

// æ·»åŠ è·¯ç”±
router.post('/api/upload', oss.connect, api.upload);
router.get('/api/list', oss.connect, api.list);
router.get('/api/url', oss.connect, api.url);
router.post('/api/del', oss.connect, api.del);
router.get('/api/isExistObject', oss.connect, api.isExistObject);
router.get('/api/bucketList', bucketList);

module.exports = router;
</code></pre>
<p>controller/api.js</p>
<pre><code class="language-js">const fs = require('fs');
const {CustomError} = require('../utils/tool/error');
const DEL_SWITCH = false;

/**
 * ä¸Šä¼ 
 */
const upload = async (ctx) =&gt; {
  const {file} = ctx.request.files;
  const {key} = ctx.request.body;
  const stream = fs.createReadStream(file.path);
  const {name, res, url} = await ctx.OSS.putStream(key, stream);
  ctx.DATA.data = {
    ...res,
    name,
    url,
    fixUrl: `${ctx.urlPrefix}/${name}`
  };
  ctx.body = ctx.DATA;
};

/**
 * è·å–ossåˆ—è¡¨
 */
const list = async (ctx, next) =&gt; {
  const name = ctx.query.name;
  console.log(name);
  ctx.DATA.data = await ctx.OSS.list({
    prefix: name,
    delimiter: '/'
  });
  if (ctx.DATA.data.res.status !== 200) {
    throw new CustomError(0, 'æ–‡ä»¶æŸ¥æ‰¾å¤±è´¥');
  }
  delete ctx.DATA.data.res;
  ctx.body = ctx.DATA;
};

/**
 * è·å–æ–‡ä»¶ä¸‹è½½é“¾æ¥ï¼Œæœ‰æ•ˆæœŸ1åˆ†é’Ÿ
 */
const url = async (ctx) =&gt; {
  const name = ctx.query.name;
  ctx.DATA.data = ctx.OSS.signatureUrl(name, {expires: 3600});
  ctx.body = ctx.DATA;
};

/**
 * åˆ é™¤æ–‡ä»¶ã€æ–‡ä»¶å¤¹
 */
const del = async (ctx) =&gt; {
  if (DEL_SWITCH) {
    let dat = ctx.request.body;
    let delList = dat[0];
    let directory = dat[1];
    try {
      for (let i = 0; i &lt; directory.length; i++) {
        let retList = await ctx.OSS.list({
          prefix: directory[i]
        });
        retList.objects.reverse();
        retList.objects.map(item =&gt; {
          delList.push(item.name);
        });
      }
    } catch (e) {
      throw new CustomError(0, 'åˆ é™¤æ–‡ä»¶:æ•´åˆå¤±è´¥');
    }
    let result = await ctx.OSS.deleteMulti(delList, {quiet: true});
    if (result.res.status !== 200) {
      throw new CustomError(0, 'åˆ é™¤å¤±è´¥');
    }
    ctx.DATA.msg = 'åˆ é™¤æˆåŠŸ';
    ctx.body = ctx.DATA;
  } else {
    ctx.DATA.msg = 'åˆ é™¤æ–‡ä»¶ã€æ–‡ä»¶å¤¹åŠŸèƒ½æœªå¼€æ”¾ï¼';
    ctx.body = ctx.DATA;
  }
};

/**
 * åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨
 * @param ctx
 * @returns {Promise&lt;void&gt;}
 */
const isExistObject = async (ctx) =&gt; {
  // ç”¨äºåˆ¤æ–­å—ç‰ˆæœ¬æ§åˆ¶Bucketä¸­æŒ‡å®šversionIdçš„Objectæ˜¯å¦å­˜åœ¨ã€‚
  const options = {
    // å¡«å†™Objectçš„versionIdã€‚
    versionId: ''
  };
  const name = ctx.query.name;
  try {
    const res = await ctx.OSS.head(name, options);
    ctx.DATA.data = res;
    ctx.DATA.msg = 'æ–‡ä»¶å­˜åœ¨';
    ctx.body = ctx.DATA;
  }  catch (error) {
    if (error.code === 'NoSuchKey') {
      ctx.DATA.code = 1;
      ctx.DATA.msg = 'æ–‡ä»¶ä¸å­˜åœ¨';
      ctx.body = ctx.DATA;
    }
  }
};

module.exports = {
  upload,
  list,
  url,
  del,
  isExistObject,
};

</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[è‡ªå®šä¹‰ä¸€ä¸ªWebPackçš„æ’ä»¶]]></title>
        <id>https://weidadeda.github.io/post/zi-ding-yi-yi-ge-webpack-de-cha-jian</id>
        <link href="https://weidadeda.github.io/post/zi-ding-yi-yi-ge-webpack-de-cha-jian">
        </link>
        <updated>2022-02-14T10:32:14.000Z</updated>
        <content type="html"><![CDATA[<h3 id="1-webpackæ’ä»¶çš„åŸºæœ¬åŸç†">1ã€webpackæ’ä»¶çš„åŸºæœ¬åŸç†</h3>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œwebpack å°±åƒä¸€æ¡ç”Ÿäº§çº¿,è¦ç»è¿‡ä¸€ç³»åˆ—å¤„ç†æµç¨‹åæ‰èƒ½å°†æºæ–‡ä»¶è½¬æ¢æˆè¾“å‡ºç»“æœã€‚ è¿™æ¡ç”Ÿäº§çº¿ä¸Šçš„æ¯ä¸ªå¤„ç†æµç¨‹çš„èŒè´£éƒ½æ˜¯å•ä¸€çš„,å¤šä¸ªæµç¨‹ä¹‹é—´æœ‰å­˜åœ¨ä¾èµ–å…³ç³»,åªæœ‰å®Œæˆå½“å‰å¤„ç†åæ‰èƒ½äº¤ç»™ä¸‹ä¸€ä¸ªæµç¨‹å»å¤„ç†ã€‚ æ’ä»¶å°±åƒæ˜¯ä¸€ä¸ªæ’å…¥åˆ°ç”Ÿäº§çº¿ä¸­çš„ä¸€ä¸ªåŠŸèƒ½,åœ¨ç‰¹å®šçš„æ—¶æœºå¯¹ç”Ÿäº§çº¿ä¸Šçš„èµ„æºåšå¤„ç†ã€‚<br>
webpack é€šè¿‡ Tapable æ¥ç»„ç»‡è¿™æ¡å¤æ‚çš„ç”Ÿäº§çº¿ã€‚ webpack åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ä¼šå¹¿æ’­äº‹ä»¶,æ’ä»¶åªéœ€è¦ç›‘å¬å®ƒæ‰€å…³å¿ƒçš„äº‹ä»¶,å°±èƒ½åŠ å…¥åˆ°è¿™æ¡ç”Ÿäº§çº¿ä¸­,å»æ”¹å˜ç”Ÿäº§çº¿çš„è¿ä½œã€‚ webpack çš„äº‹ä»¶æµæœºåˆ¶ä¿è¯äº†æ’ä»¶çš„æœ‰åºæ€§,ä½¿å¾—æ•´ä¸ªç³»ç»Ÿæ‰©å±•æ€§å¾ˆå¥½ã€‚<br>
<a href="https://www.webpackjs.com/contribute/writing-a-plugin/">å®˜ç½‘æä¾›çš„è‡ªå®šä¹‰æ’ä»¶æ–‡æ¡£</a></p>
<blockquote>
<p>tapable æ˜¯ä¸€ä¸ªç±»ä¼¼äº Node.js ä¸­çš„ EventEmitterçš„åº“ï¼Œä½†æ›´ä¸“æ³¨äºè‡ªå®šä¹‰äº‹ä»¶çš„è§¦å‘å’Œå¤„ç†ã€‚webpack é€šè¿‡ tapable å°†å®ç°ä¸æµç¨‹è§£è€¦ï¼Œæ‰€æœ‰å…·ä½“å®ç°é€šè¿‡æ’ä»¶çš„å½¢å¼å­˜åœ¨ã€‚</p>
</blockquote>
<ul>
<li>tapableä½œä¸ºwebpackçš„ä¸»æ¨¡å—ï¼Œéœ€è¦å•ç‹¬æŠ½ä¸€ç¯‡å‡ºæ¥è®²ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœä½ è¦å†™sdkéœ€è¦å‘å¤–å±‚åéœ²æ•°æ®çš„è¯ï¼Œå»ºè®®è¿˜æ˜¯ç”¨EventEmitteråº“ï¼Œä¸å»ºè®®ç”¨tapableï¼Œå› ä¸ºå®ƒé”€æ¯å…¨éƒ¨æ³¨å†Œäº‹ä»¶ä¸æ˜¯å¾ˆå®¹æ˜“ã€‚<br>
å¥½äº†ï¼Œå†™webpackæ’ä»¶å¿…é¡»è¦äº†è§£tapableï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆç®€å•ä»‹ç»ä¸€ä¸‹å®ƒçš„å‡ ä¸ªå¸¸ç”¨çš„é’©å­ï¼Œå…¶ä»–çš„å¯ä»¥ç½‘ä¸ŠæŸ¥ï¼Œè¿™é‡Œæœ‰ç¯‡å†™çš„è¿˜ä¸é”™<a href="https://blog.csdn.net/mafan121/article/details/113120081">tapableè¯¦è§£</a></li>
</ul>
<pre><code>const {
  SyncHook,
  SyncBailHook,
  SyncWaterfallHook,
  SyncLoopHook,
  AsyncParallelHook,
  AsyncParallelBailHook,
  AsyncSeriesHook,
  AsyncSeriesBailHook,
  AsyncSeriesWaterfallHook
} = require('tapable');
</code></pre>
<h3 id="tapableé€šè¿‡tapæ³¨å†Œä¸€ä¸ªäº‹ä»¶é€šè¿‡callæ‰§è¡Œè¯¥é’©å­æ³¨å†Œçš„æ‰€æœ‰äº‹ä»¶-tapableçš„æ¯ä¸ªhookséƒ½tapä¸€ä¸ªæˆ–å¤šä¸ªäº‹ä»¶-tapasynccallasync-tappromisepromiseç”¨äºæ³¨å†ŒåŒæ­¥æ‰§è¡Œçš„å¼‚æ­¥äº‹ä»¶callasyncç”¨åœ¨å¹¶è¡Œæ‰§è¡Œçš„å¼‚æ­¥é’©å­å®Œæˆåå†æ‰§è¡Œè¯¥å‡½æ•°">tapableé€šè¿‡tapæ³¨å†Œä¸€ä¸ªäº‹ä»¶ï¼Œé€šè¿‡callæ‰§è¡Œè¯¥é’©å­æ³¨å†Œçš„æ‰€æœ‰äº‹ä»¶ã€‚tapableçš„æ¯ä¸ªhookséƒ½tapä¸€ä¸ªæˆ–å¤šä¸ªäº‹ä»¶ã€‚tapAsync/callAsyncã€tapPromise/Promiseç”¨äºæ³¨å†ŒåŒæ­¥æ‰§è¡Œçš„å¼‚æ­¥äº‹ä»¶ï¼ŒcallAsyncç”¨åœ¨å¹¶è¡Œæ‰§è¡Œçš„å¼‚æ­¥é’©å­å®Œæˆåå†æ‰§è¡Œè¯¥å‡½æ•°ã€‚</h3>
<p>å…·ä½“ä½¿ç”¨ä¸¾ä¸ªä¾‹å­ï¼ˆæ¯”å¦‚SyncHookï¼Œä¾æ¬¡æ‰§è¡Œæ³¨å†Œäº‹ä»¶ï¼Œæ— æ³•ä¸­æ–­ï¼‰</p>
<pre><code> const hook = new SyncHook(['name', 'sex'])
  /*
  tap(options,function):
  optionsæ˜¯äº‹ä»¶æè¿°ï¼Œå¯ä»¥ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥ä¸ºä¸€ä¸ªå¯¹è±¡,ä¸ºå¯¹è±¡æ—¶å¿…é¡»åŒ…å«nameå±æ€§ï¼Œæè¿°è¯¥æ’ä»¶åç§°ã€‚
  function:å›è°ƒå‡½æ•°
  */
  // æ‰“å°æˆ‘çš„åå­—
  hook.tap('printName', (name) =&gt; {
    console.log('my name is ' + name);
  })
  hook.tap('printSex', (name, sex) =&gt; {
    console.log('Iâ€™m a ' + sex);
  })
  // call(arg1,arg2,...)
  hook.call('å¼ ä¸‰', 'man');

  æ‰§è¡Œç»“æœï¼š

    my name is å¼ ä¸‰

    Iâ€™m a man
</code></pre>
<p>å¥½äº†ï¼Œè¯´äº†ä¸€å †tapableäº†ï¼Œè¯¥è¯´webpackæ’ä»¶äº†ã€‚</p>
<p>webpack æ’ä»¶ç”±ä»¥ä¸‹ç»„æˆï¼š</p>
<ul>
<li>ä¸€ä¸ª JavaScript å‘½åå‡½æ•°ã€‚</li>
<li>åœ¨æ’ä»¶å‡½æ•°çš„ prototype ä¸Šå®šä¹‰ä¸€ä¸ª apply æ–¹æ³•ã€‚</li>
<li>æŒ‡å®šä¸€ä¸ªç»‘å®šåˆ° webpack è‡ªèº«çš„äº‹ä»¶é’©å­ã€‚</li>
<li>å¤„ç† webpack å†…éƒ¨å®ä¾‹çš„ç‰¹å®šæ•°æ®ã€‚</li>
<li>åŠŸèƒ½å®Œæˆåè°ƒç”¨ webpack æä¾›çš„å›è°ƒã€‚</li>
</ul>
<p>ä¸‹é¢æ˜¯å®˜ç½‘çš„ç®€å•ä¾‹å­ï¼š</p>
<pre><code class="language-js">// ä¸€ä¸ª JavaScript å‘½åå‡½æ•°ã€‚
function MyExampleWebpackPlugin() {

};

// åœ¨æ’ä»¶å‡½æ•°çš„ prototype ä¸Šå®šä¹‰ä¸€ä¸ª `apply` æ–¹æ³•ã€‚
MyExampleWebpackPlugin.prototype.apply = function(compiler) {
  // æŒ‡å®šä¸€ä¸ªæŒ‚è½½åˆ° webpack è‡ªèº«çš„äº‹ä»¶é’©å­ã€‚
  compiler.plugin('webpacksEventHook', function(compilation /* å¤„ç† webpack å†…éƒ¨å®ä¾‹çš„ç‰¹å®šæ•°æ®ã€‚*/, callback) {
    console.log(&quot;This is an example plugin!!!&quot;);

    // åŠŸèƒ½å®Œæˆåè°ƒç”¨ webpack æä¾›çš„å›è°ƒã€‚
    callback();
  });
};
</code></pre>
<p>åœ¨æˆ‘ä»¬ä½¿ç”¨è¯¥pluginçš„æ—¶å€™ï¼Œç›¸å…³è°ƒç”¨åŠé…ç½®ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-js">const MyExampleWebpackPlugin = require('./MyExampleWebpackPlugin');
module.exports = {
  plugins: [
    new MyExampleWebpackPlugin(options)
  ]
};
</code></pre>
<p>æˆ‘å¼€å§‹è¯´äº†ä¸€å¤§å †tapableï¼Œå…¶å®å°±æ˜¯ä¸ºäº†è¯´æ˜ç™½webpackæ’ä»¶çš„åŸç†</p>
<p>ç”¨ä»£ç è¯´æ˜å§ï¼Œä¸€ä¸ªcompiler.jsï¼Œä¸€ä¸ªmain.js<br>
compiler.js</p>
<pre><code class="language-js">// éœ€è¦åšçš„äº‹æƒ…å¦‚ä¸‹ï¼š
// 1. å®šä¹‰ä¸€ä¸ª Compiler ç±»ï¼Œæ¥æ”¶ä¸€ä¸ªoptionså¯¹è±¡å‚æ•°ï¼Œè¯¥å‚æ•°æ˜¯ä»main.jsä¸­çš„MyPluginç±»çš„å®åˆ—å¯¹è±¡ã€‚è¯¥å¯¹è±¡ä¸‹æœ‰ applyå‡½æ•°ã€‚

// 2. åœ¨è¯¥ç±»ä¸­æˆ‘ä»¬å®šä¹‰äº†runæ–¹æ³•ï¼Œæˆ‘ä»¬åœ¨main.js ä¸­æ‰§è¡Œè¯¥runå‡½æ•°å°±å¯ä»¥è‡ªåŠ¨æ‰§è¡Œå¯¹åº”çš„æ’ä»¶äº†ã€‚

const { SyncHook, AsyncParallelHook } = require('tapable');

class Compiler {
  constructor(options) {
    this.hooks = {
      kzSyncHook: new SyncHook(['name', 'age']),
      kzAsyncHook: new AsyncParallelHook(['name', 'age'])
    };
    let plugins = options.plugins;
    if (plugins &amp;&amp; plugins.length &gt; 0) {
      plugins.forEach(plugin =&gt; plugin.apply(this));
    }
  }
  run() {
    console.log('å¼€å§‹æ‰§è¡Œäº†---------');
    this.kzSyncHook('æˆ‘æ˜¯å°æ˜', 81);
    this.kzAsyncHook('æˆ‘æ˜¯å°çº¢', 91);
  }
  kzSyncHook(name, age) {
    this.hooks.kzSyncHook.call(name, age);
  }
  kzAsyncHook(name, age) {
    this.hooks.kzAsyncHook.callAsync(name, age);
  }
}

module.exports = Compiler;
</code></pre>
<p>main.js</p>
<pre><code class="language-js">// éœ€è¦åšçš„äº‹æƒ…å¦‚ä¸‹ï¼š
// 1. å¼•å…¥ compiler.js æ–‡ä»¶ã€‚
// 2. å®šä¹‰ä¸€ä¸ªè‡ªå·±çš„æ’ä»¶ï¼Œæ¯”å¦‚å« MyPlugin ç±»ï¼Œè¯¥ç±»ä¸‹æœ‰ apply å‡½æ•°ã€‚è¯¥å‡½æ•°æœ‰ä¸€ä¸ª compiler å‚æ•°ï¼Œè¯¥å‚æ•°å°±æ˜¯æˆ‘ä»¬çš„ compiler.js ä¸­çš„å®åˆ—å¯¹è±¡ã€‚ç„¶åæˆ‘ä»¬ä¼šä½¿ç”¨ compiler å®åˆ—å¯¹è±¡å»è°ƒç”¨ compiler.js é‡Œé¢çš„å‡½æ•°ã€‚å› æ­¤å°±å¯ä»¥è‡ªåŠ¨æ‰§è¡Œäº†ã€‚
const Compiler = require('./compiler');

class MyPlugin {
  constructor() {
    
  }
  apply(compiler) {
    compiler.hooks.kzSyncHook.tap(&quot;eventName1&quot;, (name, age) =&gt; {
      console.log(`åŒæ­¥äº‹ä»¶eventName1ï¼š ${name} this year ${age} å‘¨å²äº†, å¯æ˜¯è¿˜æ˜¯å•èº«`);
    });
    compiler.hooks.kzAsyncHook.tapAsync('eventName2', (name, age) =&gt; {
      setTimeout(() =&gt; {
        console.log(`å¼‚æ­¥äº‹ä»¶eventName2ï¼š ${name} this year ${age}å‘¨å²äº†ï¼Œå¯æ˜¯è¿˜æ˜¯å•èº«`);
      }, 1000)
    });
  }
}

const myPlugin = new MyPlugin();

const options = {
  plugins: [myPlugin]
};

const compiler = new Compiler(options);
compiler.run();
</code></pre>
<p>çœ‹åˆ°æ²¡ï¼Œè¿™ç§ä½¿ç”¨æ–¹å¼æ˜¯ä¸æ˜¯å’Œå®˜ç½‘çš„ä½¿ç”¨æ–¹å¼å¾ˆç›¸ä¼¼ï½è¿™å›çŸ¥é“åŸç†äº†å§ï½</p>
<p>ç°åœ¨çœ‹å®˜ç½‘çš„ç®€å•ä¾‹å­ï¼Œwebpackå¯åŠ¨åï¼Œåœ¨è¯»å–é…ç½®çš„è¿‡ç¨‹ä¸­ä¼šå…ˆæ‰§è¡Œ new MyExampleWebpackPlugin(options) åˆå§‹åŒ–MyExampleWebpackPluginæ¥è·å¾—ä¸€ä¸ªå®ä¾‹ã€‚<br>
ç„¶åæˆ‘ä»¬ä¼šæŠŠè¯¥å®ä¾‹å½“åšå‚æ•°ä¼ é€’ç»™æˆ‘ä»¬çš„Compilerå¯¹è±¡ï¼Œç„¶åä¼šå®ä¾‹åŒ– Compilerç±»(è¿™ä¸ªé€»è¾‘å¯ä»¥ç»“åˆçœ‹æˆ‘ä»¬ä¸Šé¢å®ç°äº†ä¸€ä¸ªç®€å•çš„demoä¸­ çš„main.jså’Œcompiler.jsçš„ä»£ç ç»“åˆèµ·æ¥ç†è§£)ã€‚åœ¨Compilerç±»ä¸­ï¼Œæˆ‘ä»¬ä¼šè·å–åˆ°optionsçš„è¿™ä¸ªå‚æ•°ï¼Œè¯¥å‚æ•°æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä¸‹æœ‰ä¸€ä¸ª plugins è¿™ä¸ªå±æ€§ã€‚<br>
ç„¶åéå†è¯¥å±æ€§ï¼Œç„¶åä¾æ¬¡æ‰§è¡Œ æŸé¡¹æ’ä»¶ä¸­çš„applyæ–¹æ³•ï¼Œå³ï¼šmyExampleWebpackPlugin.apply(compiler); ç»™æ’ä»¶ä¼ é€’compilerå¯¹è±¡ã€‚æ’ä»¶å®ä¾‹è·å–è¯¥compilerå¯¹è±¡åï¼Œå°±å¯ä»¥é€šè¿‡ compiler.plugin('äº‹ä»¶åç§°', 'å›è°ƒå‡½æ•°'); ç›‘å¬åˆ°webpackå¹¿æ’­å‡ºæ¥çš„äº‹ä»¶.(è¿™ä¸ªåœ°æ–¹æˆ‘ä»¬å¯ä»¥çœ‹æˆ‘ä»¬ä¸Šé¢çš„main.jsä¸­çš„å¦‚ä¸‹ä»£ç å¯ä»¥çœ‹åˆ°, åœ¨æˆ‘ä»¬çš„main.jsä»£ç ä¸­æœ‰è¿™æ ·ä»£ç ï¼šcompiler.hooks.kzSyncHook.tap(&quot;eventName1&quot;, (name, age) =&gt; {}));</p>
<p>å¦‚ä¸Šå°±æ˜¯ä¸€ä¸ªç®€å•çš„Pluginçš„æ’ä»¶åŸç†(åˆ‡è®°ï¼šç»“åˆä¸Šé¢çš„demoä¸­main.jså’Œcompiller.jsæ¥ç†è§£æ•ˆæœä¼šæ›´å¥½)ã€‚</p>
<h3 id="2-compiler-å’Œ-compilation">2ã€Compiler å’Œ Compilation</h3>
<p>åœ¨å¼€å‘Pluginæ—¶æˆ‘ä»¬æœ€å¸¸ç”¨çš„ä¸¤ä¸ªå¯¹è±¡å°±æ˜¯ Compiler å’Œ Compilation, ä»–ä»¬æ˜¯Pluginå’Œwebpackä¹‹é—´çš„æ¡¥æ¢ã€‚</p>
<blockquote>
<p>compiler å¯¹è±¡ä»£è¡¨äº†å®Œæ•´çš„ webpack ç¯å¢ƒé…ç½®ã€‚è¿™ä¸ªå¯¹è±¡åœ¨å¯åŠ¨ webpack æ—¶è¢«ä¸€æ¬¡æ€§å»ºç«‹ï¼Œå¹¶é…ç½®å¥½æ‰€æœ‰å¯æ“ä½œçš„è®¾ç½®ï¼ŒåŒ…æ‹¬ optionsï¼Œloader å’Œ pluginã€‚å½“åœ¨ webpack ç¯å¢ƒä¸­åº”ç”¨ä¸€ä¸ªæ’ä»¶æ—¶ï¼Œæ’ä»¶å°†æ”¶åˆ°æ­¤ compiler å¯¹è±¡çš„å¼•ç”¨ã€‚å¯ä»¥ä½¿ç”¨å®ƒæ¥è®¿é—® webpack çš„ä¸»ç¯å¢ƒã€‚</p>
</blockquote>
<blockquote>
<p>compilation å¯¹è±¡ä»£è¡¨äº†ä¸€æ¬¡èµ„æºç‰ˆæœ¬æ„å»ºã€‚å½“è¿è¡Œ webpack å¼€å‘ç¯å¢ƒä¸­é—´ä»¶æ—¶ï¼Œæ¯å½“æ£€æµ‹åˆ°ä¸€ä¸ªæ–‡ä»¶å˜åŒ–ï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ compilationï¼Œä»è€Œç”Ÿæˆä¸€ç»„æ–°çš„ç¼–è¯‘èµ„æºã€‚ä¸€ä¸ª compilation å¯¹è±¡è¡¨ç°äº†å½“å‰çš„æ¨¡å—èµ„æºã€ç¼–è¯‘ç”Ÿæˆèµ„æºã€å˜åŒ–çš„æ–‡ä»¶ã€ä»¥åŠè¢«è·Ÿè¸ªä¾èµ–çš„çŠ¶æ€ä¿¡æ¯ã€‚compilation å¯¹è±¡ä¹Ÿæä¾›äº†å¾ˆå¤šå…³é”®æ—¶æœºçš„å›è°ƒï¼Œä»¥ä¾›æ’ä»¶åšè‡ªå®šä¹‰å¤„ç†æ—¶é€‰æ‹©ä½¿ç”¨ã€‚</p>
</blockquote>
<h4 id="compilerå¯¹è±¡">Compilerå¯¹è±¡</h4>
<p>Compilerå¯¹è±¡åŒ…å«äº†Webpackç¯å¢ƒæ‰€æœ‰çš„é…ç½®ä¿¡æ¯ï¼ŒåŒ…å«optionsï¼Œloaders, pluginsè¿™äº›é¡¹ï¼Œè¿™ä¸ªå¯¹è±¡åœ¨webpackå¯åŠ¨æ—¶å€™è¢«å®ä¾‹åŒ–ï¼Œå®ƒæ˜¯å…¨å±€å”¯ä¸€çš„ã€‚æˆ‘ä»¬å¯ä»¥æŠŠå®ƒç†è§£ä¸ºwebpackçš„å®ä¾‹ã€‚</p>
<p>åŸºæœ¬æºç å¯ä»¥çœ‹å¦‚ä¸‹ï¼š</p>
<pre><code>// webpack/lib/webpack.js
const Compiler = require(&quot;./Compiler&quot;)

const webpack = (options, callback) =&gt; {
  ...
  // åˆå§‹åŒ– webpack å„é…ç½®å‚æ•°
  options = new WebpackOptionsDefaulter().process(options);

  // åˆå§‹åŒ– compiler å¯¹è±¡ï¼Œè¿™é‡Œ options.context ä¸º process.cwd()
  let compiler = new Compiler(options.context);

  compiler.options = options                               // å¾€ compiler æ·»åŠ åˆå§‹åŒ–å‚æ•°

  new NodeEnvironmentPlugin().apply(compiler)              // å¾€ compiler æ·»åŠ  Node ç¯å¢ƒç›¸å…³æ–¹æ³•

  for (const plugin of options.plugins) {
    plugin.apply(compiler);
  }
  ...
}
</code></pre>
<blockquote>
<p><a href="https://github.com/webpack/webpack/blob/10282ea20648b465caec6448849f24fc34e1ba3e/lib/webpack.js#L30">æºç å¯ä»¥ç‚¹å‡»è¿™é‡Œ</a></p>
</blockquote>
<p>å¦‚ä¸Šæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒCompilerå¯¹è±¡åŒ…å«äº†æ‰€æœ‰çš„webpackå¯é…ç½®çš„å†…å®¹ã€‚å¼€å‘æ’ä»¶æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä» compiler å¯¹è±¡ä¸­æ‹¿åˆ°æ‰€æœ‰å’Œ webpack ä¸»ç¯å¢ƒç›¸å…³çš„å†…å®¹ã€‚</p>
<h4 id="compilationå¯¹è±¡">compilationå¯¹è±¡</h4>
<p>compilation å¯¹è±¡åŒ…å«äº†å½“å‰çš„æ¨¡å—èµ„æºã€ç¼–è¯‘ç”Ÿæˆèµ„æºã€æ–‡ä»¶çš„å˜åŒ–ç­‰ã€‚å½“webpackåœ¨å¼€å‘æ¨¡å¼ä¸‹è¿è¡Œæ—¶ï¼Œæ¯å½“æ£€æµ‹åˆ°ä¸€ä¸ªæ–‡ä»¶å‘ç”Ÿæ”¹å˜çš„æ—¶å€™ï¼Œé‚£ä¹ˆä¸€æ¬¡æ–°çš„ Compilationå°†ä¼šè¢«åˆ›å»ºã€‚ä»è€Œç”Ÿæˆä¸€ç»„æ–°çš„ç¼–è¯‘èµ„æºã€‚</p>
<p>Compilerå¯¹è±¡ ä¸ Compilation å¯¹è±¡ çš„åŒºåˆ«æ˜¯ï¼šCompilerä»£è¡¨äº†æ˜¯æ•´ä¸ªwebpackä»å¯åŠ¨åˆ°å…³é—­çš„ç”Ÿå‘½å‘¨æœŸã€‚Compilation å¯¹è±¡åªä»£è¡¨äº†ä¸€æ¬¡æ–°çš„ç¼–è¯‘ã€‚</p>
<p>Compilerå¯¹è±¡çš„äº‹ä»¶é’©å­:</p>
<pre><code>é’©å­               ä½œç”¨                     å‚æ•°               ç±»å‹
after-plugins     è®¾ç½®å®Œä¸€ç»„åˆå§‹åŒ–æ’ä»¶ä¹‹å    compiler          sync
after-resolvers   è®¾ç½®å®Œ resolvers ä¹‹å     compiler          sync
run               åœ¨è¯»å–è®°å½•ä¹‹å‰             compiler          async
compile           åœ¨åˆ›å»ºæ–° compilationä¹‹å‰  compilationParams  sync
compilation       compilation åˆ›å»ºå®Œæˆ      compilation        sync
emit              åœ¨ç”Ÿæˆèµ„æºå¹¶è¾“å‡ºåˆ°ç›®å½•ä¹‹å‰  compilation        async
after-emit        åœ¨ç”Ÿæˆèµ„æºå¹¶è¾“å‡ºåˆ°ç›®å½•ä¹‹å  compilation        async
done              å®Œæˆç¼–è¯‘                  stats              sync
</code></pre>
<blockquote>
<p><a href="https://github.com/webpack/webpack/blob/eca7bad8de54c39b9cb8b138793362b8a17ac11b/lib/Compiler.js#L32">æºç åœ°å€</a></p>
</blockquote>
<h4 id="ç†è§£webpackä¸­çš„äº‹ä»¶æµ">ç†è§£webpackä¸­çš„äº‹ä»¶æµ</h4>
<p>æˆ‘ä»¬å¯ä»¥æŠŠwebpackç†è§£ä¸ºä¸€æ¡ç”Ÿäº§çº¿ï¼Œéœ€è¦ç»è¿‡ä¸€ç³»åˆ—å¤„ç†æµç¨‹åæ‰èƒ½å°†æºæ–‡ä»¶è½¬æ¢æˆè¾“å‡ºç»“æœã€‚<br>
è¿™æ¡ç”Ÿäº§çº¿ä¸Šçš„æ¯ä¸ªå¤„ç†æµç¨‹çš„èŒè´£éƒ½æ˜¯å•ä¸€çš„ï¼Œå¤šä¸ªæµç¨‹ä¹‹é—´ä¼šå­˜åœ¨ä¾èµ–å…³ç³»ï¼Œåªæœ‰å®Œæˆå½“å‰å¤„ç†åæ‰èƒ½äº¤ç»™ä¸‹ä¸€ä¸ªæµç¨‹å»å¤„ç†ã€‚</p>
<p>æˆ‘ä»¬çš„æ’ä»¶å°±åƒä¸€ä¸ªæ’å…¥åˆ°ç”Ÿäº§çº¿ä¸­çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œåœ¨ç‰¹å®šçš„æ—¶æœºå¯¹ç”Ÿäº§çº¿ä¸Šçš„èµ„æºä¼šåšå¤„ç†ã€‚webpackå®ƒæ˜¯é€šè¿‡ Tapableæ¥ç»„ç»‡è¿™æ¡å¤æ‚çš„ç”Ÿäº§çº¿çš„ã€‚</p>
<p>webpackåœ¨è¿è¡Œçš„è¿‡ç¨‹ä¸­ä¼šå¹¿æ’­äº‹ä»¶ï¼Œæ’ä»¶åªéœ€è¦å…³å¿ƒç›‘å¬å®ƒçš„äº‹ä»¶ï¼Œå°±èƒ½åŠ å…¥åˆ°è¿™æ¡ç”Ÿäº§çº¿ä¸­ã€‚ç„¶åä¼šæ‰§è¡Œç›¸å…³çš„æ“ä½œã€‚<br>
webpackçš„äº‹ä»¶æµæœºåˆ¶å®ƒèƒ½ä¿è¯äº†æ’ä»¶çš„æœ‰åºæ€§ï¼Œä½¿æ•´ä¸ªç³»ç»Ÿçš„æ‰©å±•æ€§å¥½ã€‚äº‹ä»¶æµæœºåˆ¶ä½¿ç”¨äº†è§‚å¯Ÿè€…æ¨¡å¼æ¥å®ç°çš„ã€‚æ¯”å¦‚å¦‚ä¸‹ä»£ç ï¼š</p>
<pre><code>/*
 * å¹¿æ’­äº‹ä»¶
 * myPlugin-name ä¸ºäº‹ä»¶åç§°
 * params ä¸ºé™„å¸¦çš„å‚æ•°
*/

compiler.apply('myPlugin-name', params); // myPlugin-nameéšä¾¿å†™ï¼Œå°±æ˜¯ä¸€ä¸ªåå­—

/*
 * ç›‘å¬åç§°ä¸º 'myPlugin-name' çš„äº‹ä»¶ï¼Œå½“ myPlugin-name äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå‡½æ•°å°±ä¼šæ‰§è¡Œã€‚
*/

compiler.hooks.myPlugin-name.tap('myPlugin-name', function(params) {
  
});
</code></pre>
<h3 id="æ’ä»¶ä¸­å¸¸ç”¨çš„api">æ’ä»¶ä¸­å¸¸ç”¨çš„API</h3>
<h4 id="compilerç”Ÿå‘½å‘¨æœŸé’©å­">compilerç”Ÿå‘½å‘¨æœŸé’©å­</h4>
<p><a href="https://www.webpackjs.com/api/compiler-hooks/">å®˜æ–¹æ–‡æ¡£</a></p>
<blockquote>
<p>Compiler æ”¯æŒå¯ä»¥ç›‘æ§æ–‡ä»¶ç³»ç»Ÿçš„<a href="https://www.webpackjs.com/api/node/#watching">ç›‘å¬(watching)</a>æœºåˆ¶ï¼Œå¹¶ä¸”åœ¨æ–‡ä»¶ä¿®æ”¹æ—¶é‡æ–°ç¼–è¯‘ã€‚å½“å¤„äºç›‘å¬æ¨¡å¼(watch mode)æ—¶ï¼Œcompiler ä¼šè§¦å‘è¯¸å¦‚ watchRun, watchClose å’Œ invalid ç­‰é¢å¤–çš„äº‹ä»¶ã€‚é€šå¸¸ç”¨äºå¼€å‘ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œä¹Ÿå¸¸å¸¸ä¼šåœ¨ webpack-dev-server è¿™äº›å·¥å…·çš„åº•å±‚ä¹‹ä¸‹è°ƒç”¨ï¼Œç”±æ­¤å¼€å‘äººå‘˜æ— é¡»æ¯æ¬¡éƒ½ä½¿ç”¨æ‰‹åŠ¨æ–¹å¼é‡æ–°ç¼–è¯‘ã€‚è¿˜å¯ä»¥é€šè¿‡ CLI è¿›å…¥ç›‘å¬æ¨¡å¼ã€‚</p>
</blockquote>
<p>ç›¸å…³é’©å­ï¼š<br>
ä»¥ä¸‹ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°ï¼Œæ˜¯ç”± compiler æš´éœ²ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼è®¿é—®ï¼š</p>
<pre><code>compiler.hooks.someHook.tap(...)
</code></pre>
<p>å–å†³äºä¸åŒçš„é’©å­ç±»å‹ï¼Œä¹Ÿå¯ä»¥åœ¨æŸäº›é’©å­ä¸Šè®¿é—® tapAsync å’Œ tapPromiseã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:center">ç”Ÿå‘½å‘¨æœŸ</th>
<th style="text-align:center">å¯¹åº”hooks</th>
<th style="text-align:center">æ‰§è¡Œæ—¶æœº</th>
<th style="text-align:center">å‚æ•°</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">entryOption</td>
<td style="text-align:center">SyncBailHook</td>
<td style="text-align:center">åœ¨ entry é…ç½®é¡¹å¤„ç†è¿‡ä¹‹åï¼Œæ‰§è¡Œæ’ä»¶ã€‚</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">afterPlugins</td>
<td style="text-align:center">SyncHook</td>
<td style="text-align:center">è®¾ç½®å®Œåˆå§‹æ’ä»¶ä¹‹åï¼Œæ‰§è¡Œæ’ä»¶ã€‚</td>
<td style="text-align:center">compiler</td>
</tr>
<tr>
<td style="text-align:center">afterResolvers</td>
<td style="text-align:center">SyncHook</td>
<td style="text-align:center">resolver å®‰è£…å®Œæˆä¹‹åï¼Œæ‰§è¡Œæ’ä»¶ã€‚</td>
<td style="text-align:center">compiler</td>
</tr>
<tr>
<td style="text-align:center">environment</td>
<td style="text-align:center">SyncHook</td>
<td style="text-align:center">environment å‡†å¤‡å¥½ä¹‹åï¼Œæ‰§è¡Œæ’ä»¶ã€‚</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">afterEnvironment</td>
<td style="text-align:center">SyncHook</td>
<td style="text-align:center">environment å®‰è£…å®Œæˆä¹‹åï¼Œæ‰§è¡Œæ’ä»¶ã€‚</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">beforeRun</td>
<td style="text-align:center">AsyncSeriesHook</td>
<td style="text-align:center">compiler.run() æ‰§è¡Œä¹‹å‰ï¼Œæ·»åŠ ä¸€ä¸ªé’©å­ã€‚</td>
<td style="text-align:center">compiler</td>
</tr>
<tr>
<td style="text-align:center">run</td>
<td style="text-align:center">AsyncSeriesHook</td>
<td style="text-align:center">å¼€å§‹è¯»å– records ä¹‹å‰ï¼Œé’©å…¥(hook into) compilerã€‚</td>
<td style="text-align:center">compiler</td>
</tr>
<tr>
<td style="text-align:center">watchRun</td>
<td style="text-align:center">AsyncSeriesHook</td>
<td style="text-align:center">ç›‘å¬æ¨¡å¼ä¸‹ï¼Œä¸€ä¸ªæ–°çš„ç¼–è¯‘(compilation)è§¦å‘ä¹‹åï¼Œæ‰§è¡Œä¸€ä¸ªæ’ä»¶ï¼Œä½†æ˜¯æ˜¯åœ¨å®é™…ç¼–è¯‘å¼€å§‹ä¹‹å‰ã€‚</td>
<td style="text-align:center">compiler</td>
</tr>
<tr>
<td style="text-align:center">normalModuleFactory</td>
<td style="text-align:center">SyncHook</td>
<td style="text-align:center">NormalModuleFactory åˆ›å»ºä¹‹åï¼Œæ‰§è¡Œæ’ä»¶ã€‚</td>
<td style="text-align:center">normalModuleFactory</td>
</tr>
<tr>
<td style="text-align:center">contextModuleFactory</td>
<td style="text-align:center"></td>
<td style="text-align:center">ContextModuleFactory åˆ›å»ºä¹‹åï¼Œæ‰§è¡Œæ’ä»¶ã€‚</td>
<td style="text-align:center">contextModuleFactory</td>
</tr>
<tr>
<td style="text-align:center">beforeCompile</td>
<td style="text-align:center">AsyncSeriesHook</td>
<td style="text-align:center">ç¼–è¯‘(compilation)å‚æ•°åˆ›å»ºä¹‹åï¼Œæ‰§è¡Œæ’ä»¶ã€‚</td>
<td style="text-align:center">compilationParams</td>
</tr>
<tr>
<td style="text-align:center">compile</td>
<td style="text-align:center">SyncHook</td>
<td style="text-align:center">ä¸€ä¸ªæ–°çš„ç¼–è¯‘(compilation)åˆ›å»ºä¹‹åï¼Œé’©å…¥(hook into) compilerã€‚</td>
<td style="text-align:center">compilationParams</td>
</tr>
<tr>
<td style="text-align:center">thisCompilation</td>
<td style="text-align:center">SyncHook</td>
<td style="text-align:center">è§¦å‘ compilation äº‹ä»¶ä¹‹å‰æ‰§è¡Œï¼ˆæŸ¥çœ‹ä¸‹é¢çš„ compilationï¼‰</td>
<td style="text-align:center">compilation</td>
</tr>
<tr>
<td style="text-align:center">compilation</td>
<td style="text-align:center">SyncHook</td>
<td style="text-align:center">ç¼–è¯‘(compilation)åˆ›å»ºä¹‹åï¼Œæ‰§è¡Œæ’ä»¶</td>
<td style="text-align:center">compilation</td>
</tr>
<tr>
<td style="text-align:center">make</td>
<td style="text-align:center">AsyncParallelHook</td>
<td style="text-align:center"></td>
<td style="text-align:center">compilation</td>
</tr>
<tr>
<td style="text-align:center">afterCompile</td>
<td style="text-align:center">AsyncSeriesHook</td>
<td style="text-align:center"></td>
<td style="text-align:center">compilation</td>
</tr>
<tr>
<td style="text-align:center">shouldEmit</td>
<td style="text-align:center">SyncBailHook</td>
<td style="text-align:center">æ­¤æ—¶è¿”å› true/falseã€‚</td>
<td style="text-align:center">compilation</td>
</tr>
<tr>
<td style="text-align:center">needAdditionalPass</td>
<td style="text-align:center">SyncBailHook</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">emit</td>
<td style="text-align:center">AsyncSeriesHook</td>
<td style="text-align:center">ç”Ÿæˆèµ„æºåˆ° output ç›®å½•ä¹‹å‰ã€‚</td>
<td style="text-align:center">compilation</td>
</tr>
<tr>
<td style="text-align:center">afterEmit</td>
<td style="text-align:center">AsyncSeriesHook</td>
<td style="text-align:center">ç”Ÿæˆèµ„æºåˆ° output ç›®å½•ä¹‹åã€‚</td>
<td style="text-align:center">compilation</td>
</tr>
<tr>
<td style="text-align:center">done</td>
<td style="text-align:center">SyncHook</td>
<td style="text-align:center">ç¼–è¯‘(compilation)å®Œæˆ</td>
<td style="text-align:center">stats</td>
</tr>
<tr>
<td style="text-align:center">failed</td>
<td style="text-align:center">SyncHook</td>
<td style="text-align:center">ç¼–è¯‘(compilation)å¤±è´¥</td>
<td style="text-align:center">error</td>
</tr>
<tr>
<td style="text-align:center">invalid</td>
<td style="text-align:center">SyncHook</td>
<td style="text-align:center">ç›‘å¬æ¨¡å¼ä¸‹ï¼Œç¼–è¯‘æ— æ•ˆæ—¶</td>
<td style="text-align:center">fileName, changeTime</td>
</tr>
<tr>
<td style="text-align:center">watchClose</td>
<td style="text-align:center">SyncHook</td>
<td style="text-align:center">ç›‘å¬æ¨¡å¼åœæ­¢</td>
<td style="text-align:center"></td>
</tr>
</tbody>
</table>
<h4 id="è¯»å–è¾“å‡ºèµ„æº-æ¨¡å—åŠä¾èµ–">è¯»å–è¾“å‡ºèµ„æºã€æ¨¡å—åŠä¾èµ–</h4>
<p>åœ¨æˆ‘ä»¬çš„emité’©å­äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œè¡¨ç¤ºçš„å«ä¹‰æ˜¯ï¼šæºæ–‡ä»¶çš„è½¬æ¢å’Œç»„è£…å·²ç»å®Œæˆäº†ï¼Œåœ¨è¿™é‡Œäº‹ä»¶é’©å­é‡Œé¢æˆ‘ä»¬å¯ä»¥è¯»å–åˆ°æœ€ç»ˆå°†è¾“å‡ºçš„èµ„æºã€ä»£ç å—ã€æ¨¡å—åŠå¯¹åº”çš„ä¾èµ–æ–‡ä»¶ã€‚å¹¶ä¸”æˆ‘ä»¬è¿˜å¯ä»¥è¾“å‡ºèµ„æºæ–‡ä»¶çš„å†…å®¹ã€‚æ¯”å¦‚æ’ä»¶ä»£ç å¦‚ä¸‹:</p>
<pre><code class="language-js">class MyPlugin {
  apply(compiler) {
    compiler.plugin('emit', function(compilation, callback) {
      // compilation.chunks æ˜¯å­˜æ”¾äº†æ‰€æœ‰çš„ä»£ç å—ï¼Œæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæˆ‘ä»¬éœ€è¦éå†
      compilation.chunks.forEach(function(chunk) {
        /*
         * chunk ä»£è¡¨ä¸€ä¸ªä»£ç å—ï¼Œä»£ç å—å®ƒæ˜¯ç”±å¤šä¸ªæ¨¡å—ç»„æˆçš„ã€‚
         * æˆ‘ä»¬å¯ä»¥é€šè¿‡ chunk.forEachModule èƒ½è¯»å–ç»„æˆä»£ç å—çš„æ¯ä¸ªæ¨¡å—
        */
        chunk.forEachModule(function(module) {
          // module ä»£è¡¨ä¸€ä¸ªæ¨¡å—ã€‚
          // module.fileDependencies å­˜æ”¾å½“å‰æ¨¡å—çš„æ‰€æœ‰ä¾èµ–çš„æ–‡ä»¶è·¯å¾„ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ•°ç»„
          module.fileDependencies.forEach(function(filepath) {
            console.log(filepath);
          });
        });
        /*
         webpack ä¼šæ ¹æ®chunkå»ç”Ÿæˆè¾“å‡ºçš„æ–‡ä»¶èµ„æºï¼Œæ¯ä¸ªchunkéƒ½å¯¹åº”ä¸€ä¸ªåŠä»¥ä¸Šçš„è¾“å‡ºæ–‡ä»¶ã€‚
         æ¯”å¦‚åœ¨ Chunkä¸­åŒ…å«äº†css æ¨¡å—å¹¶ä¸”ä½¿ç”¨äº† ExtractTextPlugin æ—¶ï¼Œ
         é‚£ä¹ˆè¯¥Chunk å°±ä¼šç”Ÿæˆ .js å’Œ .css ä¸¤ä¸ªæ–‡ä»¶
        */
        chunk.files.forEach(function(filename) {
          // compilation.assets æ˜¯å­˜æ”¾å½“å‰æ‰€æœ‰å³å°†è¾“å‡ºçš„èµ„æºã€‚
          // è°ƒç”¨ä¸€ä¸ªè¾“å‡ºèµ„æºçš„ source() æ–¹æ³•èƒ½è·å–åˆ°è¾“å‡ºèµ„æºçš„å†…å®¹
          const source = compilation.assets[filename].source();
        });
      });
      /*
       è¯¥äº‹ä»¶æ˜¯å¼‚æ­¥äº‹ä»¶ï¼Œå› æ­¤è¦è°ƒç”¨ callback æ¥é€šçŸ¥æœ¬æ¬¡çš„ webpackäº‹ä»¶ç›‘å¬ç»“æŸã€‚
       å¦‚æœæˆ‘ä»¬æ²¡æœ‰è°ƒç”¨callback(); é‚£ä¹ˆwebpackå°±ä¼šä¸€ç›´å¡åœ¨è¿™é‡Œä¸ä¼šå¾€åæ‰§è¡Œã€‚
      */
      callback();
    })
  }
}
</code></pre>
<h4 id="ç›‘å¬æ–‡ä»¶å˜åŒ–">ç›‘å¬æ–‡ä»¶å˜åŒ–</h4>
<p>webpackè¯»å–æ–‡ä»¶çš„æ—¶å€™ï¼Œå®ƒä¼šä»å…¥å£æ¨¡å—å»è¯»å–ï¼Œç„¶åä¾æ¬¡æ‰¾å‡ºæ‰€æœ‰çš„ä¾èµ–æ¨¡å—ã€‚å½“å…¥å£æ¨¡å—æˆ–ä¾èµ–çš„æ¨¡å—å‘ç”Ÿæ”¹å˜çš„æ—¶å€™ï¼Œé‚£ä¹ˆå°±ä¼šè§¦å‘ä¸€æ¬¡æ–°çš„ Compilationã€‚</p>
<p>åœ¨æˆ‘ä»¬å¼€å‘æ’ä»¶çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“æ˜¯é‚£ä¸ªæ–‡ä»¶å‘ç”Ÿæ”¹å˜ï¼Œå¯¼è‡´äº†æ–°çš„Compilation, æˆ‘ä»¬å¯ä»¥æ·»åŠ å¦‚ä¸‹ä»£ç è¿›è¡Œç›‘å¬ã€‚</p>
<pre><code class="language-js">// å½“ä¾èµ–çš„æ–‡ä»¶å‘ç”Ÿæ”¹å˜çš„æ—¶å€™ ä¼šè§¦å‘ watch-run äº‹ä»¶
class MyPlugin {
  apply(compiler) {
    compiler.plugin('watch-run', (watching, callback) =&gt; {
      // è·å–å‘ç”Ÿå˜æ¢çš„æ–‡ä»¶åˆ—è¡¨
      const changedFiles = watching.compiler.watchFileSystem.watcher.mtimes;
      // changedFiles æ ¼å¼ä¸ºé”®å€¼å¯¹çš„å½¢å¼ï¼Œå½“é”®ä¸ºå‘ç”Ÿå˜åŒ–çš„æ–‡ä»¶è·¯å¾„
      if (changedFiles[filePath] !== undefined) {
        // å¯¹åº”çš„æ–‡ä»¶å°±å‘ç”Ÿäº†å˜åŒ–äº†
      }
      callback();
    });

    /*
     é»˜è®¤æƒ…å†µä¸‹Webpackåªä¼šç›‘å¬å…¥å£æ–‡ä»¶æˆ–å…¶ä¾èµ–çš„æ¨¡å—æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œä½†æ˜¯åœ¨æœ‰äº›æƒ…å†µä¸‹æ¯”å¦‚htmlæ–‡ä»¶å‘ç”Ÿæ”¹å˜çš„æ—¶å€™ï¼Œé‚£ä¹ˆwebpack
     å°±ä¼šå»ç›‘å¬htmlæ–‡ä»¶çš„å˜åŒ–ã€‚å› æ­¤å°±ä¸ä¼šé‡æ–°è§¦å‘æ–°çš„ Compilationã€‚å› æ­¤ä¸ºäº†ç›‘å¬htmlæ–‡ä»¶çš„å˜åŒ–ï¼Œæˆ‘ä»¬éœ€è¦æŠŠhtmlæ–‡ä»¶åŠ å…¥åˆ°
     ä¾èµ–åˆ—è¡¨ä¸­ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š
    */
    compiler.plugin('after-compile', (compilation, callback) =&gt; {
      /*
       å¦‚ä¸‹çš„å‚æ•°filePathæ˜¯htmlæ–‡ä»¶è·¯å¾„ï¼Œæˆ‘ä»¬æŠŠHTMLæ–‡ä»¶æ·»åŠ åˆ°æ–‡ä»¶ä¾èµ–è¡¨ä¸­ï¼Œç„¶åæˆ‘ä»¬çš„webpackä¼šå»ç›‘å¬htmlæ¨¡å—æ–‡ä»¶ï¼Œ
       htmlæ¨¡æ¿æ–‡ä»¶å‘ç”Ÿæ”¹å˜çš„æ—¶å€™ï¼Œä¼šé‡æ–°å¯åŠ¨ä¸‹é‡æ–°ç¼–è¯‘ä¸€ä¸ªæ–°çš„ Compilation.
      */
      compilation.fileDependencies.push(filePath);
      callback();
    })
  }
}
</code></pre>
<h4 id="ä¿®æ”¹è¾“å‡ºèµ„æº">ä¿®æ”¹è¾“å‡ºèµ„æº</h4>
<p>æˆ‘ä»¬åœ¨ç¬¬ä¸€ç‚¹è¯´è¿‡ï¼šåœ¨æˆ‘ä»¬çš„emité’©å­äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œè¡¨ç¤ºçš„å«ä¹‰æ˜¯ï¼šæºæ–‡ä»¶çš„è½¬æ¢å’Œç»„è£…å·²ç»å®Œæˆäº†ï¼Œåœ¨è¿™é‡Œäº‹ä»¶é’©å­é‡Œé¢æˆ‘ä»¬å¯ä»¥è¯»å–åˆ°æœ€ç»ˆå°†è¾“å‡ºçš„èµ„æºã€ä»£ç å—ã€æ¨¡å—åŠå¯¹åº”çš„ä¾èµ–æ–‡ä»¶ã€‚å› æ­¤å¦‚æœæˆ‘ä»¬ç°åœ¨è¦ä¿®æ”¹è¾“å‡ºèµ„æºçš„å†…å®¹çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨emitäº‹ä»¶ä¸­å»åšä¿®æ”¹ã€‚é‚£ä¹ˆæ‰€æœ‰è¾“å‡ºçš„èµ„æºä¼šå­˜æ”¾åœ¨ compilation.assetsä¸­ï¼Œcompilation.assetsæ˜¯ä¸€ä¸ªé”®å€¼å¯¹ï¼Œé”®ä¸ºéœ€è¦è¾“å‡ºçš„æ–‡ä»¶åï¼Œå€¼ä¸ºæ–‡ä»¶å¯¹åº”çš„å†…å®¹ã€‚å¦‚ä¸‹ä»£ç ï¼š</p>
<pre><code class="language-js">class MyPlugin {
  apply(compiler) {
    compiler.plugin('emit', (compilation, callback) =&gt; {
      // è®¾ç½®åç§°ä¸º fileName çš„è¾“å‡ºèµ„æº
      compilation.assets[fileName] = {
        // è¿”å›æ–‡ä»¶å†…å®¹
        source: () =&gt; {
          // fileContent å³å¯ä»¥ä»£è¡¨æ–‡æœ¬æ–‡ä»¶çš„å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä»£è¡¨äºŒè¿›åˆ¶æ–‡ä»¶çš„buffer
          return fileContent;
        },
        // è¿”å›æ–‡ä»¶å¤§å°
        size: () =&gt; {
          return Buffer.byteLength(fileContent, 'utf8');
        }
      };
      callback();
    });
    // è¯»å– compilation.assets ä»£ç å¦‚ä¸‹ï¼š
    compiler.plugin('emit', (compilation, callback) =&gt; {
      // è¯»å–åç§°ä¸º fileName çš„è¾“å‡ºèµ„æº
      const asset = compilation.assets[fileName];
      // è·å–è¾“å‡ºèµ„æºçš„å†…å®¹
      asset.source();
      // è·å–è¾“å‡ºèµ„æºçš„æ–‡ä»¶å¤§å°
      asset.size();
      callback();
    });
  }
}
</code></pre>
<h4 id="åˆ¤æ–­webpackä½¿ç”¨äº†å“ªäº›æ’ä»¶">åˆ¤æ–­webpackä½¿ç”¨äº†å“ªäº›æ’ä»¶</h4>
<p>åœ¨æˆ‘ä»¬å¼€å‘ä¸€ä¸ªæ’ä»¶çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®å½“å‰é…ç½®æ˜¯å¦ä½¿ç”¨äº†å…¶ä»–æŸä¸ªæ’ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¯»å–webpackæŸä¸ªæ’ä»¶é…ç½®çš„æƒ…å†µï¼Œæ¯”å¦‚æ¥åˆ¤æ–­æˆ‘ä»¬å½“å‰æ˜¯å¦ä½¿ç”¨äº† HtmlWebpackPlugin æ’ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-js">/*
 åˆ¤æ–­å½“å‰é…ç½®ä½¿ç”¨äº† HtmlWebpackPlugin æ’ä»¶ã€‚
 compilerå‚æ•°å³ä¸º webpack åœ¨ apply(compiler) ä¸­ä¼ å…¥çš„å‚æ•°
*/

function hasHtmlWebpackPlugin(compiler) {
  // è·å–å½“å‰é…ç½®ä¸‹æ‰€æœ‰çš„æ’ä»¶åˆ—è¡¨
  const plugins = compiler.options.plugins;
  // å»pluginsä¸­å¯»æ‰¾æœ‰æ²¡æœ‰ HtmlWebpackPlugin çš„å®åˆ—
  return plugins.find(plugin =&gt; plugin.__proto__.constructor === HtmlWebpackPlugin) !== null;
}
</code></pre>
<h3 id="å®æˆ˜">å®æˆ˜</h3>
<h4 id="å®ç°ä¸€ä¸ªæ‰“å°æ—¥å¿—çš„logwebpackpluginæ’ä»¶">å®ç°ä¸€ä¸ªæ‰“å°æ—¥å¿—çš„LogWebpackPluginæ’ä»¶</h4>
<pre><code class="language-js">// è¿™ä¸ªæ–‡ä»¶ä¸ºäº†è§‚çœ‹æ›´ç›´è§‚ï¼Œå…ˆæ”¾åˆ°webpack.config.jsä¸­ï¼ŒçœŸæ­£ä½¿ç”¨æ—¶å¯ä»¥å°†ä½ çš„è‡ªå®šä¹‰webpackæ’ä»¶å°è£…åˆ°ä½ ä»¬çš„å‰ç«¯ç»„ä»¶åº“ä¸­ã€‚
class LogWebpackPlugin {
  constructor(doneCallback, emitCallback) {
    this.emitCallback = emitCallback
    this.doneCallback = doneCallback
  }
  apply(compiler) {
    compiler.hooks.emit.tap('LogWebpackPlugin', () =&gt; {
      // åœ¨ emit äº‹ä»¶ä¸­å›è°ƒ emitCallback
      this.emitCallback();
    });
    compiler.hooks.done.tap('LogWebpackPlugin', (err) =&gt; {
      // åœ¨ done äº‹ä»¶ä¸­å›è°ƒ doneCallback
      this.doneCallback();
    });
    compiler.hooks.compilation.tap('LogWebpackPlugin', () =&gt; {
      // compilationï¼ˆ'ç¼–è¯‘å™¨'å¯¹'ç¼–è¯‘ing'è¿™ä¸ªäº‹ä»¶çš„ç›‘å¬ï¼‰
      console.log(&quot;The compiler is starting a new compilation...&quot;)
    });
    compiler.hooks.compile.tap('LogWebpackPlugin', () =&gt; {
      // compileï¼ˆ'ç¼–è¯‘å™¨'å¯¹'å¼€å§‹ç¼–è¯‘'è¿™ä¸ªäº‹ä»¶çš„ç›‘å¬ï¼‰
      console.log(&quot;The compiler is starting to compile...&quot;)
    });
  }
}


// ä½¿ç”¨
module.exports = {
  plugins: [
    new LogWebpackPlugin(() =&gt; {
      // Webpack æ¨¡å—å®Œæˆè½¬æ¢æˆåŠŸ
      console.log('emit äº‹ä»¶å‘ç”Ÿå•¦ï¼Œæ‰€æœ‰æ¨¡å—çš„è½¬æ¢å’Œä»£ç å—å¯¹åº”çš„æ–‡ä»¶å·²ç»ç”Ÿæˆå¥½~')
    } , () =&gt; {
      // Webpack æ„å»ºæˆåŠŸï¼Œå¹¶ä¸”æ–‡ä»¶è¾“å‡ºäº†åä¼šæ‰§è¡Œåˆ°è¿™é‡Œï¼Œåœ¨è¿™é‡Œå¯ä»¥åšå‘å¸ƒæ–‡ä»¶æ“ä½œ
      console.log('done äº‹ä»¶å‘ç”Ÿå•¦ï¼ŒæˆåŠŸæ„å»ºå®Œæˆ~')
    })
  ]
}
</code></pre>
<h4 id="ç¼–å†™å»é™¤ç”Ÿæˆ-bundlejs-ä¸­å¤šä½™çš„æ³¨é‡Šçš„æ’ä»¶">ç¼–å†™å»é™¤ç”Ÿæˆ bundle.js ä¸­å¤šä½™çš„æ³¨é‡Šçš„æ’ä»¶</h4>
<pre><code class="language-js">class MyPlugin {
  constructor(options) {
    this.options = options;
    this.externalModules = {};
  }
  apply(compiler) {
    var reg = /(&quot;([^\\\&quot;]*(\\.)?)*&quot;)|('([^\\\']*(\\.)?)*')|(\/{2,}.*?(\r|\n))|(\/\*(\n|.)*?\*\/)|(\/\*\*\*\*\*\*\/)/g;
    compiler.hooks.emit.tap('CodeBeautify', (compilation) =&gt; {
      Object.keys(compilation.assets).forEach((data) =&gt; {
        console.log(data);
        let content = compilation.assets[data].source(); // è·å–å¤„ç†çš„æ–‡æœ¬
        content = content.replace(reg, function (word) { // å»é™¤æ³¨é‡Šåçš„æ–‡æœ¬
          return /^\/{2,}/.test(word) || /^\/\*!/.test(word) || /^\/\*{3,}\//.test(word) ? &quot;&quot; : word;
        });
        compilation.assets[data] = {
          source() {
            return content;
          },
          size() {
            return content.length;
          }
        }
      });
    });
  }
}
module.exports = MyPlugin;
</code></pre>
<p>è¿™ä¸ªjsä»£ç çš„çœŸæ­£çš„å«ä¹‰æ‰æ˜¯æˆ‘ä»¬ä»Šå¤©è¦è®²åˆ°çš„ï¼Œè¿™ä¸ªæ’ä»¶æœ€ä¸»è¦ä½œç”¨æ˜¯ å»é™¤æ³¨é‡Šåçš„æ–‡æœ¬ã€‚</p>
<ol>
<li>
<p>ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬ä½¿ç”¨ compiler.hooks.emit é’©å­å‡½æ•°ã€‚åœ¨ç”Ÿæˆèµ„æºå¹¶è¾“å‡ºåˆ°ç›®å½•ä¹‹å‰è§¦å‘è¯¥å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´å°†ç¼–è¯‘å¥½çš„ä»£ç å‘å°„åˆ°æŒ‡å®šçš„streamä¸­å°±ä¼šè§¦å‘ï¼Œç„¶åæˆ‘ä»¬ä»å›è°ƒå‡½æ•°è¿”å›çš„ compilation å¯¹è±¡ä¸Šå¯ä»¥æ‹¿åˆ°ç¼–è¯‘å¥½çš„ stream.</p>
</li>
<li>
<p>è®¿é—®compilationå¯¹è±¡ï¼Œcompilationå†…éƒ¨ä¼šè¿”å›å¾ˆå¤šå†…éƒ¨å¯¹è±¡ï¼Œè¿™è¾¹å…ˆä¸æ‰“å°äº†ï¼Œå› ä¸ºæ‰“å°çš„è¯ç›´æ¥ä¼šå¡æ­»æ‰ï¼Œè¦ç­‰å¾ˆé•¿æ—¶é—´æ‰ä¼šæ‰“å°å‡ºæ¥ï¼Œä½ ä»¬è‡ªå·±å¯ä»¥è¯•è¯•ï¼›ç„¶åæˆ‘ä»¬éå† assets.</p>
</li>
</ol>
<pre><code class="language-js">Object.keys(compilation.assets).forEach((data) =&gt; {
  console.log(compilation.assets);
  console.log(8888)
  console.log(data);
});
</code></pre>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br>
<img src="https://weidadeda.github.io/post-images/1644922971138.png" alt="" loading="lazy"></p>
<ul>
<li>assets æ•°ç»„å¯¹è±¡ä¸­çš„keyæ˜¯èµ„æºåã€‚åœ¨å¦‚ä¸Šä»£ç ï¼Œæˆ‘ä»¬é€šè¿‡ Object.key()æ–¹æ³•æ‹¿åˆ°äº†ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š<pre><code>main.css
bundle.js
index.html
</code></pre>
</li>
<li>ç„¶åæˆ‘ä»¬è°ƒç”¨ compilation.assets[data].source(); å¯ä»¥è·å–èµ„æºçš„å†…å®¹ã€‚</li>
<li>ä½¿ç”¨æ­£åˆ™ï¼Œå»æ‰æ³¨é‡Šï¼Œå¦‚ä¸‹ä»£ç ï¼š<pre><code class="language-js">Object.keys(compilation.assets).forEach((data) =&gt; {
  let content = compilation.assets[data].source(); // è·å–å¤„ç†çš„æ–‡æœ¬
  content = content.replace(reg, function (word) { // å»é™¤æ³¨é‡Šåçš„æ–‡æœ¬
      return /^\/{2,}/.test(word) || /^\/\*!/.test(word) || /^\/\*{3,}\//.test(word) ? &quot;&quot; : word;
  });
});
</code></pre>
</li>
<li>æ›´æ–° compilation.assets[data] å¯¹è±¡ï¼Œå¦‚ä¸‹ä»£ç ï¼š<pre><code class="language-js">compilation.assets[data] = {
  source() {
      return content;
  },
  size() {
      return content.length;
  }
}
</code></pre>
</li>
<li>æœ€åä½¿ç”¨<pre><code class="language-js">module.exports = {
  plugins:[
      new MyPlugin(),
  ]
}
</code></pre>
</li>
</ul>
<h4 id="webpack40ä¹‹åç”¨compilerhooksæ³¨å†Œä¹‹å‰ç”¨comlilerpluginæ³¨å†Œä½†ä¸ºäº†ä¿é™©èµ·è§è¿˜æ˜¯ä¸¤ç§åŠæ³•éƒ½å†™è¿™æ ·èƒ½åº”ä»˜æœåŠ¡å™¨æ— webpack4ç‰ˆæœ¬è¯¦è§è¿™ç¯‡æ–‡ç« ">webpack4.0ä¹‹åç”¨compiler.hooksæ³¨å†Œï¼Œä¹‹å‰ç”¨comliler.pluginæ³¨å†Œï¼Œä½†ä¸ºäº†ä¿é™©èµ·è§ï¼Œè¿˜æ˜¯ä¸¤ç§åŠæ³•éƒ½å†™ï¼Œè¿™æ ·èƒ½åº”ä»˜æœåŠ¡å™¨æ— webpack4ç‰ˆæœ¬ï¼Œè¯¦è§ï¼š<a href="https://www.cnblogs.com/dashnowords/p/9572749.html">è¿™ç¯‡æ–‡ç« </a></h4>
<h3 id="æœ€åæ‰©å±•ç®€å•çœ‹äº†å‡ ä¸ªæ’ä»¶ä¹‹åæ˜¯ä¸æ˜¯å¯ä»¥è€ƒè™‘åšäº›å…¶ä»–çš„äº‹æƒ…æ¯”å¦‚åˆ é™¤consolelog-æˆ–è€…æ„å»ºå®Œæˆæ—¶åšä¸€äº›æ–‡ä»¶ä¸Šä¼ cdnçš„æ“ä½œé©¬ä¸ŠåŠ¨æ‰‹å§~">æœ€åæ‰©å±•ï¼šç®€å•çœ‹äº†å‡ ä¸ªæ’ä»¶ä¹‹åï¼Œæ˜¯ä¸æ˜¯å¯ä»¥è€ƒè™‘åšäº›å…¶ä»–çš„äº‹æƒ…ï¼Œæ¯”å¦‚åˆ é™¤console.logã€æˆ–è€…æ„å»ºå®Œæˆæ—¶åšä¸€äº›æ–‡ä»¶ä¸Šä¼ cdnçš„æ“ä½œï¼Œé©¬ä¸ŠåŠ¨æ‰‹å§ï½</h3>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[çŸ­ä¿¡çŸ­é“¾æ¥å”¤èµ·APP]]></title>
        <id>https://weidadeda.github.io/post/duan-xin-duan-lian-jie-huan-qi-app</id>
        <link href="https://weidadeda.github.io/post/duan-xin-duan-lian-jie-huan-qi-app">
        </link>
        <updated>2022-02-10T07:59:08.000Z</updated>
        <content type="html"><![CDATA[<figure data-type="image" tabindex="1"><img src="https://weidadeda.github.io/post-images/1644479995097.png" alt="" loading="lazy"></figure>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[å¾®ä¿¡å…¬ä¼—å·è·å–openidç­‰ä¸€ç³»åˆ—æµç¨‹]]></title>
        <id>https://weidadeda.github.io/post/wei-xin-gong-zhong-hao-huo-qu-openid-deng-yi-xi-lie-liu-cheng</id>
        <link href="https://weidadeda.github.io/post/wei-xin-gong-zhong-hao-huo-qu-openid-deng-yi-xi-lie-liu-cheng">
        </link>
        <updated>2022-02-08T12:49:25.000Z</updated>
        <content type="html"><![CDATA[<h3 id="å…ˆè¯´ä¸‹ä¸ºä»€ä¹ˆè¦è·å–-openid">å…ˆè¯´ä¸‹ä¸ºä»€ä¹ˆè¦è·å– openid?</h3>
<p>å› ä¸ºç”¨æˆ·ç®¡ç†ç±»æ¥å£å¯ä»¥é€šè¿‡openidå¯ä»¥è·å–ç”¨æˆ·çš„ä¸€äº›ä¿¡æ¯çš„.</p>
<h3 id="è¯´åˆ°-openid-å¿…é¡»å…ˆè¯´å¾®ä¿¡æˆæƒç™»å½•çš„è¿‡ç¨‹">è¯´åˆ° openid å¿…é¡»å…ˆè¯´å¾®ä¿¡æˆæƒç™»å½•çš„è¿‡ç¨‹</h3>
<figure data-type="image" tabindex="1"><img src="https://weidadeda.github.io/post-images/1644479416142.png" alt="" loading="lazy"></figure>
<ul>
<li>
<p>å‰ç«¯éœ€è¦åœ¨è¿›å…¥è·¯ç”±çš„æ˜¯beaforEachçš„æ—¶å€™ï¼Œå…ˆå»åˆ¤æ–­é“¾æ¥ä¸Šæœ‰æ²¡æœ‰ openid</p>
</li>
<li>
<p>å¦‚æœæ²¡æœ‰ï¼Œå°±å»è·³è½¬åˆ°æœåŠ¡ç«¯ç»™çš„ä¸€ä¸ªåœ°å€ã€‚å¦‚æœæœ‰ï¼Œå°±ç»§ç»­å¾€ä¸‹èµ°ï¼ˆnext())</p>
</li>
<li>
<p>è¿™ä¸ªæ—¶å€™æœåŠ¡ç«¯ä¼šå¾€ä¸‹é¢çš„é“¾æ¥ï¼ˆhttps://open.weixin.qq.com/connect/oauth2/authorize?appid=APPID&amp;redirect_uri=REDIRECT_URI&amp;response_type=code&amp;scope=SCOPE&amp;state=STATE#wechat_redirectæ¥è·å–codeï¼‰ä¸Šè·³è½¬ï¼Œå»å¼•å¯¼ç”¨æˆ·å»ç‚¹å‡»æˆæƒï¼Œç”¨æˆ·æˆæƒä¹‹åå°±ä¼šé‡å®šå‘åˆ° redirect_uriï¼ˆæœåŠ¡ç«¯çš„åœ°å€ï¼‰</p>
</li>
<li>
<p>åˆ©ç”¨ code è·å– openid ä¹‹å(æœåŠ¡ç«¯å»åš)ï¼ŒæœåŠ¡ç«¯ä¼šè·³è½¬åˆ°å‰ç«¯é¡µé¢(å¸¦ä¸Šopenid)</p>
</li>
</ul>
<p>ä¸‹é¢ä½œä¸ºäº†è§£ï¼š</p>
<p>å¾®ä¿¡æˆæƒä½¿ç”¨çš„æ˜¯ OAuth2.0æˆæƒæ–¹å¼ã€‚ä¸»è¦æœ‰ä»¥ä¸‹ç®€ç•¥çš„æ­¥éª¤ï¼š<br>
ç¬¬ä¸€æ­¥ï¼šç”¨æˆ·åŒæ„æˆæƒï¼Œè·å– code<br>
ã€€ã€€ç¬¬äºŒæ­¥ï¼šé€šè¿‡ codeè·å–ç½‘é¡µæˆæƒaccess_token<br>
ã€€ã€€ç¬¬ä¸‰æ­¥ï¼šåˆ·æ–°access_tokenï¼ˆå¦‚æœéœ€è¦ï¼‰<br>
ã€€ã€€ç¬¬å››æ­¥ï¼šæ‹‰å–ç”¨æˆ·ä¿¡æ¯(éœ€scopeä¸º snsapi_userinfo)</p>
<h3 id="ä¸‹é¢æ¥å…·ä½“apiè¡¨ç¤ºä¸‹æ€ä¹ˆè·å–çš„-code-å’Œ-openid-å§">ä¸‹é¢æ¥å…·ä½“apiè¡¨ç¤ºä¸‹æ€ä¹ˆè·å–çš„ code å’Œ openid å§</h3>
<h3 id="ä¸€è·å–code">ä¸€ï¼šè·å–code:</h3>
<p>é€šè¿‡https://open.weixin.qq.com/connect/oauth2/authorize?appid=APPID&amp;redirect_uri=REDIRECT_URI&amp;response_type=code&amp;scope=SCOPE&amp;state=STATE#wechat_redirectæ¥è·å–code<br>
å‚æ•°ï¼š<br>
APPIDï¼šåº”ç”¨å”¯ä¸€æ ‡è¯†<br>
redirect_uriï¼šæˆæƒåé‡å®šå‘çš„å›è°ƒé“¾æ¥åœ°å€ï¼Œç”¨æˆ·åŒæ„åï¼Œcode ä¼šè‡ªåŠ¨æ·»åŠ åˆ°åé¢ã€‚ï¼ˆè¯·ä½¿ç”¨urlEncodeå¯¹é“¾æ¥è¿›è¡Œå¤„ç† ï¼ˆ$url = urlencode('')ï¼‰ ï¼‰<br>
scopeï¼šæ˜¯åº”ç”¨æˆæƒä½œç”¨åŸŸ ï¼ˆä¸€èˆ¬æœ‰ä¸¤ç§ï¼šä¸€ç§æ˜¯é™é»˜æ–¹å¼ï¼ˆsnsapi_base); ä¸€ç§æ˜¯éé™é»˜æ–¹å¼ï¼ˆsnsapi_userinfoï¼‰ï¼Œéœ€è¦ç”¨æˆ·å»æ‰‹åŠ¨åŒæ„æ‰èƒ½è·å–ç”¨æˆ·ä¿¡æ¯ï¼‰</p>
<p>å¾®ä¿¡ä¸­å°¤å…¶æé†’ï¼šç”±äºæˆæƒæ“ä½œå®‰å…¨ç­‰çº§è¾ƒé«˜ï¼Œæ‰€ä»¥åœ¨å‘èµ·æˆæƒè¯·æ±‚æ—¶ï¼Œå¾®ä¿¡ä¼šå¯¹æˆæƒé“¾æ¥åšæ­£åˆ™å¼ºåŒ¹é…æ ¡éªŒï¼Œå¦‚æœé“¾æ¥çš„å‚æ•°é¡ºåºä¸å¯¹ï¼Œæˆæƒé¡µé¢å°†æ— æ³•æ­£å¸¸è®¿é—®</p>
<p>** code æ˜¯å¾®ä¿¡è‡ªåŠ¨ç”Ÿæˆçš„ã€‚å¹¶ä¸”æ”¾åœ¨redirect_uriï¼ˆé‡å®šå‘åçš„å›è°ƒé“¾æ¥åœ°å€ï¼‰åé¢,å¹¶ä¸”å¸¦ä¸Šcodeå’Œstateå‚æ•°</p>
<p>ä¸Šé¢æåˆ°äº† codeã€‚é‚£ä¹ˆ codeåˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ<br>
code:ä½œä¸ºæ¢å– access_tokençš„ç¥¨æ®ï¼Œæ¯æ¬¡ç”¨æˆ·æˆæƒå¸¦ä¸Šçš„ code éƒ½ä¸ä¸€æ ·ã€‚5åˆ†é’Ÿæœªè¢«ä½¿ç”¨è‡ªåŠ¨è¿‡æœŸï¼ˆè¿‡æœŸçš„è¿™é‡Œä¸‹é¢æœ‰è®²ï¼‰</p>
<h3 id="äºŒç„¶åæˆæƒæˆåŠŸä¹‹å-å¾—åˆ°-code-å°±ç”¨-code-å»è·å–access_token">äºŒï¼šç„¶åæˆæƒæˆåŠŸä¹‹åã€‚å¾—åˆ° codeã€‚å°±ç”¨ code å»è·å–access_token</h3>
<p>https://api.weixin.qq.com/sns/oauth2/access_token?appid=wx41cb8dbd827a16e9&amp;secret=d4624c36b6795d1d99dcf0547af5443d&amp;code=00137323023ab55775be09d6d8e75ffA&amp;grant_type=authorization_code<br>
å‚æ•°è¯´æ˜ï¼š<br>
appidï¼šåº”ç”¨å”¯ä¸€æ ‡è¯†<br>
codeï¼šä¸Šä¸€æ­¥å·²ç»è·å–åˆ°äº†<br>
secretï¼šåº”ç”¨å¯†é’¥AppSecretï¼Œåœ¨å¾®ä¿¡å¼€æ”¾å¹³å°æäº¤åº”ç”¨å®¡æ ¸é€šè¿‡åè·å¾—</p>
<p>æ­£ç¡®çš„è¿”å›<br>
&quot;access_token&quot;:&quot;ACCESS_TOKEN&quot;, // æ¥å£è°ƒç”¨å‡­è¯ &quot;expires_in&quot;:7200, // access_tokenæ¥å£è°ƒç”¨å‡­è¯è¶…æ—¶æ—¶é—´ &quot;refresh_token&quot;:&quot;REFRESH_TOKEN&quot;, // ç”¨æˆ·åˆ·æ–°access_token &quot;openid&quot;:&quot;OPENID&quot;, // æˆæƒç”¨æˆ·å”¯ä¸€æ ‡è¯† &quot;scope&quot;:&quot;SCOPE&quot;, // ä½œç”¨åŸŸ ç­‰</p>
<h3 id="ä¸‰é€šè¿‡access_token-openidè·å–ç”¨æˆ·ä¿¡æ¯">ä¸‰ï¼šé€šè¿‡access_tokenã€openidè·å–ç”¨æˆ·ä¿¡æ¯</h3>
<p>https://api.weixin.qq.com/sns/userinfo?access_token=ACCESS_TOKEN&amp;openid=OPENID<br>
å°±ä¼šå¾—åˆ°ç”¨æˆ·çš„ä¿¡æ¯ï¼š<br>
å¾—åˆ°å‚æ•°ï¼š<br>
openidï¼šç”¨æˆ·çš„å”¯ä¸€æ ‡è¯†<br>
nicknameï¼šç”¨æˆ·æ˜µç§°<br>
sexï¼š ç”·å¥³<br>
ç­‰ã€‚ã€‚ã€‚<br>
ç‰¹åˆ«æ³¨æ„ï¼š<br>
1ã€Appsecret æ˜¯åº”ç”¨æ¥å£ä½¿ç”¨å¯†é’¥ï¼Œæ³„æ¼åå°†å¯èƒ½å¯¼è‡´åº”ç”¨æ•°æ®æ³„æ¼ã€åº”ç”¨çš„ç”¨æˆ·æ•°æ®æ³„æ¼ç­‰é«˜é£é™©åæœï¼›å­˜å‚¨åœ¨å®¢æˆ·ç«¯ï¼Œææœ‰å¯èƒ½è¢«æ¶æ„çªƒå–ï¼ˆå¦‚åç¼–è¯‘è·å–Appsecretï¼‰ï¼› 2ã€access_token ä¸ºç”¨æˆ·æˆæƒç¬¬ä¸‰æ–¹åº”ç”¨å‘èµ·æ¥å£è°ƒç”¨çš„å‡­è¯ï¼ˆç›¸å½“äºç”¨æˆ·ç™»å½•æ€ï¼‰ï¼Œå­˜å‚¨åœ¨å®¢æˆ·ç«¯ï¼Œå¯èƒ½å‡ºç°æ¶æ„è·å–access_token åå¯¼è‡´çš„ç”¨æˆ·æ•°æ®æ³„æ¼ã€ç”¨æˆ·å¾®ä¿¡ç›¸å…³æ¥å£åŠŸèƒ½è¢«æ¶æ„å‘èµ·ç­‰è¡Œä¸ºï¼› 3ã€refresh_token ä¸ºç”¨æˆ·æˆæƒç¬¬ä¸‰æ–¹åº”ç”¨çš„é•¿æ•ˆå‡­è¯ï¼Œä»…ç”¨äºåˆ·æ–°access_tokenï¼Œä½†æ³„æ¼åç›¸å½“äºaccess_token æ³„æ¼ï¼Œé£é™©åŒä¸Šã€‚ å»ºè®®å°†secretã€ç”¨æˆ·æ•°æ®ï¼ˆå¦‚access_tokenï¼‰æ”¾åœ¨Appäº‘ç«¯æœåŠ¡å™¨ï¼Œç”±äº‘ç«¯ä¸­è½¬æ¥å£è°ƒç”¨è¯·æ±‚ã€‚</p>
<h3 id="æœ€åæ€»ç»“ä¸‹è¯¦ç»†çš„æ­¥éª¤">æœ€åæ€»ç»“ä¸‹è¯¦ç»†çš„æ­¥éª¤ï¼š</h3>
<ul>
<li>1ï¼ç”¨æˆ·å…³æ³¨å¾®ä¿¡å…¬ä¼—è´¦å·ã€‚</li>
<li>2ï¼å¾®ä¿¡å…¬ä¼—è´¦å·æä¾›ç”¨æˆ·è¯·æ±‚æˆæƒé¡µé¢URLã€‚</li>
<li>3ï¼ç”¨æˆ·ç‚¹å‡»æˆæƒé¡µé¢URLï¼Œå°†å‘æœåŠ¡å™¨å‘èµ·è¯·æ±‚</li>
<li>4ï¼æœåŠ¡å™¨è¯¢é—®ç”¨æˆ·æ˜¯å¦åŒæ„æˆæƒç»™å¾®ä¿¡å…¬ä¼—è´¦å·(scopeä¸ºsnsapi_baseæ—¶æ— æ­¤æ­¥éª¤)</li>
<li>5ï¼ç”¨æˆ·åŒæ„(scopeä¸ºsnsapi_baseæ—¶æ— æ­¤æ­¥éª¤)</li>
<li>6ï¼æœåŠ¡å™¨å°†CODEé€šè¿‡å›è°ƒä¼ ç»™å¾®ä¿¡å…¬ä¼—è´¦å·</li>
<li>7ï¼å¾®ä¿¡å…¬ä¼—è´¦å·è·å¾—CODE</li>
<li>8ï¼å¾®ä¿¡å…¬ä¼—è´¦å·é€šè¿‡CODEå‘æœåŠ¡å™¨è¯·æ±‚Access Token</li>
<li>9ï¼æœåŠ¡å™¨è¿”å›Access Tokenå’ŒOpenIDç»™å¾®ä¿¡å…¬ä¼—è´¦å·</li>
<li>10ï¼å¾®ä¿¡å…¬ä¼—è´¦å·é€šè¿‡Access Tokenå‘æœåŠ¡å™¨è¯·æ±‚ç”¨æˆ·ä¿¡æ¯(scopeä¸ºsnsapi_baseæ—¶æ— æ­¤æ­¥éª¤)</li>
<li>11ï¼æœåŠ¡å™¨å°†ç”¨æˆ·ä¿¡æ¯å›é€ç»™å¾®ä¿¡å…¬ä¼—è´¦å·(scopeä¸ºsnsapi_baseæ—¶æ— æ­¤æ­¥éª¤)</li>
</ul>
<p>å…¬ä¼—å·é“¾æ¥(å®˜ç½‘æ›´æƒå¨)ï¼š<br>
https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html</p>
<p>https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[å¦‚ä½•æ¯”è¾ƒ React Hooks ä¸Šçš„æ—§å€¼å’Œæ–°å€¼ï¼Ÿ]]></title>
        <id>https://weidadeda.github.io/post/ru-he-bi-jiao-react-hooks-shang-de-jiu-zhi-he-xin-zhi</id>
        <link href="https://weidadeda.github.io/post/ru-he-bi-jiao-react-hooks-shang-de-jiu-zhi-he-xin-zhi">
        </link>
        <updated>2022-01-27T12:24:38.000Z</updated>
        <content type="html"><![CDATA[<h3 id="è‡ªå®šä¹‰hooks">è‡ªå®šä¹‰hooks</h3>
<pre><code class="language-js">function usePrevious(value) {
  const ref = useRef();
  useEffect(() =&gt; {
    ref.current = value;
  });
  return ref.current;
}
</code></pre>
<h3 id="ä½¿ç”¨">ä½¿ç”¨</h3>
<pre><code class="language-js">const Component = (props) =&gt; {
    const {valueA, valueB} = props
    
    const prevValue = usePrevious({valueA, valueB});
    useEffect(() =&gt; {
        if(prevValue.valueA !== valueA) {
           ...
       }
        if(prevValue.valueB !== valueB) {
           ...
        }
    }, [valueA, valueB])
}
</code></pre>
]]></content>
    </entry>
</feed>